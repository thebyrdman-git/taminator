---
# Dynamic RFE Automation Tool - Auto-Discovery of Customers
- name: Generate RFE Reports using Dynamic Customer Discovery
  hosts: all_customers
  gather_facts: yes
  become: no

  vars:
    # Override these on command line: -e "report_types=['rfe_bug_tracker']"
    report_types: "{{ report_types | default(['rfe_bug_tracker', 'active_cases']) }}"
    output_dir: "./output"
    logs_dir: "./logs"
    rhcase_path: "rhcase"

  pre_tasks:
    - name: Display dynamic discovery results
      debug:
        msg: |
          ğŸ” Dynamic Customer Discovery Results:
          ğŸ“Š Total Customers Discovered: {{ groups['all_customers'] | length }}
          ğŸ¯ Current Customer: {{ customer_name }} ({{ account_name }})
          ğŸ“‹ Account Number: {{ account_number }}
          ğŸ¢ Vertical: {{ vertical }}
          ğŸ¯ SBR Groups: {{ sbr_groups | join(', ') }}
          ğŸ“Š Total Cases: {{ total_cases }} ({{ active_cases }} active, {{ closed_cases }} closed)
          ğŸ”§ Case Types: {{ case_types | join(', ') }}
      tags: [discovery, info]

    - name: Create customer-specific output directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ output_dir }}/{{ account_name }}"
        - "{{ logs_dir }}/{{ account_name }}"
      tags: [setup]

  tasks:
    - name: Collect cases using smart module
      redhat.rfe_automation.rfe_case_collector:
        account_number: "{{ account_number }}"
        sbr_groups: "{{ priority_components | default(sbr_groups) }}"
        case_types: ["Feature / Enhancement Request", "Defect / Bug", "Account / Customer Service Request", "Configuration Issue"]
        rhcase_path: "{{ rhcase_path }}"
        include_closed: false
        validate_data: true
      register: collected_cases
      tags: [data_collection]

    - name: Display collection results
      debug:
        msg: |
          ğŸ“Š Case Collection Results for {{ customer_name }}:
          âœ… Total Cases Found: {{ collected_cases.total_cases | default('N/A') }}
          âœ… Filtered Cases: {{ collected_cases.filtered_cases | default('N/A') }}
          âœ… Data Quality: {{ (collected_cases.data_quality_score | default(1.0) | float * 100) | round(1) }}%
      tags: [data_collection, info]

    - name: Process case data using smart module
      redhat.rfe_automation.rfe_data_processor:
        cases: "{{ collected_cases.cases }}"
        case_types: ["Feature / Enhancement Request", "Defect / Bug"]
        rfe_keywords: ["[RFE]"]
        bug_keywords: ["[BUG]"]
        external_tracker_patterns: ["issues.redhat.com", "jira.redhat.com"]
        priority_components: "{{ priority_components | default(sbr_groups) }}"
      register: processed_data
      tags: [data_processing]

    - name: Display processing results
      debug:
        msg: |
          ğŸ”„ Data Processing Results for {{ customer_name }}:
          âœ… Active RFEs: {{ processed_data.statistics.active_rfes_count | default('N/A') }}
          âœ… Active Bugs: {{ processed_data.statistics.active_bugs_count | default('N/A') }}
          âœ… Closed Cases: {{ processed_data.statistics.closed_cases_count | default('N/A') }}
          âœ… External Tracker Cases: {{ processed_data.statistics.external_tracker_cases_count | default('N/A') }}
          âœ… All Active Cases: {{ processed_data.statistics.all_active_cases_count | default('N/A') }}
          âœ… Priority Active Cases: {{ processed_data.statistics.priority_active_cases_count | default('N/A') }}
      tags: [data_processing, info]

    - name: Generate RFE/Bug Tracker Report
      redhat.rfe_automation.rfe_report_generator:
        report_type: "rfe_bug_tracker"
        customer_name: "{{ customer_name }}"
        account_name: "{{ account_name }}"
        account_number: "{{ account_number }}"
        active_rfes: "{{ processed_data.active_rfes }}"
        active_bugs: "{{ processed_data.active_bugs }}"
        closed_cases: "{{ processed_data.closed_cases }}"
        data_quality_score: "{{ collected_cases.data_quality_score | default(1.0) }}"
        output_dir: "{{ output_dir }}/{{ account_name }}"
        output_formats: ["markdown", "json"]
        include_timestamp: true
      register: rfe_report
      when: "'rfe_bug_tracker' in report_types"
      tags: [report_generation, rfe_bug_tracker]

    - name: Generate Active Cases Report
      redhat.rfe_automation.rfe_report_generator:
        report_type: "active_cases"
        customer_name: "{{ customer_name }}"
        account_name: "{{ account_name }}"
        account_number: "{{ account_number }}"
        all_active_cases: "{{ processed_data.all_active_cases }}"
        priority_active_cases: "{{ processed_data.priority_active_cases }}"
        output_dir: "{{ output_dir }}/{{ account_name }}"
        output_formats: ["markdown", "json"]
        include_timestamp: true
      register: active_cases_report
      when: "'active_cases' in report_types"
      tags: [report_generation, active_cases]

    - name: Display customer report generation summary
      debug:
        msg: |
          ğŸ“‹ Report Generation Complete for {{ customer_name }}!
          ğŸ“ Output Directory: {{ output_dir }}/{{ account_name }}
          ğŸ¯ Components: {{ priority_components | default(sbr_groups) | join(', ') }}
          {% if rfe_report is defined and rfe_report.report_files is defined %}
          ğŸ“„ RFE/Bug Report: {{ rfe_report.report_files | length }} files generated
          {% endif %}
          {% if active_cases_report is defined and active_cases_report.report_files is defined %}
          ğŸ“„ Active Cases Report: {{ active_cases_report.report_files | length }} files generated
          {% endif %}
      tags: [summary]

  post_tasks:
    - name: Display dynamic discovery summary
      debug:
        msg: |
          ğŸ‰ Dynamic RFE Automation Complete!
          ğŸ“Š Total Customers Processed: {{ groups['all_customers'] | length }}
          ğŸ“ Reports Directory: {{ output_dir }}
          ğŸ¯ Report Types: {{ report_types | join(', ') }}
          ğŸš€ Using: Dynamic Customer Discovery + Smart Custom Modules
      run_once: true
      tags: [summary, final]

    - name: Generate discovery summary report
      template:
        src: discovery_summary.j2
        dest: "{{ output_dir }}/discovery_summary.md"
        mode: '0644'
      run_once: true
      tags: [summary, discovery]
