---
# RFE Automation Tool - Using Account Vars File
- name: Generate RFE Reports using Account Configuration
  hosts: localhost
  gather_facts: yes
  become: no

  vars_files:
    - vars/accounts.yml

  vars:
    # Override these on command line: -e "customer=jpmc"
    customer: "{{ customer | default('jpmc') }}"

  pre_tasks:
    - name: Validate customer account exists
      assert:
        that:
          - customer in accounts
        fail_msg: "Customer '{{ customer }}' not found in accounts.yml. Available customers: {{ accounts.keys() | list }}"
      tags: [validation]

    - name: Set customer-specific variables
      set_fact:
        customer_config: "{{ accounts[customer] }}"
        customer_name: "{{ accounts[customer].customer_name }}"
        account_name: "{{ accounts[customer].account_name }}"
        account_number: "{{ accounts[customer].account_number }}"
        priority_components: "{{ accounts[customer].priority_components }}"
        rhcase_path: "{{ defaults.rhcase_path }}"
        output_dir: "{{ defaults.output_dir }}"
        logs_dir: "{{ defaults.logs_dir }}"
        validation_threshold: "{{ defaults.validation_threshold }}"
        data_quality_threshold: "{{ defaults.data_quality_threshold }}"
        report_types: "{{ defaults.report_types }}"
        notifications_enabled: "{{ notifications.enabled }}"
        portal_posting_enabled: "{{ portal.enabled }}"
      tags: [setup]

    - name: Display customer configuration
      debug:
        msg: |
          ğŸ¯ Customer Configuration:
          ğŸ“‹ Customer: {{ customer_name }}
          ğŸ¢ Account: {{ account_name }} ({{ account_number }})
          ğŸ¯ Components: {{ priority_components | join(', ') }}
          ğŸ“Š Reports: {{ report_types | join(', ') }}
          âœ… Validation: {{ (validation_threshold | float * 100) | round(1) }}%
      tags: [setup, info]

  roles:
    - role: ansible_collections/redhat/rfe_automation/roles/rfe_bug_tracker
      when: "'rfe_bug_tracker' in report_types"
      tags: [rfe_bug_tracker]

    - role: ansible_collections/redhat/rfe_automation/roles/active_cases
      when: "'active_cases' in report_types"
      tags: [active_cases]

  post_tasks:
    - name: Display completion summary
      debug:
        msg: |
          âœ… RFE Automation Complete!
          ğŸ“ Reports: {{ output_dir }}
          ğŸ“‹ Customer: {{ customer_name }}
          ğŸ¯ Components: {{ priority_components | join(', ') }}
          ğŸ“Š Generated: {{ report_types | join(', ') }}
      tags: [summary]
