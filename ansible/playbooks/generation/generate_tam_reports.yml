---
# TAM Portfolio RFE Automation Tool
# Generates reports for all accounts in TAM's defined portfolio
- name: Generate RFE Reports for TAM Portfolio
  hosts: tam_portfolio
  gather_facts: yes
  become: no
  
  vars:
    # Override these on command line: -e "report_types=['rfe_bug_tracker']"
    report_types: "{{ report_types | default(['rfe_bug_tracker', 'active_cases']) }}"
    output_dir: "./output"
    logs_dir: "./logs"
    rhcase_path: "rhcase"
    
  pre_tasks:
    - name: Display TAM portfolio information
      debug:
        msg: |
          ğŸ¯ TAM Portfolio Information:
          ğŸ‘¤ TAM: {{ tam_name }}
          ğŸ“§ Email: {{ tam_email }}
          ğŸ“Š Total Accounts: {{ groups['tam_portfolio'] | length }}
          ğŸ” Validation Mode: {{ validation_results }}
      run_once: true
      tags: [portfolio, info]
      
    - name: Display account validation results
      debug:
        msg: |
          ğŸ“‹ Account Validation Results:
          âœ… Accounts with Cases: {{ validation_results.accounts_with_cases }}
          âš ï¸  Accounts without Cases: {{ validation_results.accounts_without_cases }}
          ğŸ“Š Total Cases Found: {{ validation_results.total_cases_found }}
      run_once: true
      tags: [portfolio, validation]
      
    - name: Display portfolio suggestions
      debug:
        msg: |
          ğŸ’¡ Portfolio Suggestions:
          â• Suggested Additions: {{ suggestions.add_accounts | length }}
          {% if suggestions.add_accounts | length > 0 %}
          {% for suggestion in suggestions.add_accounts[:3] %}
          - {{ suggestion.customer_name }} ({{ suggestion.account_number }}): {{ suggestion.reason }}
          {% endfor %}
          {% if suggestions.add_accounts | length > 3 %}
          ... and {{ suggestions.add_accounts | length - 3 }} more
          {% endif %}
          {% endif %}
      run_once: true
      when: suggestions is defined
      tags: [portfolio, suggestions]
      
    - name: Display current account information
      debug:
        msg: |
          ğŸ¢ Account: {{ customer_name }} ({{ account_name }})
          ğŸ“‹ Account Number: {{ account_number }}
          ğŸ¯ Products: {{ products | join(', ') }}
          ğŸ¢ Vertical: {{ vertical }}
          ğŸ“Š Cases Found: {{ cases_found }} ({{ active_cases }} active)
          âœ… Validated: {{ validated }}
          ğŸ¯ Priority: {{ priority }}
          ğŸ“ Description: {{ description }}
      tags: [account, info]
      
    - name: Create account-specific output directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ output_dir }}/{{ account_name }}"
        - "{{ logs_dir }}/{{ account_name }}"
      tags: [setup]
      
  tasks:
    - name: Collect cases using smart module
      redhat.rfe_automation.rfe_case_collector:
        account_number: "{{ account_number }}"
        sbr_groups: "{{ priority_components | default(products) }}"
        case_types: ["Feature / Enhancement Request", "Defect / Bug", "Account / Customer Service Request", "Configuration Issue"]
        rhcase_path: "{{ rhcase_path }}"
        include_closed: false
        validate_data: true
      register: collected_cases
      tags: [data_collection]
      
    - name: Display collection results
      debug:
        msg: |
          ğŸ“Š Case Collection Results for {{ customer_name }}:
          âœ… Total Cases Found: {{ collected_cases.total_cases | default('N/A') }}
          âœ… Filtered Cases: {{ collected_cases.filtered_cases | default('N/A') }}
          âœ… Data Quality: {{ (collected_cases.data_quality_score | default(1.0) | float * 100) | round(1) }}%
      tags: [data_collection, info]
      
    - name: Process case data using smart module
      redhat.rfe_automation.rfe_data_processor:
        cases: "{{ collected_cases.cases }}"
        case_types: ["Feature / Enhancement Request", "Defect / Bug"]
        rfe_keywords: ["[RFE]"]
        bug_keywords: ["[BUG]"]
        external_tracker_patterns: ["issues.redhat.com", "jira.redhat.com"]
        priority_components: "{{ priority_components | default(products) }}"
      register: processed_data
      tags: [data_processing]
      
    - name: Display processing results
      debug:
        msg: |
          ğŸ”„ Data Processing Results for {{ customer_name }}:
          âœ… Active RFEs: {{ processed_data.statistics.active_rfes_count | default('N/A') }}
          âœ… Active Bugs: {{ processed_data.statistics.active_bugs_count | default('N/A') }}
          âœ… Closed Cases: {{ processed_data.statistics.closed_cases_count | default('N/A') }}
          âœ… External Tracker Cases: {{ processed_data.statistics.external_tracker_cases_count | default('N/A') }}
          âœ… All Active Cases: {{ processed_data.statistics.all_active_cases_count | default('N/A') }}
          âœ… Priority Active Cases: {{ processed_data.statistics.priority_active_cases_count | default('N/A') }}
      tags: [data_processing, info]
      
    - name: Generate RFE/Bug Tracker Report
      redhat.rfe_automation.rfe_report_generator:
        report_type: "rfe_bug_tracker"
        customer_name: "{{ customer_name }}"
        account_name: "{{ account_name }}"
        account_number: "{{ account_number }}"
        active_rfes: "{{ processed_data.active_rfes }}"
        active_bugs: "{{ processed_data.active_bugs }}"
        closed_cases: "{{ processed_data.closed_cases }}"
        data_quality_score: "{{ collected_cases.data_quality_score | default(1.0) }}"
        output_dir: "{{ output_dir }}/{{ account_name }}"
        output_formats: ["markdown", "json"]
        include_timestamp: true
      register: rfe_report
      when: "'rfe_bug_tracker' in report_types"
      tags: [report_generation, rfe_bug_tracker]
      
    - name: Generate Active Cases Report
      redhat.rfe_automation.rfe_report_generator:
        report_type: "active_cases"
        customer_name: "{{ customer_name }}"
        account_name: "{{ account_name }}"
        account_number: "{{ account_number }}"
        all_active_cases: "{{ processed_data.all_active_cases }}"
        priority_active_cases: "{{ processed_data.priority_active_cases }}"
        output_dir: "{{ output_dir }}/{{ account_name }}"
        output_formats: ["markdown", "json"]
        include_timestamp: true
      register: active_cases_report
      when: "'active_cases' in report_types"
      tags: [report_generation, active_cases]
      
    - name: Display account report generation summary
      debug:
        msg: |
          ğŸ“‹ Report Generation Complete for {{ customer_name }}!
          ğŸ“ Output Directory: {{ output_dir }}/{{ account_name }}
          ğŸ¯ Products: {{ products | join(', ') }}
          {% if rfe_report is defined and rfe_report.report_files is defined %}
          ğŸ“„ RFE/Bug Report: {{ rfe_report.report_files | length }} files generated
          {% endif %}
          {% if active_cases_report is defined and active_cases_report.report_files is defined %}
          ğŸ“„ Active Cases Report: {{ active_cases_report.report_files | length }} files generated
          {% endif %}
      tags: [summary]
      
  post_tasks:
    - name: Display TAM portfolio summary
      debug:
        msg: |
          ğŸ‰ TAM Portfolio RFE Automation Complete!
          ğŸ‘¤ TAM: {{ tam_name }}
          ğŸ“Š Total Accounts Processed: {{ groups['tam_portfolio'] | length }}
          ğŸ“ Reports Directory: {{ output_dir }}
          ğŸ¯ Report Types: {{ report_types | join(', ') }}
          ğŸš€ Using: TAM Portfolio Configuration + Smart Custom Modules
      run_once: true
      tags: [summary, final]
      
    - name: Generate TAM portfolio summary report
      template:
        src: tam_portfolio_summary.j2
        dest: "{{ output_dir }}/tam_portfolio_summary.md"
        mode: '0644'
      run_once: true
      tags: [summary, portfolio]
