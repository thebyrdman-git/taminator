---
# Enhanced TAM Portfolio RFE Automation Tool
# Handles real-world complexity: multi-TAM accounts, product specialization,
# coverage models, backup relationships, and account weights
- name: Generate RFE Reports for Enhanced TAM Portfolio
  hosts: enhanced_tam_portfolio
  gather_facts: yes
  become: no

  vars:
    # Override these on command line: -e "report_types=['rfe_bug_tracker']"
    report_types: "{{ report_types | default(['rfe_bug_tracker', 'active_cases']) }}"
    output_dir: "./output"
    logs_dir: "./logs"
    rhcase_path: "rhcase"

  pre_tasks:
    - name: Display enhanced TAM portfolio information
      debug:
        msg: |
          ğŸ¯ Enhanced TAM Portfolio Information:
          ğŸ‘¤ TAM: {{ tam_name }} ({{ tam_type }})
          ğŸ“§ Email: {{ tam_email }}
          ğŸŒ Region: {{ region }}
          ğŸ¢ Vertical: {{ vertical }}
          ğŸ”„ Backup TAM: {{ backup_tam }}
          ğŸ“Š Total Accounts: {{ groups['enhanced_tam_portfolio'] | length }}
          ğŸ” Validation Results: {{ validation_results }}
      run_once: true
      tags: [portfolio, info]

    - name: Display multi-TAM coordination information
      debug:
        msg: |
          ğŸ¤ Multi-TAM Coordination:
          ğŸ“‹ Shared Accounts: {{ coordination.shared_accounts | length }}
          ğŸ”„ Backup Coverage: {{ backup_coverage.primary_backup }}
          ğŸ“Š Account Prioritization: {{ prioritization }}
      run_once: true
      when: coordination is defined
      tags: [portfolio, coordination]

    - name: Display enhanced portfolio suggestions
      debug:
        msg: |
          ğŸ’¡ Enhanced Portfolio Suggestions:
          â• Suggested Additions: {{ suggestions.add_accounts | length }}
          ğŸ¤ Coordination Opportunities: {{ suggestions.coordination_opportunities | length }}
          ğŸ”„ Backup Coverage Gaps: {{ suggestions.backup_coverage_gaps | length }}
          ğŸ“Š Prioritization Suggestions: {{ suggestions.prioritization_suggestions | length }}
      run_once: true
      when: suggestions is defined
      tags: [portfolio, suggestions]

    - name: Display current account information
      debug:
        msg: |
          ğŸ¢ Account: {{ customer_name }} ({{ account_name }})
          ğŸ“‹ Account Number: {{ account_number }}
          ğŸ¯ Products: {{ products | join(', ') }}
          ğŸ‘¤ TAM Role: {{ tam_role }}
          âš–ï¸  Account Weight: {{ account_weight }}
          ğŸ¤ Coverage Model: {{ coverage_model }}
          ğŸ”„ Backup TAM: {{ backup_tam }}
          ğŸ‘¥ Account Exec: {{ account_exec }}
          ğŸ“Š Cases Found: {{ cases_found }} ({{ active_cases }} active)
          âœ… Validated: {{ validated }}
          ğŸ“ Notes: {{ notes }}
      tags: [account, info]

    - name: Create account-specific output directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ output_dir }}/{{ customer_name | replace(' ', '_') }}/{{ account_number }}"
        - "{{ logs_dir }}/{{ customer_name | replace(' ', '_') }}/{{ account_number }}"
      tags: [setup]

  tasks:
    - name: Collect cases using smart module
      redhat.rfe_automation.rfe_case_collector:
        account_number: "{{ account_number }}"
        sbr_groups: "{{ priority_components | default(products) }}"
        case_types: ["Feature / Enhancement Request", "Defect / Bug", "Account / Customer Service Request", "Configuration Issue"]
        rhcase_path: "{{ rhcase_path }}"
        include_closed: false
        validate_data: true
      register: collected_cases
      tags: [data_collection]

    - name: Display collection results
      debug:
        msg: |
          ğŸ“Š Case Collection Results for {{ customer_name }} ({{ account_number }}):
          âœ… Total Cases Found: {{ collected_cases.total_cases | default('N/A') }}
          âœ… Filtered Cases: {{ collected_cases.filtered_cases | default('N/A') }}
          âœ… Data Quality: {{ (collected_cases.data_quality_score | default(1.0) | float * 100) | round(1) }}%
          ğŸ¯ Products: {{ products | join(', ') }}
          âš–ï¸  Account Weight: {{ account_weight }}
      tags: [data_collection, info]

    - name: Process case data using smart module
      redhat.rfe_automation.rfe_data_processor:
        cases: "{{ collected_cases.cases }}"
        case_types: ["Feature / Enhancement Request", "Defect / Bug"]
        rfe_keywords: ["[RFE]"]
        bug_keywords: ["[BUG]"]
        external_tracker_patterns: ["issues.redhat.com", "jira.redhat.com"]
        priority_components: "{{ priority_components | default(products) }}"
      register: processed_data
      tags: [data_processing]

    - name: Display processing results
      debug:
        msg: |
          ğŸ”„ Data Processing Results for {{ customer_name }} ({{ account_number }}):
          âœ… Active RFEs: {{ processed_data.statistics.active_rfes_count | default('N/A') }}
          âœ… Active Bugs: {{ processed_data.statistics.active_bugs_count | default('N/A') }}
          âœ… Closed Cases: {{ processed_data.statistics.closed_cases_count | default('N/A') }}
          âœ… External Tracker Cases: {{ processed_data.statistics.external_tracker_cases_count | default('N/A') }}
          âœ… All Active Cases: {{ processed_data.statistics.all_active_cases_count | default('N/A') }}
          âœ… Priority Active Cases: {{ processed_data.statistics.priority_active_cases_count | default('N/A') }}
          ğŸ¤ Coverage Model: {{ coverage_model }}
          ğŸ‘¤ TAM Role: {{ tam_role }}
      tags: [data_processing, info]

    - name: Generate RFE/Bug Tracker Report
      redhat.rfe_automation.rfe_report_generator:
        report_type: "rfe_bug_tracker"
        customer_name: "{{ customer_name }}"
        account_name: "{{ account_name }}"
        account_number: "{{ account_number }}"
        active_rfes: "{{ processed_data.active_rfes }}"
        active_bugs: "{{ processed_data.active_bugs }}"
        closed_cases: "{{ processed_data.closed_cases }}"
        data_quality_score: "{{ collected_cases.data_quality_score | default(1.0) }}"
        output_dir: "{{ output_dir }}/{{ customer_name | replace(' ', '_') }}/{{ account_number }}"
        output_formats: ["markdown", "json"]
        include_timestamp: true
      register: rfe_report
      when: "'rfe_bug_tracker' in report_types"
      tags: [report_generation, rfe_bug_tracker]

    - name: Generate Active Cases Report
      redhat.rfe_automation.rfe_report_generator:
        report_type: "active_cases"
        customer_name: "{{ customer_name }}"
        account_name: "{{ account_name }}"
        account_number: "{{ account_number }}"
        all_active_cases: "{{ processed_data.all_active_cases }}"
        priority_active_cases: "{{ processed_data.priority_active_cases }}"
        output_dir: "{{ output_dir }}/{{ customer_name | replace(' ', '_') }}/{{ account_number }}"
        output_formats: ["markdown", "json"]
        include_timestamp: true
      register: active_cases_report
      when: "'active_cases' in report_types"
      tags: [report_generation, active_cases]

    - name: Display account report generation summary
      debug:
        msg: |
          ğŸ“‹ Enhanced Report Generation Complete for {{ customer_name }} ({{ account_number }})!
          ğŸ“ Output Directory: {{ output_dir }}/{{ customer_name | replace(' ', '_') }}/{{ account_number }}
          ğŸ¯ Products: {{ products | join(', ') }}
          âš–ï¸  Account Weight: {{ account_weight }}
          ğŸ¤ Coverage Model: {{ coverage_model }}
          ğŸ‘¤ TAM Role: {{ tam_role }}
          {% if rfe_report is defined and rfe_report.report_files is defined %}
          ğŸ“„ RFE/Bug Report: {{ rfe_report.report_files | length }} files generated
          {% endif %}
          {% if active_cases_report is defined and active_cases_report.report_files is defined %}
          ğŸ“„ Active Cases Report: {{ active_cases_report.report_files | length }} files generated
          {% endif %}
      tags: [summary]

  post_tasks:
    - name: Display enhanced TAM portfolio summary
      debug:
        msg: |
          ğŸ‰ Enhanced TAM Portfolio RFE Automation Complete!
          ğŸ‘¤ TAM: {{ tam_name }} ({{ tam_type }})
          ğŸŒ Region: {{ region }} | ğŸ¢ Vertical: {{ vertical }}
          ğŸ“Š Total Accounts Processed: {{ groups['enhanced_tam_portfolio'] | length }}
          ğŸ¤ Shared Accounts: {{ coordination.shared_accounts | length if coordination else 0 }}
          ğŸ”„ Backup TAM: {{ backup_tam }}
          ğŸ“ Reports Directory: {{ output_dir }}
          ğŸ¯ Report Types: {{ report_types | join(', ') }}
          ğŸš€ Using: Enhanced TAM Portfolio + Smart Custom Modules
      run_once: true
      tags: [summary, final]

    - name: Generate enhanced TAM portfolio summary report
      template:
        src: enhanced_tam_portfolio_summary.j2
        dest: "{{ output_dir }}/enhanced_tam_portfolio_summary.md"
        mode: '0644'
      run_once: true
      tags: [summary, portfolio]
