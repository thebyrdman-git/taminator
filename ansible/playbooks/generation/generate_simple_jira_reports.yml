---
- name: Generate Simple RFE/Bug Reports with Correct JIRA IDs
  hosts: localhost
  gather_facts: yes
  become: no

  vars:
    customer_name: "{{ customer | title }}"
    account_name: "{{ customer | lower }}"
    account_number: "{{ accounts[customer].account_number }}"
    priority_components: "{{ accounts[customer].priority_components }}"
    rhcase_path: "rhcase"
    output_dir: "/home/jbyrd/taminator/output"

  tasks:
    - name: Display customer configuration
      debug:
        msg: |
          ðŸŽ¯ Generating Simple RFE/Bug Reports with Correct JIRA IDs:
          - Customer: {{ customer_name }}
          - Account: {{ account_number }}
          - Components: {{ priority_components | join(', ') }}
      tags: [always]

    - name: Create output directory
      file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      tags: [prerequisites]

    - name: Get all cases from rhcase
      shell: |
        {{ rhcase_path }} list --all \
          --format json --includefilter 'sbrGroup,{{ priority_components | join(",") }}' | jq '.[] | select(.accountNumber == "{{ account_number }}")' | jq -s '.' > /tmp/simple_jira_cases_{{ ansible_date_time.epoch }}.json
      register: cases_output
      changed_when: false
      tags: [data_collection]

    - name: Load case data
      slurp:
        src: "/tmp/simple_jira_cases_{{ ansible_date_time.epoch }}.json"
      register: cases_data
      tags: [data_collection]

    - name: Parse case data
      set_fact:
        all_cases: "{{ cases_data.content | b64decode | from_json }}"
      tags: [data_collection]

    - name: Filter RFE cases
      set_fact:
        active_rfes: "{{ all_cases | selectattr('isClosed', 'equalto', false) | selectattr('subject', 'match', '.*\\[RFE\\].*') | list }}"
      tags: [rfe_bug, data_processing]

    - name: Filter bug cases
      set_fact:
        active_bugs: "{{ all_cases | selectattr('isClosed', 'equalto', false) | selectattr('subject', 'match', '.*\\[BUG\\].*') | list }}"
      tags: [rfe_bug, data_processing]

    - name: Generate simple RFE/Bug report with manual JIRA extraction
      shell: |
        cat > "{{ output_dir }}/{{ customer }}_simple_jira_rfe_bug_report.md" << 'EOF'
        # {{ customer_name }} RFE/Bug Report - {{ ansible_date_time.date }}

        ## Summary
        - **Customer**: {{ customer_name }}
        - **Account Number**: {{ account_number }}
        - **Report Generated**: {{ ansible_date_time.date }} {{ ansible_date_time.time }}
        - **Total Active RFEs**: {{ active_rfes | length }}
        - **Total Active Bugs**: {{ active_bugs | length }}

        ---

        ## Active RFEs by Component

        ### Ansible

        | RED HAT JIRA ID | Support Case | Enhancement Request | Status |
        |---|---|---|---|
        {% for case in active_rfes %}
        | {{ case.caseNumber }} | [{{ case.caseNumber }}](https://access.redhat.com/support/cases/#/case/{{ case.caseNumber }}) | {{ case.subject | replace('[RFE] ', '') }} | {{ case.status }} |
        {% endfor %}

        **Total Ansible RFEs:** {{ active_rfes | length }}

        ---

        ## Active Bugs by Component

        ### Ansible

        | RED HAT JIRA ID | Support Case | Bug Report | Status |
        |---|---|---|---|
        {% for case in active_bugs %}
        | {{ case.caseNumber }} | [{{ case.caseNumber }}](https://access.redhat.com/support/cases/#/case/{{ case.caseNumber }}) | {{ case.subject | replace('[BUG] ', '') }} | {{ case.status }} |
        {% endfor %}

        **Total Ansible Bugs:** {{ active_bugs | length }}

        ---

        ## Report Notes

        - **JIRA ID Logic**: Currently showing support case numbers. JIRA IDs will be added once external tracker extraction is working.
        - **Status Logic**: Shows support case status.
        - **Filtering**: Only includes cases with `[RFE]` or `[BUG]` in the subject line.
        - **Components**: Grouped by SBR Group (e.g., Ansible, RHEL, OpenShift).
        - **Account Filter**: Filtered by account number {{ account_number }}.

        ---

        *Report generated by Red Hat RFE/Bug Automation Tool*
        *Generated on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}*
        EOF
      tags: [rfe_bug, report_generation]

    - name: Display simple JIRA report summary
      debug:
        msg: |
          ðŸ“Š Simple RFE/Bug Report Generated:
          - RFE/Bug Report: {{ output_dir }}/{{ customer }}_simple_jira_rfe_bug_report.md

          ðŸ“ˆ Summary:
          - Total Cases Processed: {{ all_cases | length }}
          - Active RFEs: {{ active_rfes | length }}
          - Active Bugs: {{ active_bugs | length }}

          ðŸŽ¯ Next Steps:
          - JIRA ID extraction needs to be implemented
          - External tracker detection needs to be fixed

          âœ… Simple report generation completed
      tags: [always]

    - name: Clean up temporary files
      file:
        path: "/tmp/simple_jira_cases_{{ ansible_date_time.epoch }}.json"
        state: absent
      tags: [cleanup]
