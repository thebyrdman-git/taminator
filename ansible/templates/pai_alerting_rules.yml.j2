# PAI Infrastructure Alerting Rules
# Generated by Ansible - DO NOT EDIT MANUALLY
# Template: pai_alerting_rules.yml.j2

groups:
  - name: pai_infrastructure_alerts
    rules:
      # System Resource Alerts
      - alert: HighCPUUsage
        expr: 100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU usage detected on {{ "{{ $labels.instance }}" }}"
          description: "CPU usage is {{ "{{ $value }}" }}% on {{ "{{ $labels.instance }}" }}"

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High memory usage detected on {{ "{{ $labels.instance }}" }}"
          description: "Memory usage is {{ "{{ $value }}" }}% on {{ "{{ $labels.instance }}" }}"

      - alert: DiskSpaceUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 90
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Disk space usage critical on {{ "{{ $labels.instance }}" }}"
          description: "Disk usage is {{ "{{ $value }}" }}% on filesystem {{ "{{ $labels.mountpoint }}" }} of {{ "{{ $labels.instance }}" }}"

      # Tmpfs Alerts (for /tmp and other RAM-based filesystems)
      - alert: HighTmpfsUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype="tmpfs"} / node_filesystem_size_bytes{fstype="tmpfs"})) * 100 > 80
        for: 3m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High tmpfs usage on {{ "{{ $labels.instance }}" }}"
          description: "Tmpfs usage is {{ "{{ $value }}" }}% on {{ "{{ $labels.mountpoint }}" }} of {{ "{{ $labels.instance }}" }}"

      - alert: CriticalTmpfsUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype="tmpfs"} / node_filesystem_size_bytes{fstype="tmpfs"})) * 100 > 90
        for: 1m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "CRITICAL: Tmpfs usage on {{ "{{ $labels.instance }}" }}"
          description: "Tmpfs usage is {{ "{{ $value }}" }}% on {{ "{{ $labels.mountpoint }}" }} of {{ "{{ $labels.instance }}" }}. Emergency cleanup required."

      # Service Health Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 3m
        labels:
          severity: critical
          service: "{{ "{{ $labels.job }}" }}"
        annotations:
          summary: "Service {{ "{{ $labels.job }}" }} is down"
          description: "Service {{ "{{ $labels.job }}" }} on {{ "{{ $labels.instance }}" }} has been down for more than 3 minutes"

      # PAI-Specific Alerts
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          service: monitoring
        annotations:
          summary: "Prometheus server is down"
          description: "Prometheus monitoring system is not responding"

      - alert: GrafanaDown
        expr: up{job="grafana"} == 0
        for: 3m
        labels:
          severity: warning
          service: monitoring
        annotations:
          summary: "Grafana dashboard is down"
          description: "Grafana visualization server is not responding"

      - alert: NodeExporterDown
        expr: up{job=~"node-exporter-.*"} == 0
        for: 3m
        labels:
          severity: warning
          service: monitoring
        annotations:
          summary: "Node Exporter is down on {{ "{{ $labels.instance }}" }}"
          description: "System metrics collection is not working on {{ "{{ $labels.instance }}" }}"

      - alert: JimmyYouTubeSystemDown
        expr: up{job="jimmy-youtube"} == 0
        for: 5m
        labels:
          severity: warning
          service: youtube-automation
        annotations:
          summary: "Jimmy's YouTube system is not responding"
          description: "YouTube download automation system has been down for more than 5 minutes"

      # Network and Connectivity Alerts  
      - alert: HighNetworkTraffic
        expr: rate(node_network_receive_bytes_total[5m]) > 10000000  # 10MB/s
        for: 5m
        labels:
          severity: info
          service: network
        annotations:
          summary: "High network traffic on {{ "{{ $labels.instance }}" }}"
          description: "Network interface {{ "{{ $labels.device }}" }} receiving {{ "{{ $value | humanizeBytes }}" }}/s"

  # Performance and Optimization Alerts
  - name: pai_performance_alerts
    rules:
      - alert: LoadAverageHigh
        expr: node_load15 > 2
        for: 10m
        labels:
          severity: warning
          service: performance
        annotations:
          summary: "Load average is high on {{ "{{ $labels.instance }}" }}"
          description: "15-minute load average is {{ "{{ $value }}" }} on {{ "{{ $labels.instance }}" }}"

      - alert: TooManyProcesses
        expr: node_processes_threads > 1000
        for: 5m
        labels:
          severity: warning
          service: performance
        annotations:
          summary: "High process count on {{ "{{ $labels.instance }}" }}"
          description: "Process count is {{ "{{ $value }}" }} on {{ "{{ $labels.instance }}" }}"

  # Storage and Media Alerts
  - name: pai_storage_alerts
    rules:
      - alert: MediaStorageFull
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/media"} / node_filesystem_size_bytes{mountpoint="/media"})) * 100 > 95
        for: 2m
        labels:
          severity: critical
          service: storage
        annotations:
          summary: "Media storage critically full"
          description: "Media storage (/media) is {{ "{{ $value }}" }}% full - Jimmy's downloads may fail"
