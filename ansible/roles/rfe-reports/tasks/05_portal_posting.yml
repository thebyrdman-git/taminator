---
# Portal posting tasks (optional)

- name: Check if portal API credentials are configured
  stat:
    path: "{{ project_root }}/.env"
  register: env_file_check
  when: portal_api_enabled
  tags: [portal_posting, credentials_check]

- name: Load portal API credentials
  include_vars:
    file: "{{ project_root }}/.env"
  when:
    - portal_api_enabled
    - env_file_check.stat.exists
  tags: [portal_posting, credentials_load]

- name: Post RFE/Bug report to portal
  uri:
    url: "{{ portal_base_url }}/api/v1/groups/{{ portal_group_id }}/discussions"
    method: POST
    headers:
      Authorization: "Bearer {{ portal_api_token | default('') }}"
      Content-Type: "application/json"
    body_format: json
    body:
      title: "RFE/Bug Tracker Report - {{ customer_name }} - {{ ansible_date_time.date }}"
      body: "{{ lookup('file', output_dir + '/' + customer_name | lower + '_rfe_bug_report_' + ansible_date_time.epoch + '.md') }}"
      category: "rfe-bug-tracker"
      tags:
        - "{{ customer_name | lower }}"
        - "rfe-report"
        - "{{ ansible_date_time.date }}"
  register: portal_post_result
  when:
    - portal_api_enabled
    - portal_api_token is defined
    - portal_api_token != ""
  tags: [portal_posting, post_report]

- name: Log portal posting result
  lineinfile:
    path: "{{ logs_dir }}/portal_posts.log"
    line: "{{ ansible_date_time.iso8601 }} - Posted RFE report for {{ customer_name }} to portal - Status: {{ portal_post_result.status | default('failed') }}"
    create: yes
    mode: '0644'
  when: portal_post_result is defined
  tags: [portal_posting, logging]

- name: Display portal posting status
  debug:
    msg: |
      üì§ Portal Posting Status for {{ customer_name }}:
      - Status Code: {{ portal_post_result.status | default('Not posted - API disabled or credentials missing') }}
      - Discussion ID: {{ portal_post_result.json.discussion_id | default('N/A') }}
      - URL: {{ portal_post_result.json.url | default('N/A') }}
  when: portal_post_result is defined
  tags: [portal_posting, status_display]

- name: Skip portal posting (API disabled)
  debug:
    msg: "‚ÑπÔ∏è  Portal posting skipped - API disabled or credentials not configured"
  when: not portal_api_enabled
  tags: [portal_posting, skipped]
