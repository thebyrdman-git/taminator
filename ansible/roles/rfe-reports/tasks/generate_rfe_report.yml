---
# Generate RFE/Bug tracker report using rhcase and Jinja2 templates

- name: Get RFE cases from rhcase
  shell: |
    {{ rhcase_path }} --account {{ account_name }} \
      --includefilter 'sbrGroup,{{ priority_components | join(",") }}' \
      --format json
  register: rfe_cases_output
  changed_when: false

- name: Parse RFE cases JSON
  set_fact:
    rfe_cases: "{{ rfe_cases_output.stdout | from_json }}"

- name: Filter RFE cases by type
  set_fact:
    active_rfes: "{{ rfe_cases | selectattr('caseType', 'equalto', 'RFE') | selectattr('isClosed', 'equalto', false) | list }}"
    active_bugs: "{{ rfe_cases | selectattr('caseType', 'equalto', 'Bug') | selectattr('isClosed', 'equalto', false) | list }}"
    closed_cases: "{{ rfe_cases | selectattr('isClosed', 'equalto', true) | list }}"

- name: Generate RFE/Bug report using Jinja2 template
  template:
    src: "{{ default_template }}"
    dest: "{{ output_dir }}/{{ customer_name | lower }}_rfe_bug_report_{{ ansible_date_time.epoch }}.md"
  vars:
    customer_name: "{{ customer_name }}"
    account_number: "{{ account_number }}"
    current_date: "{{ ansible_date_time.date }}"
    total_active_cases: "{{ (active_rfes | length) + (active_bugs | length) }}"
    total_closed_cases: "{{ closed_cases | length }}"
    active_rfes: "{{ active_rfes }}"
    active_bugs: "{{ active_bugs }}"
    closed_cases: "{{ closed_cases }}"
    priority_components: "{{ priority_components }}"
    business_units: "{{ business_units }}"
    report_timestamp: "{{ ansible_date_time.iso8601 }}"

- name: Generate JSON version of report
  copy:
    content: |
      {
        "customer_name": "{{ customer_name }}",
        "account_number": "{{ account_number }}",
        "report_date": "{{ ansible_date_time.iso8601 }}",
        "total_active_cases": {{ (active_rfes | length) + (active_bugs | length) }},
        "total_closed_cases": {{ closed_cases | length }},
        "active_rfes": {{ active_rfes | to_json }},
        "active_bugs": {{ active_bugs | to_json }},
        "closed_cases": {{ closed_cases | to_json }},
        "priority_components": {{ priority_components | to_json }},
        "business_units": {{ business_units | to_json }}
      }
    dest: "{{ output_dir }}/{{ customer_name | lower }}_rfe_bug_report_{{ ansible_date_time.epoch }}.json"
    mode: '0644'

- name: Log report generation
  lineinfile:
    path: "{{ logs_dir }}/rfe_reports.log"
    line: "{{ ansible_date_time.iso8601 }} - Generated RFE/Bug report for {{ customer_name }} - {{ (active_rfes | length) + (active_bugs | length) }} active cases, {{ closed_cases | length }} closed cases"
    create: yes
    mode: '0644'
