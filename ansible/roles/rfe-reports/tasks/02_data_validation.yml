---
# Data validation and quality assurance tasks

- name: Validate case data structure
  assert:
    that:
      - rfe_cases is defined
      - rfe_cases | length >= 0
      - rfe_cases is iterable
    fail_msg: "Invalid case data structure - rfe_cases not properly defined"
  tags: [data_validation, structure]

- name: Validate individual case data quality
  assert:
    that:
      - item.caseNumber is defined
      - item.caseNumber | length > 0
      - item.caseType is defined
      - item.caseType | length > 0
      - item.sbrGroup is defined
      - item.isClosed is defined
    fail_msg: "Case {{ item.caseNumber | default('unknown') }} has missing required fields"
  loop: "{{ rfe_cases }}"
  when: rfe_cases | length > 0
  tags: [data_validation, quality]

- name: Detect available case types in data
  set_fact:
    available_case_types: "{{ rfe_cases | map(attribute='caseType') | list | unique }}"
  when: rfe_cases | length > 0
  tags: [data_validation, detection]

- name: Display detected case types
  debug:
    msg: |
      ðŸ“Š Detected Case Types in Data:
      {% for case_type in available_case_types %}
      - {{ case_type }}
      {% endfor %}
  when: rfe_cases | length > 0
  tags: [data_validation, detection]

- name: Validate case type filtering logic
  assert:
    that:
      - "'Feature / Enhancement Request' in available_case_types or 'RFE' in available_case_types"
      - "'Defect / Bug' in available_case_types or 'Bug' in available_case_types"
    fail_msg: |
      Case type filtering logic mismatch detected!
      Available types: {{ available_case_types | join(', ') }}
      Expected: 'Feature / Enhancement Request' or 'RFE', 'Defect / Bug' or 'Bug'
  when: rfe_cases | length > 0
  tags: [data_validation, filtering]

- name: Calculate data quality score
  set_fact:
    data_quality_score: "{{ (rfe_cases | selectattr('caseNumber') | list | length) / (rfe_cases | length) }}"
  when: rfe_cases | length > 0
  tags: [data_validation, quality]

- name: Validate data quality threshold
  assert:
    that:
      - data_quality_score | float >= 0.95
    fail_msg: "Data quality score {{ data_quality_score | float }} is below threshold (0.95)"
  when: rfe_cases | length > 0
  tags: [data_validation, quality]

- name: Validate external tracker detection
  assert:
    that:
      - cases_with_external_trackers is defined
      - cases_with_external_trackers | length >= 0
    fail_msg: "External tracker detection failed - cases_with_external_trackers not properly defined"
  when: rfe_cases | length > 0
  tags: [data_validation, external_tracker]

- name: Display external tracker detection results
  debug:
    msg: |
      ðŸ” External Tracker Detection Results:
      - Cases with external trackers: {{ cases_with_external_trackers | length }}
      {% if cases_with_external_trackers | length > 0 %}
      - External tracker cases:
      {% for case in cases_with_external_trackers %}
      - {{ case.caseNumber }}: {{ case.subject }}
      {% endfor %}
      {% endif %}
  when: rfe_cases | length > 0
  tags: [data_validation, external_tracker]

- name: Log data validation results
  lineinfile:
    path: "{{ logs_dir }}/data_validation.log"
    line: "{{ ansible_date_time.iso8601 }} - {{ customer_name }} - Data Quality: {{ (data_quality_score | float * 100) | round(1) }}% - Case Types: {{ available_case_types | length }} - Total Cases: {{ rfe_cases | length }} - External Trackers: {{ cases_with_external_trackers | default([]) | length }}"
    create: yes
    mode: '0644'
  tags: [data_validation, logging]
