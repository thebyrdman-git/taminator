# Makefile for RFE Automation Tool
# Provides easy commands for development, testing, and deployment

.PHONY: help install test lint clean build deploy

# Default target
help:
	@echo "ðŸš€ RFE Automation Tool - Available Commands:"
	@echo ""
	@echo "ðŸ“¦ Installation & Setup:"
	@echo "  make install          Install dependencies"
	@echo "  make setup            Setup development environment"
	@echo ""
	@echo "ðŸ§ª Testing:"
	@echo "  make test             Run all tests"
	@echo "  make test-molecule    Run Molecule tests"
	@echo "  make test-integration Run integration tests"
	@echo "  make test-smart       Test smart modules"
	@echo ""
	@echo "ðŸ” Code Quality:"
	@echo "  make lint             Run all linting"
	@echo "  make lint-ansible     Run ansible-lint"
	@echo "  make lint-yaml        Run yamllint"
	@echo "  make lint-python      Run Python linting"
	@echo ""
	@echo "ðŸš€ Usage:"
	@echo "  make generate-jpmc    Generate reports for JPMC"
	@echo "  make generate-all     Generate all report types"
	@echo "  make generate-rfe     Generate RFE reports only"
	@echo "  make generate-active  Generate active cases only"
	@echo "  make discover         Discover all customers dynamically"
	@echo "  make generate-dynamic Generate reports for all discovered customers"
	@echo "  make setup-portfolio  Setup TAM portfolio configuration"
	@echo "  make generate-tam     Generate reports for TAM portfolio"
	@echo "  make review-portfolio Review and update TAM portfolio"
	@echo "  make setup-enhanced   Setup enhanced TAM portfolio (real-world complexity)"
	@echo "  make generate-enhanced Generate reports for enhanced TAM portfolio"
	@echo ""
	@echo "ðŸ”§ Development:"
	@echo "  make clean            Clean temporary files"
	@echo "  make build            Build Ansible collection"
	@echo "  make validate         Validate all configurations"
	@echo ""
	@echo "ðŸ“‹ Examples:"
	@echo "  make generate-jpmc    # Generate all reports for JPMC"
	@echo "  make test && make lint # Run tests and linting"

# Installation and setup
install:
	@echo "ðŸ“¦ Installing dependencies..."
	python3 -m pip install --upgrade pip
	pip install ansible ansible-lint yamllint molecule[docker] docker
	@echo "âœ… Dependencies installed"

setup: install
	@echo "ðŸ”§ Setting up development environment..."
	mkdir -p output logs
	chmod +x generate_reports*.sh
	@echo "âœ… Development environment ready"

# Testing commands
test: test-molecule test-integration test-smart
	@echo "âœ… All tests completed"

test-molecule:
	@echo "ðŸ§ª Running Molecule tests..."
	cd tests/molecule/default && molecule test
	@echo "âœ… Molecule tests completed"

test-integration:
	@echo "ðŸ”— Running integration tests..."
	ansible-playbook generate_reports_smart.yml \
		-e "customer=jpmc" \
		-e "report_types=['rfe_bug_tracker']" \
		--check --diff
	@echo "âœ… Integration tests completed"

test-smart:
	@echo "ðŸ§  Testing smart modules..."
	./generate_reports_smart.sh jpmc rfe
	@echo "âœ… Smart module tests completed"

# Linting commands
lint: lint-ansible lint-yaml lint-python
	@echo "âœ… All linting completed"

lint-ansible:
	@echo "ðŸ” Running ansible-lint..."
	ansible-lint .
	@echo "âœ… Ansible linting completed"

lint-yaml:
	@echo "ðŸ” Running yamllint..."
	yamllint .
	@echo "âœ… YAML linting completed"

lint-python:
	@echo "ðŸ” Running Python linting..."
	python3 -m py_compile ansible_collections/redhat/rfe_automation/plugins/modules/*.py
	@echo "âœ… Python linting completed"

# Usage commands
generate-jpmc:
	@echo "ðŸ“Š Generating reports for JPMC..."
	./generate_reports_smart.sh jpmc all
	@echo "âœ… JPMC reports generated"

generate-all:
	@echo "ðŸ“Š Generating all report types..."
	./generate_reports_smart.sh jpmc all
	@echo "âœ… All reports generated"

generate-rfe:
	@echo "ðŸ“Š Generating RFE reports..."
	./generate_reports_smart.sh jpmc rfe
	@echo "âœ… RFE reports generated"

generate-active:
	@echo "ðŸ“Š Generating active cases reports..."
	./generate_reports_smart.sh jpmc active
	@echo "âœ… Active cases reports generated"

# Dynamic inventory commands
discover:
	@echo "ðŸ” Discovering customers dynamically..."
	ansible-inventory -i inventory/rfe_customers.yml --list
	@echo "âœ… Customer discovery completed"

generate-dynamic:
	@echo "ðŸ“Š Generating reports for all discovered customers..."
	./generate_reports_dynamic.sh all
	@echo "âœ… Dynamic reports generated"

generate-dynamic-rfe:
	@echo "ðŸ“Š Generating RFE reports for all discovered customers..."
	./generate_reports_dynamic.sh rfe
	@echo "âœ… Dynamic RFE reports generated"

generate-dynamic-active:
	@echo "ðŸ“Š Generating active cases reports for all discovered customers..."
	./generate_reports_dynamic.sh active
	@echo "âœ… Dynamic active cases reports generated"

# TAM Portfolio commands
setup-portfolio:
	@echo "ðŸŽ¯ Setting up TAM portfolio configuration..."
	./setup-tam-portfolio.sh
	@echo "âœ… TAM portfolio setup completed"

generate-tam:
	@echo "ðŸ“Š Generating reports for TAM portfolio..."
	ansible-playbook generate_tam_reports.yml -i inventory/tam-portfolio.yml
	@echo "âœ… TAM portfolio reports generated"

generate-tam-rfe:
	@echo "ðŸ“Š Generating RFE reports for TAM portfolio..."
	ansible-playbook generate_tam_reports.yml -i inventory/tam-portfolio.yml -e "report_types=['rfe_bug_tracker']"
	@echo "âœ… TAM portfolio RFE reports generated"

generate-tam-active:
	@echo "ðŸ“Š Generating active cases reports for TAM portfolio..."
	ansible-playbook generate_tam_reports.yml -i inventory/tam-portfolio.yml -e "report_types=['active_cases']"
	@echo "âœ… TAM portfolio active cases reports generated"

review-portfolio:
	@echo "ðŸ” Reviewing TAM portfolio..."
	ansible-inventory -i inventory/tam-portfolio.yml --list | jq '.suggestions.add_accounts[]?' 2>/dev/null || echo "No suggestions available"
	@echo "âœ… Portfolio review completed"

discover-portfolio:
	@echo "ðŸ” Discovering TAM portfolio..."
	ansible-inventory -i inventory/tam-portfolio.yml --list
	@echo "âœ… Portfolio discovery completed"

# Enhanced TAM Portfolio commands
setup-enhanced:
	@echo "ðŸŽ¯ Setting up enhanced TAM portfolio configuration..."
	./setup-enhanced-tam-portfolio.sh
	@echo "âœ… Enhanced TAM portfolio setup completed"

generate-enhanced:
	@echo "ðŸ“Š Generating reports for enhanced TAM portfolio..."
	ansible-playbook generate_enhanced_tam_reports.yml -i inventory/enhanced-tam-portfolio.yml
	@echo "âœ… Enhanced TAM portfolio reports generated"

generate-enhanced-rfe:
	@echo "ðŸ“Š Generating RFE reports for enhanced TAM portfolio..."
	ansible-playbook generate_enhanced_tam_reports.yml -i inventory/enhanced-tam-portfolio.yml -e "report_types=['rfe_bug_tracker']"
	@echo "âœ… Enhanced TAM portfolio RFE reports generated"

generate-enhanced-active:
	@echo "ðŸ“Š Generating active cases reports for enhanced TAM portfolio..."
	ansible-playbook generate_enhanced_tam_reports.yml -i inventory/enhanced-tam-portfolio.yml -e "report_types=['active_cases']"
	@echo "âœ… Enhanced TAM portfolio active cases reports generated"

discover-enhanced-portfolio:
	@echo "ðŸ” Discovering enhanced TAM portfolio..."
	ansible-inventory -i inventory/enhanced-tam-portfolio.yml --list
	@echo "âœ… Enhanced portfolio discovery completed"

# Development commands
clean:
	@echo "ðŸ§¹ Cleaning temporary files..."
	rm -rf output/* logs/* .cache/ .molecule/ __pycache__/ *.pyc
	rm -rf tests/molecule/default/.cache/ tests/molecule/default/.molecule/
	find . -name "*.tmp" -delete
	find . -name ".DS_Store" -delete
	@echo "âœ… Cleanup completed"

build:
	@echo "ðŸ”¨ Building Ansible collection..."
	ansible-galaxy collection build ansible_collections/redhat/rfe_automation/
	@echo "âœ… Collection built"

validate:
	@echo "âœ… Validating configurations..."
	@echo "ðŸ” Validating Ansible syntax..."
	ansible-playbook --syntax-check generate_reports_smart.yml
	ansible-playbook --syntax-check generate_reports_with_vars.yml
	@echo "ðŸ” Validating YAML files..."
	yamllint vars/accounts.yml
	@echo "ðŸ” Validating Python modules..."
	python3 -m py_compile ansible_collections/redhat/rfe_automation/plugins/modules/*.py
	@echo "âœ… All validations passed"

# CI/CD commands
ci: lint test
	@echo "ðŸš€ CI pipeline completed"

ci-full: install lint test build
	@echo "ðŸš€ Full CI pipeline completed"

# Docker commands for testing
docker-test:
	@echo "ðŸ³ Running tests in Docker..."
	docker run --rm -v $(PWD):/workspace -w /workspace \
		quay.io/ansible/molecule:latest \
		bash -c "pip install molecule[docker] && cd tests/molecule/default && molecule test"

# Documentation
docs:
	@echo "ðŸ“š Generating documentation..."
	@echo "âœ… Documentation would be generated here"

# Deployment (placeholder)
deploy:
	@echo "ðŸš€ Deployment would happen here"
	@echo "This would integrate with your deployment system"

# Quick development workflow
dev: clean setup validate
	@echo "ðŸš€ Development environment ready"

# Production readiness check
prod-check: lint test validate
	@echo "âœ… Production readiness check completed"

# Show current status
status:
	@echo "ðŸ“Š RFE Automation Tool Status:"
	@echo "ðŸ“ Working Directory: $(PWD)"
	@echo "ðŸ Python Version: $(shell python3 --version)"
	@echo "ðŸ”§ Ansible Version: $(shell ansible --version | head -1)"
	@echo "ðŸ§ª Molecule Version: $(shell molecule --version 2>/dev/null || echo 'Not installed')"
	@echo "ðŸ“‹ Available Customers:"
	@grep -E "^  [a-zA-Z_]+:" vars/accounts.yml | sed 's/^  /  - /' | sed 's/:$$//' || echo "  No customers configured"
