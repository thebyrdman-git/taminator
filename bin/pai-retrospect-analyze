#!/bin/bash
#
# pai-retrospect-analyze: Analyze retrospections for patterns
#

set -euo pipefail

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

RETRO_DIR="$HOME/pai/retrospectives"

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}Retrospection Pattern Analysis${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Check if retrospections exist
if [ ! -d "$RETRO_DIR" ] || [ -z "$(ls -A "$RETRO_DIR" 2>/dev/null)" ]; then
    echo -e "${YELLOW}⚠️  No retrospections found in $RETRO_DIR${NC}"
    echo ""
    echo "Create your first retrospection:"
    echo "  pai-retrospect --project"
    exit 0
fi

RETRO_COUNT=$(find "$RETRO_DIR" -name "*.md" -type f 2>/dev/null | wc -l)
echo -e "${GREEN}Found $RETRO_COUNT retrospection(s)${NC}"
echo ""

# Common Technical Issues
echo -e "${BLUE}=== Common Technical Issues ===${NC}"
if grep -h "### Technical Issues" "$RETRO_DIR"/*.md -A 10 2>/dev/null | grep -v "^--$" | grep -v "^#" | grep -E "^[A-Za-z]" | sort | uniq -c | sort -rn | head -5 | grep -q .; then
    grep -h "### Technical Issues" "$RETRO_DIR"/*.md -A 10 2>/dev/null | grep -v "^--$" | grep -v "^#" | grep -E "^[A-Za-z]" | sort | uniq -c | sort -rn | head -5
else
    echo "  No patterns found yet"
fi
echo ""

# Tools That Helped Most
echo -e "${BLUE}=== Tools That Helped Most ===${NC}"
if grep -h "### Tools That Helped" "$RETRO_DIR"/*.md -A 10 2>/dev/null | grep -v "^--$" | grep -v "^#" | grep -E "^[A-Za-z]" | sort | uniq -c | sort -rn | head -5 | grep -q .; then
    grep -h "### Tools That Helped" "$RETRO_DIR"/*.md -A 10 2>/dev/null | grep -v "^--$" | grep -v "^#" | grep -E "^[A-Za-z]" | sort | uniq -c | sort -rn | head -5
else
    echo "  No patterns found yet"
fi
echo ""

# Framework Improvements Needed
echo -e "${BLUE}=== Framework Improvements Needed ===${NC}"
if grep -h "Framework update:" "$RETRO_DIR"/*.md 2>/dev/null | sort | uniq -c | sort -rn | grep -q .; then
    grep -h "Framework update:" "$RETRO_DIR"/*.md 2>/dev/null | sort | uniq -c | sort -rn
else
    echo "  No framework updates suggested yet"
fi
echo ""

# Geerling Test Failures
echo -e "${BLUE}=== Geerling Test Failures ===${NC}"
if grep -h "should have found but didn't" "$RETRO_DIR"/*.md -A 3 2>/dev/null | grep -q .; then
    grep -h "should have found but didn't" "$RETRO_DIR"/*.md -A 3 2>/dev/null
else
    echo "  No Geerling test failures recorded"
fi
echo ""

# Development Speed Metrics
echo -e "${BLUE}=== Development Speed Trends ===${NC}"
if grep -h "Speedup:" "$RETRO_DIR"/*.md 2>/dev/null | grep -q .; then
    grep -h "Speedup:" "$RETRO_DIR"/*.md 2>/dev/null
    
    # Calculate average
    AVG=$(grep -h "Speedup:" "$RETRO_DIR"/*.md 2>/dev/null | awk '{print $2}' | sed 's/x//' | awk '{sum+=$1; count++} END {if(count>0) print sum/count "x faster (average)"}')
    echo ""
    echo -e "${GREEN}$AVG${NC}"
else
    echo "  No speedup metrics recorded yet"
fi
echo ""

echo -e "${BLUE}================================================${NC}"
echo -e "${GREEN}✅ Analysis complete!${NC}"
echo ""
echo "Next steps:"
echo "  1. Review patterns above"
echo "  2. Update framework based on findings"
echo "  3. Document new patterns"
echo "  4. Share knowledge with team"
