#!/bin/bash
# pai-rules-generate - Generate cursor rules from templates
# Part of PAI-Cursor integration system

set -euo pipefail

# Configuration
PAI_CONFIG_DIR="$HOME/.config/pai"
TEMPLATES_DIR="$PAI_CONFIG_DIR/templates"
CONTEXTS_CONFIG="$PAI_CONFIG_DIR/contexts.yaml"
CONTEXT_FILE="$PAI_CONFIG_DIR/current-context"

# Get current project directory (where cursor is running)
get_project_directory() {
    # If we're in a git repo, use the repo root
    if git rev-parse --show-toplevel >/dev/null 2>&1; then
        git rev-parse --show-toplevel
    else
        # Otherwise use current directory
        pwd
    fi
}

# Help function
show_help() {
    cat << EOF
pai-rules-generate - Generate cursor rules from templates

USAGE:
    pai-rules-generate [context] [OPTIONS]

ARGUMENTS:
    context     Context to generate rules for (optional, uses current if not specified)

OPTIONS:
    --output-dir DIR    Output directory for rules (default: auto-detect project/.cursor/rules)
    --global           Generate rules in global ~/.cursor/rules directory
    --dry-run          Show what would be generated without writing files
    --help, -h         Show this help message

EXIT CODES:
    0   Rules generated successfully
    1   Error during generation
    2   Invalid arguments or missing templates

EXAMPLES:
    pai-rules-generate
    pai-rules-generate redhat
    pai-rules-generate mga --output-dir ./custom-rules
    pai-rules-generate --dry-run
EOF
}

# Get current context
get_current_context() {
    if [[ -f "$CONTEXT_FILE" ]]; then
        cat "$CONTEXT_FILE" 2>/dev/null || echo "general"
    else
        echo "general"
    fi
}

# Generate core rule
generate_core_rule() {
    local output_dir="$1"
    local context="$2"

    cat > "$output_dir/00-garcia-core.mdc" << 'EOF'
---
description: Garcia PAI assistant with INTJ+Type 8 personality and business context awareness
globs: ["**/*"]
alwaysApply: true
---

# Garcia Core Assistant

## Communication Style
- Direct, professional, and fact-focused
- Clear explanations without excessive metaphors
- Objective and straightforward responses
- Maintains competence through concise, informative responses

## Context Banner Requirement
At the start of each session, you must display the current context:
Format: `Context: [context] | Compliance: [yes/no] | Models: [restrictions]`

## Development Standards
- Follow established patterns in existing codebase
- Maintain security best practices
- Never commit secrets or keys
- Use proper error handling and logging
- Update documentation when adding features

## Work Approach
- Intensely dedicated and thorough
- Takes pride in solving complex problems
- Multitasks efficiently across systems
- Maintains focus under pressure
- Protective of user privacy and security
EOF
}

# Generate context-specific rule
generate_context_rule() {
    local output_dir="$1"
    local context="$2"
    local rule_file=""
    local rule_content=""

    case "$context" in
        redhat)
            rule_file="10-redhat-compliance.mdc"
            rule_content='---
description: Red Hat PSIRT work with mandatory compliance requirements
globs: ["**/redhat/**", "**/psirt/**", "**/case-*"]
alwaysApply: false
---

# Red Hat PSIRT Context

## Mandatory Compliance Requirements
- Customer data MUST use AIA-approved local models only
- All operations logged for Red Hat AI policy compliance
- External APIs BLOCKED for customer data processing
- Case attachments processed via compliant routing

## PSIRT Team Functions
- Vulnerability Assessment & Response
- Compliance Support (FedRAMP, PCI-DSS)
- CVE content and data management
- Industry working group leadership

## Data Classification
- Customer vulnerability data: CONFIDENTIAL
- Internal processes: INTERNAL USE
- Public security advisories: PUBLIC

## Knowledge Base
Reference: ~/.claude/context/knowledge/businesses/redhat/'
            ;;
        mga)
            rule_file="20-mga-business.mdc"
            rule_content='---
description: Midnight Garden Apothecary herbal products business operations
globs: ["**/mga/**", "**/herbal/**", "**/products/**"]
alwaysApply: false
---

# Midnight Garden Apothecary Context

## Business Overview
- Type: Cottage Industry - Herbal Products Manufacturing
- Products: Herbal soaps, salves, ointments, bath products, tinctures
- Branding: Celtic Tree of Life theme

## Key Operations
- Recipe formulations and production schedules
- Regulatory compliance for cottage industry
- Inventory management and supplier relations
- Warehouse production facility (October 2025)

## Knowledge Base
Reference: ~/.claude/context/knowledge/businesses/mga/
Files: Symlinked to /Volumes/Public/business/MGA/'
            ;;
        rec)
            rule_file="21-rec-business.mdc"
            rule_content='---
description: Raven'\''s Eye Consulting metaphysical shop operations
globs: ["**/rec/**", "**/crystals/**", "**/metaphysical/**"]
alwaysApply: false
---

# Raven'\''s Eye Consulting Context

## Business Overview
- Type: Metaphysical Shop - Crystals & Neo-Pagan Supplies
- Products: Crystals, metaphysical supplies, neo-pagan ritual items
- Operations: Retail and reselling

## Key Operations
- Inventory management and product cataloging
- Order fulfillment and shipping operations
- Shopify integration and e-commerce
- Warehouse operations (October 2025)

## Knowledge Base
Reference: ~/.claude/context/knowledge/businesses/rec/
Files: Symlinked to /Volumes/Public/business/REC/'
            ;;
        warehouse)
            rule_file="30-warehouse-project.mdc"
            rule_content='---
description: Multi-business warehouse consolidation project coordination
globs: ["**/warehouse/**", "**/consolidation/**"]
alwaysApply: false
---

# Warehouse Consolidation Project

## Project Overview
- Timeline: October 1, 2025 start date
- Space: Two adjoining 760 sqft units, Springfield OR
- Lease: 3-year term through 2028

## Multi-Business Integration
1. Red Hat Office Space (Grimm & Shale)
2. MGA Production Facility (herbal products)
3. REC Warehouse Operations (crystal storage/fulfillment)

## Key Coordination Points
- Shared project management with Shale
- Insurance requirements: $1M/$2M liability
- Compliance boundaries between business areas
- Timeline and milestone tracking

## Knowledge Base
Reference: ~/.claude/context/workspace/warehouse/'
            ;;
        personal)
            rule_file="40-personal-projects.mdc"
            rule_content='---
description: Personal development, learning, and hobby projects
globs: ["**/personal/**", "**/learning/**", "**/hobby/**", "**/experiment/**"]
alwaysApply: false
---

# Personal Projects Context

## Scope
- Personal development and skill building
- Learning new technologies and techniques
- Hobby projects and creative experiments
- Side projects and explorations

## Approach
- Creative capabilities fully enabled
- Experimental features welcome
- Learning-focused methodology
- No business constraints or deadlines

## Knowledge Base
Reference: ~/.claude/context/knowledge/personal/'
            ;;
        content)
            rule_file="41-content-creation.mdc"
            rule_content='---
description: Video analysis, blog writing, and content development
globs: ["**/content/**", "**/video/**", "**/blog/**", "**/writing/**", "**/sr-auto/**", "**/yt-dlp/**"]
alwaysApply: false
---

# Content Creation Context

## Content Types
- Video analysis and processing
- Blog writing and optimization
- Content strategy and planning
- Media processing and automation

## Available Tools
- sr-auto: Screen recording and automation
- yt-dlp: Video content extraction
- Content analysis and optimization tools
- SEO and engagement optimization

## Focus Areas
- Content creation and optimization
- Video processing and analysis
- Writing enhancement and editing
- Media workflow automation

## Knowledge Base
Reference: ~/.claude/context/knowledge/content/'
            ;;
        health)
            rule_file="42-health-wellness.mdc"
            rule_content='---
description: Health tracking, wellness research, and medical information
globs: ["**/health/**", "**/wellness/**", "**/medical/**", "**/fitness/**"]
alwaysApply: false
---

# Health & Wellness Context

## Health Management
- Personal health tracking and monitoring
- Wellness research and optimization
- Medical information analysis
- Fitness planning and tracking

## Data Sensitivity
- Personal health information requires privacy protection
- Medical data should be kept confidential
- Wellness tracking for personal optimization
- Research-based health recommendations

## Focus Areas
- Evidence-based health research
- Personal wellness optimization
- Medical information analysis
- Fitness and nutrition planning

## Knowledge Base
Reference: ~/.claude/context/knowledge/health/'
            ;;
        academic)
            rule_file="43-academic-research.mdc"
            rule_content='---
description: Academic studies, research papers, and scholarly work
globs: ["**/academic/**", "**/research/**", "**/papers/**", "**/studies/**"]
alwaysApply: false
---

# Academic Research Context

## Research Focus
- Academic paper analysis and synthesis
- Scholarly research methodology
- Literature reviews and citations
- Research project management

## Academic Standards
- Rigorous fact-checking and verification
- Proper citation and attribution
- Evidence-based conclusions
- Scholarly communication style

## Research Areas
- Technology and computer science
- Business and management studies
- Health and medical research
- Multi-disciplinary studies

## Knowledge Base
Reference: ~/.claude/context/knowledge/academic/'
            ;;
        home-automation)
            rule_file="50-home-automation.mdc"
            rule_content='---
description: Smart home devices, IoT management, and energy optimization
globs: ["**/home/**", "**/iot/**", "**/smart-home/**", "**/automation/**"]
alwaysApply: false
---

# Home Automation Context

## Smart Home Management
- IoT device configuration and monitoring
- Home Assistant, Zigbee, Z-Wave integrations
- Energy usage optimization and tracking
- Security system management and automation

## Available Platforms
- Home Assistant ecosystem and add-ons
- Node-RED for automation workflows
- MQTT broker for device communication
- InfluxDB + Grafana for metrics

## Focus Areas
- Device automation and scene creation
- Energy monitoring and cost optimization
- Security and privacy for IoT devices
- Network segmentation and device isolation

## Privacy & Security
- Local-first processing preferred
- Network segmentation for IoT devices
- Regular security updates and monitoring
- Data sovereignty for home metrics

## Knowledge Base
Reference: ~/.pai/context/knowledge/home-automation/'
            ;;
        finance)
            rule_file="51-finance.mdc"
            rule_content='---
description: Personal finance, budgeting, and investment tracking
globs: ["**/finance/**", "**/budget/**", "**/investment/**", "**/money/**"]
alwaysApply: false
---

# Personal Finance Context

## Financial Management
- Budget tracking and expense categorization
- Investment portfolio analysis and optimization
- Bill management and subscription tracking
- Tax preparation and record keeping

## Available Tools
- Mint, YNAB, or similar budgeting platforms
- Portfolio tracking and analysis tools
- Cryptocurrency tracking if applicable
- Receipt scanning and expense automation

## Focus Areas
- Cash flow optimization and debt reduction
- Investment strategy and diversification
- Tax optimization and planning
- Financial goal setting and tracking

## Privacy & Security
- Financial data NEVER leaves local environment
- Encrypted storage for sensitive information
- Secure API handling for bank connections
- Regular security audits for financial tools

## Knowledge Base
Reference: ~/.pai/context/knowledge/finance/'
            ;;
        meal-planning)
            rule_file="52-meal-planning.mdc"
            rule_content='---
description: Cooking, nutrition tracking, and meal preparation
globs: ["**/meal/**", "**/recipe/**", "**/nutrition/**", "**/cooking/**"]
alwaysApply: false
---

# Meal Planning Context

## Meal Management
- Recipe organization and meal planning
- Nutritional analysis and diet tracking
- Grocery list generation and optimization
- Meal prep scheduling and batch cooking

## Available Tools
- Recipe management apps and databases
- Nutritional analysis tools
- Grocery delivery integration
- Kitchen inventory tracking

## Focus Areas
- Healthy meal planning and nutrition goals
- Cost-effective grocery shopping
- Time-efficient meal preparation
- Dietary restrictions and preferences

## Health Integration
- Calorie and macro tracking
- Dietary goal monitoring
- Food sensitivity management
- Meal timing optimization

## Knowledge Base
Reference: ~/.pai/context/knowledge/meal-planning/'
            ;;
        family)
            rule_file="53-family.mdc"
            rule_content='---
description: Family scheduling, communication, and relationship management
globs: ["**/family/**", "**/schedule/**", "**/kids/**", "**/relationships/**"]
alwaysApply: false
---

# Family Management Context

## Family Coordination
- Shared calendar management and scheduling
- Activity coordination and transportation
- Communication and relationship tracking
- Gift planning and special occasions

## Available Tools
- Google Calendar or family scheduling apps
- Chore and allowance tracking systems
- Educational progress monitoring
- Family communication platforms

## Focus Areas
- Efficient scheduling and time management
- Activity planning and logistics
- Educational support and progress tracking
- Family relationship nurturing

## Privacy & Family Safety
- Child-safe internet and device usage
- Location sharing for safety (when appropriate)
- Screen time management and digital wellness
- Privacy education for family members

## Knowledge Base
Reference: ~/.pai/context/knowledge/family/'
            ;;
        maintenance)
            rule_file="54-maintenance.mdc"
            rule_content='---
description: Home and vehicle maintenance, seasonal tasks, and preventive care
globs: ["**/maintenance/**", "**/repair/**", "**/home/**", "**/vehicle/**"]
alwaysApply: false
---

# Maintenance Context

## Maintenance Management
- Preventive maintenance scheduling
- Repair tracking and vendor management
- Seasonal task planning and reminders
- Warranty and service record keeping

## Maintenance Areas
- Home systems (HVAC, plumbing, electrical)
- Appliance maintenance and troubleshooting
- Vehicle maintenance and service tracking
- Outdoor and landscaping maintenance

## Focus Areas
- Cost-effective DIY vs professional repairs
- Preventive maintenance to avoid major issues
- Energy efficiency improvements
- Tool and supply inventory management

## Knowledge Base
- Home maintenance guides and schedules
- Vehicle service manuals and specifications
- Local contractor and vendor information
- Parts sourcing and warranty tracking

Reference: ~/.pai/context/knowledge/maintenance/'
            ;;
        learning)
            rule_file="55-learning.mdc"
            rule_content='---
description: Personal development, skill building, and knowledge acquisition
globs: ["**/learning/**", "**/course/**", "**/skill/**", "**/development/**"]
alwaysApply: false
---

# Learning Context

## Learning Management
- Course tracking and progress monitoring
- Skill development planning and practice
- Reading list management and note-taking
- Certification and goal tracking

## Learning Platforms
- Online course platforms (Coursera, Udemy, etc.)
- Professional development resources
- Technical skill practice environments
- Language learning applications

## Focus Areas
- Career development and skill building
- Personal interest exploration
- Knowledge retention and application
- Learning habit formation and tracking

## Learning Methods
- Spaced repetition for retention
- Project-based learning application
- Peer learning and study groups
- Progress tracking and achievement

## Knowledge Base
Reference: ~/.pai/context/knowledge/learning/'
            ;;
        entertainment)
            rule_file="56-entertainment.mdc"
            rule_content='---
description: Media management, hobby projects, and leisure activities
globs: ["**/entertainment/**", "**/media/**", "**/hobby/**", "**/games/**"]
alwaysApply: false
---

# Entertainment Context

## Entertainment Management
- Media library organization and streaming
- Gaming progress and achievement tracking
- Hobby project planning and supplies
- Event and activity discovery

## Available Platforms
- Plex, Jellyfin for media management
- Steam, console gaming platforms
- Hobby-specific tools and communities
- Local event and activity databases

## Focus Areas
- Media consumption tracking and recommendations
- Gaming achievement and progress tracking
- Hobby project planning and execution
- Social activity coordination

## Creative Projects
- DIY project planning and tutorials
- Creative skill development
- Maker space and tool management
- Project documentation and sharing

## Knowledge Base
Reference: ~/.pai/context/knowledge/entertainment/'
            ;;
        plex)
            rule_file="57-plex-media-server.mdc"
            rule_content='---
description: Plex media server management and streaming optimization
globs: ["**/plex/**", "**/media-server/**", "**/streaming/**", "**/transcoding/**"]
alwaysApply: false
---

# Plex Media Server Context

## Server Management
- Plex Media Server configuration and optimization
- Library organization and metadata management
- User management and sharing settings
- Hardware transcoding optimization

## Media Organization
- Automated media scanning and matching
- Metadata correction and enhancement
- Collection and playlist management
- Media file organization and naming conventions

## Performance Optimization
- Transcoding settings and hardware acceleration
- Network optimization for streaming
- Storage management and cleanup
- Cache and thumbnail optimization

## Available Tools
- Plex Web Interface and mobile apps
- Third-party tools: Tautulli, Overseerr, Sonarr, Radarr
- PlexAPI for automation scripting
- Media analysis and quality tools

## Focus Areas
- Server performance monitoring and tuning
- Media library curation and organization
- Remote streaming optimization
- Automated media acquisition workflows

## Integration Opportunities
- Home Assistant integration for smart home control
- Energy monitoring for server power consumption
- Network monitoring for bandwidth usage
- Automated backup and disaster recovery

## Knowledge Base
Reference: ~/.pai/context/knowledge/plex/'
            ;;
        general)
            # No additional context rule for general
            return 0
            ;;
    esac

    if [[ -n "$rule_file" && -n "$rule_content" ]]; then
        echo "$rule_content" > "$output_dir/$rule_file"
    fi
}

# Parse arguments
CONTEXT=""
OUTPUT_DIR=""
DRY_RUN=false
GLOBAL_RULES=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --output-dir)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        --global)
            GLOBAL_RULES=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        -*)
            echo "Error: Unknown option $1" >&2
            show_help >&2
            exit 2
            ;;
        *)
            if [[ -z "$CONTEXT" ]]; then
                CONTEXT="$1"
            else
                echo "Error: Multiple contexts specified" >&2
                exit 2
            fi
            shift
            ;;
    esac
done

# Get context (use current if not specified)
if [[ -z "$CONTEXT" ]]; then
    CONTEXT=$(get_current_context)
fi

# Determine output directory
if [[ -z "$OUTPUT_DIR" ]]; then
    if [[ "$GLOBAL_RULES" == "true" ]]; then
        OUTPUT_DIR="$HOME/.cursor/rules"
    else
        # Auto-detect project directory
        project_dir=$(get_project_directory)
        OUTPUT_DIR="$project_dir/.cursor/rules"
    fi
fi

# Validate context
case "$CONTEXT" in
    redhat|mga|rec|warehouse|personal|content|health|academic|home-automation|finance|meal-planning|family|maintenance|learning|entertainment|plex|general) ;;
    *)
        echo "Error: Invalid context '$CONTEXT'" >&2
        exit 1
        ;;
esac

if [[ "$DRY_RUN" == "true" ]]; then
    echo "Dry run: Would generate rules for context '$CONTEXT' in '$OUTPUT_DIR'"
    echo "Files that would be created:"
    echo "  - 00-core.md (Garcia core behavior)"
    case "$CONTEXT" in
        redhat) echo "  - 10-compliance-redhat.md" ;;
        mga) echo "  - 20-context-mga.md" ;;
        rec) echo "  - 21-context-rec.md" ;;
        warehouse) echo "  - 30-project-warehouse.md" ;;
        personal) echo "  - 40-personal-projects.md" ;;
        content) echo "  - 41-content-creation.md" ;;
        health) echo "  - 42-health-wellness.md" ;;
        academic) echo "  - 43-academic-research.md" ;;
        home-automation) echo "  - 50-home-automation.md" ;;
        finance) echo "  - 51-finance.md" ;;
        meal-planning) echo "  - 52-meal-planning.md" ;;
        family) echo "  - 53-family.md" ;;
        maintenance) echo "  - 54-maintenance.md" ;;
        learning) echo "  - 55-learning.md" ;;
        entertainment) echo "  - 56-entertainment.md" ;;
        plex) echo "  - 57-plex-media-server.md" ;;
    esac
    exit 0
fi

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Generate rules
echo "Generating cursor rules for context: $CONTEXT"
echo "Output directory: $OUTPUT_DIR"

# Note: Core Garcia rule is now a User Rule, not generated per-project
echo "Using global Garcia User Rule (garcia-pai-system.mdc)"

# Generate context-specific rule
generate_context_rule "$OUTPUT_DIR" "$CONTEXT"
if [[ "$CONTEXT" != "general" ]]; then
    case "$CONTEXT" in
        redhat) echo "Generated: 10-redhat-compliance.mdc" ;;
        mga) echo "Generated: 20-mga-business.mdc" ;;
        rec) echo "Generated: 21-rec-business.mdc" ;;
        warehouse) echo "Generated: 30-warehouse-project.mdc" ;;
        personal) echo "Generated: 40-personal-projects.mdc" ;;
        content) echo "Generated: 41-content-creation.mdc" ;;
        health) echo "Generated: 42-health-wellness.mdc" ;;
        academic) echo "Generated: 43-academic-research.mdc" ;;
        home-automation) echo "Generated: 50-home-automation.mdc" ;;
        finance) echo "Generated: 51-finance.mdc" ;;
        meal-planning) echo "Generated: 52-meal-planning.mdc" ;;
        family) echo "Generated: 53-family.mdc" ;;
        maintenance) echo "Generated: 54-maintenance.mdc" ;;
        learning) echo "Generated: 55-learning.mdc" ;;
        entertainment) echo "Generated: 56-entertainment.mdc" ;;
        plex) echo "Generated: 57-plex-media-server.mdc" ;;
    esac
fi

# Create README if it doesn't exist
if [[ ! -f "$OUTPUT_DIR/../README-PAI.md" ]]; then
    cat > "$OUTPUT_DIR/../README-PAI.md" << 'EOF'
# PAI-Cursor Integration

This directory contains cursor rules generated by the PAI system.

## Quick Commands
- `pai switch <context>` - Switch business context
- `pai current` - Show current context
- `pai check` - Verify compliance settings
- `pai brief` - Generate daily status brief

## Contexts
- **redhat**: Red Hat PSIRT work (compliance required)
- **mga**: Midnight Garden Apothecary business
- **rec**: Raven's Eye Consulting business
- **warehouse**: Warehouse consolidation project
- **general**: Standard development work

Rules are automatically updated when switching contexts.
EOF
    echo "Generated: README-PAI.md"
fi

echo "Cursor rules generation complete for context: $CONTEXT"
exit 0