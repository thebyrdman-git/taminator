#!/bin/bash

# PAI YouTube Beautiful Progress Bar System
# Enhanced visual progress tracking for YouTube automation
# Part of YouTube-Plex Collections

# Colors and symbols
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Progress bar characters
FULL_BLOCK='‚ñà'
THREE_FOURTHS_BLOCK='‚ñä'
HALF_BLOCK='‚ñå'
ONE_FOURTH_BLOCK='‚ñé'
EMPTY_BLOCK=' '

# YouTube-themed emojis
DOWNLOAD_EMOJI='üì•'
VIDEO_EMOJI='üé¨'
CHANNEL_EMOJI='üì∫'
CLEANUP_EMOJI='üßπ'
SYNC_EMOJI='üîÑ'
SUCCESS_EMOJI='‚úÖ'
ERROR_EMOJI='‚ùå'
WARNING_EMOJI='‚ö†Ô∏è'

# Show beautiful progress bar
show_youtube_progress() {
    local current="${1:-0}"
    local total="${2:-100}"
    local task="${3:-Processing}"
    local width="${4:-50}"
    local show_percentage="${5:-true}"
    
    # Calculate percentage
    local percentage=$((current * 100 / total))
    
    # Calculate filled blocks
    local filled=$((current * width / total))
    local partial=$((current * width % total))
    
    # Build progress bar
    local bar=""
    local i
    
    # Full blocks
    for ((i = 0; i < filled; i++)); do
        bar+="${FULL_BLOCK}"
    done
    
    # Partial block
    if [[ $partial -gt 0 && $filled -lt $width ]]; then
        if [[ $partial -ge 75 ]]; then
            bar+="${THREE_FOURTHS_BLOCK}"
        elif [[ $partial -ge 50 ]]; then
            bar+="${HALF_BLOCK}"
        elif [[ $partial -ge 25 ]]; then
            bar+="${ONE_FOURTH_BLOCK}"
        fi
        ((filled++))
    fi
    
    # Empty blocks
    for ((i = filled; i < width; i++)); do
        bar+="${EMPTY_BLOCK}"
    done
    
    # Color the bar based on progress
    local color
    if [[ $percentage -ge 100 ]]; then
        color="$GREEN"
    elif [[ $percentage -ge 75 ]]; then
        color="$CYAN"
    elif [[ $percentage -ge 50 ]]; then
        color="$BLUE"
    elif [[ $percentage -ge 25 ]]; then
        color="$YELLOW"
    else
        color="$RED"
    fi
    
    # Show percentage if requested
    local pct_display=""
    if [[ "$show_percentage" == "true" ]]; then
        pct_display=" ${percentage}%"
    fi
    
    # Display the progress bar
    printf "\r${BOLD}${task}${NC} [${color}${bar}${NC}]${pct_display} (${current}/${total})"
    
    # New line when complete
    if [[ $current -eq $total ]]; then
        printf "\n"
    fi
}

# Animated spinner for indeterminate progress
show_youtube_spinner() {
    local message="${1:-Processing}"
    local delay="${2:-0.1}"
    local spinstr='|/-\'
    
    while true; do
        for (( i=0; i<${#spinstr}; i++ )); do
            printf "\r${CYAN}${SYNC_EMOJI} ${message}${NC} ${spinstr:$i:1} "
            sleep "$delay"
        done
    done
}

# Stop spinner (call this to end spinner)
stop_spinner() {
    printf "\r%${COLUMNS}s\r"  # Clear line
}

# Show download progress with YouTube theming
show_download_progress() {
    local current="${1:-0}"
    local total="${2:-100}"
    local channel="${3:-Unknown Channel}"
    local video_title="${4:-Unknown Video}"
    local speed="${5:-}"
    
    # Truncate long titles
    if [[ ${#video_title} -gt 40 ]]; then
        video_title="${video_title:0:37}..."
    fi
    
    local percentage=$((current * 100 / total))
    local width=40
    local filled=$((current * width / total))
    
    # Build bar
    local bar=""
    for ((i = 0; i < filled; i++)); do
        bar+="${FULL_BLOCK}"
    done
    for ((i = filled; i < width; i++)); do
        bar+="${EMPTY_BLOCK}"
    done
    
    # Color based on progress
    local color
    if [[ $percentage -ge 100 ]]; then
        color="$GREEN"
    elif [[ $percentage -ge 50 ]]; then
        color="$CYAN"
    else
        color="$YELLOW"
    fi
    
    # Speed display
    local speed_display=""
    if [[ -n "$speed" ]]; then
        speed_display=" @ ${speed}"
    fi
    
    printf "\r${DOWNLOAD_EMOJI} ${BOLD}${channel}${NC}\n"
    printf "   ${DIM}${video_title}${NC}\n"
    printf "   [${color}${bar}${NC}] ${percentage}%%${speed_display}"
    
    if [[ $current -eq $total ]]; then
        printf "\n   ${SUCCESS_EMOJI} ${GREEN}Download complete${NC}\n\n"
    fi
}

# Show channel sync status
show_channel_status() {
    local channel="${1:-Unknown Channel}"
    local status="${2:-processing}"  # processing, complete, error, skipped
    local count="${3:-0}"
    local message="${4:-}"
    
    local emoji
    local color
    
    case "$status" in
        "processing")
            emoji="$SYNC_EMOJI"
            color="$YELLOW"
            ;;
        "complete")
            emoji="$SUCCESS_EMOJI"
            color="$GREEN"
            ;;
        "error")
            emoji="$ERROR_EMOJI"
            color="$RED"
            ;;
        "skipped")
            emoji="$WARNING_EMOJI"
            color="$CYAN"
            ;;
    esac
    
    printf "${emoji} ${BOLD}${channel}${NC} - ${color}${status}${NC}"
    
    if [[ $count -gt 0 ]]; then
        printf " (${count} videos)"
    fi
    
    if [[ -n "$message" ]]; then
        printf " - ${DIM}${message}${NC}"
    fi
    
    printf "\n"
}

# Beautiful header for YouTube operations
show_youtube_header() {
    local title="${1:-YouTube Automation}"
    local subtitle="${2:-}"
    
    echo
    echo -e "${BOLD}${MAGENTA}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    printf "${BOLD}${MAGENTA}‚îÇ${NC} ${BOLD}${CYAN}${VIDEO_EMOJI} %-45s ${MAGENTA}‚îÇ${NC}\n" "$title"
    
    if [[ -n "$subtitle" ]]; then
        printf "${BOLD}${MAGENTA}‚îÇ${NC} ${DIM}%-47s ${MAGENTA}‚îÇ${NC}\n" "$subtitle"
    fi
    
    echo -e "${BOLD}${MAGENTA}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo
}

# Show summary statistics
show_summary() {
    local downloads="${1:-0}"
    local errors="${2:-0}" 
    local channels="${3:-0}"
    local space_saved="${4:-0}"
    
    echo
    echo -e "${BOLD}${BLUE}üìä OPERATION SUMMARY${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    if [[ $downloads -gt 0 ]]; then
        echo -e "${SUCCESS_EMOJI} ${GREEN}Downloaded:${NC} $downloads videos"
    fi
    
    if [[ $channels -gt 0 ]]; then
        echo -e "${CHANNEL_EMOJI} ${CYAN}Channels processed:${NC} $channels"
    fi
    
    if [[ $errors -gt 0 ]]; then
        echo -e "${ERROR_EMOJI} ${RED}Errors:${NC} $errors"
    fi
    
    if [[ $space_saved -gt 0 ]]; then
        echo -e "${CLEANUP_EMOJI} ${YELLOW}Space recovered:${NC} ${space_saved}MB"
    fi
    
    echo
}

# Live updating multi-line progress (for multiple downloads)
show_multi_progress() {
    local -n progress_data=$1  # Array reference
    local max_lines="${2:-5}"
    
    # Clear previous lines
    for ((i = 0; i < max_lines; i++)); do
        printf "\033[1A\033[2K"  # Move up and clear line
    done
    
    # Show current progress for each item
    local count=0
    for item in "${progress_data[@]}"; do
        if [[ $count -ge $max_lines ]]; then break; fi
        
        IFS='|' read -r name current total status <<< "$item"
        
        case "$status" in
            "downloading")
                show_youtube_progress "$current" "$total" "${DOWNLOAD_EMOJI} $name" 30 true
                ;;
            "complete")
                printf "${SUCCESS_EMOJI} ${GREEN}%-30s${NC} [COMPLETE]\n" "$name"
                ;;
            "error")
                printf "${ERROR_EMOJI} ${RED}%-30s${NC} [ERROR]\n" "$name"
                ;;
        esac
        
        ((count++))
    done
    
    # Fill remaining lines
    for ((i = count; i < max_lines; i++)); do
        echo
    done
}

# Export functions for use in other scripts
export -f show_youtube_progress
export -f show_youtube_spinner 
export -f stop_spinner
export -f show_download_progress
export -f show_channel_status
export -f show_youtube_header
export -f show_summary
export -f show_multi_progress

# If called directly, show demo
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    show_youtube_header "YouTube Progress Bar Demo" "Testing beautiful progress indicators"
    
    echo "Testing basic progress bar:"
    for i in {0..100..5}; do
        show_youtube_progress "$i" 100 "Downloading video" 50 true
        sleep 0.1
    done
    
    echo
    echo "Testing channel status:"
    show_channel_status "LEGO Official" "processing" 5 "Checking for new videos"
    sleep 1
    show_channel_status "LEGO Official" "complete" 3 "Downloaded 3 new videos"
    
    echo
    echo "Testing download progress:"
    show_download_progress 75 100 "Kurzgesagt" "The Last Human ‚Äì A Glimpse Into The Far Future" "2.3MB/s"
    
    show_summary 15 2 8 1250
fi

