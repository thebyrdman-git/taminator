#!/bin/bash

# TAM RFE Automation Tool - Ansible-based Report Generation
# Uses structured variables for consistent, reliable results

set -e  # Exit on any error

# Configuration
PROJECT_ROOT="/home/jbyrd/pai/rfe-automation-clean"
ANSIBLE_DIR="$PROJECT_ROOT/ansible"
INVENTORY_FILE="$ANSIBLE_DIR/inventory/customers.yml"
PLAYBOOK_FILE="$ANSIBLE_DIR/playbooks/generate_rfe_reports.yml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local status="$1"
    local message="$2"
    case $status in
        "SUCCESS") echo -e "${GREEN}âœ… $message${NC}" ;;
        "ERROR") echo -e "${RED}âŒ $message${NC}" ;;
        "WARNING") echo -e "${YELLOW}âš ï¸  $message${NC}" ;;
        "INFO") echo -e "${BLUE}â„¹ï¸  $message${NC}" ;;
        *) echo -e "$message" ;;
    esac
}

# Function to display usage
usage() {
    echo "TAM RFE Automation Tool - Ansible Report Generator"
    echo "=================================================="
    echo ""
    echo "Usage: $0 [OPTIONS] [CUSTOMER]"
    echo ""
    echo "Options:"
    echo "  -h, --help          Show this help message"
    echo "  -l, --list          List available customers"
    echo "  -v, --verbose       Enable verbose output"
    echo "  --dry-run          Show what would be done without executing"
    echo "  --check            Run in check mode (no changes)"
    echo "  --tags TAGS        Run only tasks with specified tags"
    echo "  --skip-tags TAGS   Skip tasks with specified tags"
    echo ""
    echo "Examples:"
    echo "  $0                  # Generate reports for all customers"
    echo "  $0 jpmc            # Generate report for JPMC only"
    echo "  $0 --list          # List available customers"
    echo "  $0 --dry-run       # Show what would be executed"
    echo ""
    echo "Customer-specific options:"
    echo "  --rfe-only         Generate only RFE/Bug tracker reports"
    echo "  --active-only      Generate only Active Cases reports"
    echo "  --no-validation    Skip content validation"
    echo ""
}

# Function to check prerequisites
check_prerequisites() {
    print_status "INFO" "Checking prerequisites..."
    
    # Check if we're in the right directory
    if [ ! -f "$PROJECT_ROOT/README.md" ]; then
        print_status "ERROR" "Please run this script from the RFE automation tool directory"
        exit 1
    fi
    
    # Check if Ansible is installed
    if ! command -v ansible-playbook &> /dev/null; then
        print_status "ERROR" "Ansible is not installed. Please install Ansible first:"
        echo "   RHEL/Fedora: sudo dnf install ansible"
        echo "   Mac: brew install ansible"
        exit 1
    fi
    
    # Check if inventory file exists
    if [ ! -f "$INVENTORY_FILE" ]; then
        print_status "ERROR" "Inventory file not found: $INVENTORY_FILE"
        exit 1
    fi
    
    # Check if playbook file exists
    if [ ! -f "$PLAYBOOK_FILE" ]; then
        print_status "ERROR" "Playbook file not found: $PLAYBOOK_FILE"
        exit 1
    fi
    
    # Check if rhcase is available
    if [ ! -f "$PROJECT_ROOT/rhcase/.venv/bin/rhcase" ]; then
        print_status "WARNING" "rhcase tool not found. Run ./bin/install-dependencies first."
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
    
    print_status "SUCCESS" "Prerequisites check passed"
}

# Function to list available customers
list_customers() {
    print_status "INFO" "Available customers:"
    echo ""
    
    # Extract customer names from inventory file
    grep -A 1 "^        [a-zA-Z].*:" "$INVENTORY_FILE" | grep -E "^        [a-zA-Z]" | sed 's/^        //' | sed 's/:$//' | while read -r customer; do
        if [ -n "$customer" ]; then
            echo "  â€¢ $customer"
        fi
    done
    echo ""
}

# Function to generate reports
generate_reports() {
    local customer="$1"
    local extra_args="$2"
    
    print_status "INFO" "Starting RFE report generation..."
    echo ""
    
    # Build ansible-playbook command
    local ansible_cmd="ansible-playbook"
    local ansible_args="-i $INVENTORY_FILE $PLAYBOOK_FILE"
    
    # Add customer-specific targeting if specified
    if [ -n "$customer" ]; then
        ansible_args="$ansible_args --limit $customer"
    fi
    
    # Add tags if specified
    if [ -n "$TAGS" ]; then
        ansible_args="$ansible_args --tags $TAGS"
    fi
    
    # Add skip-tags if specified
    if [ -n "$SKIP_TAGS" ]; then
        ansible_args="$ansible_args --skip-tags $SKIP_TAGS"
    fi
    
    # Add extra arguments
    if [ -n "$extra_args" ]; then
        ansible_args="$ansible_args $extra_args"
    fi
    
    # Add verbose flag if requested
    if [ "$VERBOSE" = true ]; then
        ansible_args="$ansible_args -v"
    fi
    
    print_status "INFO" "Executing: $ansible_cmd $ansible_args"
    echo ""
    
    # Execute the playbook
    cd "$PROJECT_ROOT"
    eval "$ansible_cmd $ansible_args"
    
    local exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        print_status "SUCCESS" "Report generation completed successfully!"
        echo ""
        print_status "INFO" "Generated reports are available in: $PROJECT_ROOT/output/"
        print_status "INFO" "Logs are available in: $PROJECT_ROOT/logs/"
    else
        print_status "ERROR" "Report generation failed with exit code: $exit_code"
        exit $exit_code
    fi
}

# Parse command line arguments
CUSTOMER=""
VERBOSE=false
DRY_RUN=false
CHECK_MODE=false
TAGS=""
SKIP_TAGS=""
EXTRA_ARGS=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -l|--list)
            list_customers
            exit 0
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            EXTRA_ARGS="$EXTRA_ARGS --check --diff"
            shift
            ;;
        --check)
            CHECK_MODE=true
            EXTRA_ARGS="$EXTRA_ARGS --check"
            shift
            ;;
        --rfe-only)
            EXTRA_ARGS="$EXTRA_ARGS -e 'report_types=[\"rfe_bug_tracker\"]'"
            shift
            ;;
        --active-only)
            EXTRA_ARGS="$EXTRA_ARGS -e 'report_types=[\"active_cases\"]'"
            shift
            ;;
        --no-validation)
            EXTRA_ARGS="$EXTRA_ARGS -e 'validation_enabled=false'"
            shift
            ;;
        --tags)
            TAGS="$2"
            shift 2
            ;;
        --skip-tags)
            SKIP_TAGS="$2"
            shift 2
            ;;
        -*)
            print_status "ERROR" "Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            if [ -z "$CUSTOMER" ]; then
                CUSTOMER="$1"
            else
                print_status "ERROR" "Multiple customers specified. Please specify only one customer."
                exit 1
            fi
            shift
            ;;
    esac
done

# Main execution
echo "ðŸš€ TAM RFE Automation Tool - Ansible Report Generator"
echo "====================================================="
echo ""

# Check prerequisites
check_prerequisites

# Validate customer if specified
if [ -n "$CUSTOMER" ]; then
    if ! grep -q "^        $CUSTOMER:" "$INVENTORY_FILE"; then
        print_status "ERROR" "Customer '$CUSTOMER' not found in inventory"
        echo ""
        list_customers
        exit 1
    fi
    print_status "INFO" "Target customer: $CUSTOMER"
else
    print_status "INFO" "Target: All customers"
fi

# Show dry-run status
if [ "$DRY_RUN" = true ]; then
    print_status "INFO" "DRY RUN MODE - No changes will be made"
fi

if [ "$CHECK_MODE" = true ]; then
    print_status "INFO" "CHECK MODE - Will show what would change"
fi

echo ""

# Generate reports
generate_reports "$CUSTOMER" "$EXTRA_ARGS"

print_status "SUCCESS" "RFE Automation Tool execution completed! ðŸŽ‰"
