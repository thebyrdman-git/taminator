#!/bin/bash

# pai-litellm-service - Manage the PAI LiteLLM systemd service
# Part of the PAI (Personal AI Infrastructure) System

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

SERVICE_NAME="pai-litellm.service"
SERVICE_URL="http://localhost:4000"

# Function to print colored output
print_status() {
    echo -e "${BLUE}[PAI-LiteLLM-Service]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[PAI-LiteLLM-Service]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[PAI-LiteLLM-Service]${NC} $1"
}

print_error() {
    echo -e "${RED}[PAI-LiteLLM-Service]${NC} $1"
}

# Function to check if service is running
is_service_running() {
    systemctl --user is-active "$SERVICE_NAME" >/dev/null 2>&1
}

# Function to check if service is enabled
is_service_enabled() {
    systemctl --user is-enabled "$SERVICE_NAME" >/dev/null 2>&1
}

# Function to test API connectivity
test_api() {
    if curl -s "$SERVICE_URL/health" >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Function to show service status
show_status() {
    print_status "LiteLLM Service Status"
    echo "======================"
    
    if is_service_enabled; then
        print_success "‚úÖ Service is enabled (will start at login)"
    else
        print_warning "‚ö†Ô∏è  Service is not enabled"
    fi
    
    if is_service_running; then
        print_success "‚úÖ Service is running"
        
        if test_api; then
            print_success "‚úÖ API is responding"
            print_status "üåê Available at: $SERVICE_URL"
        else
            print_warning "‚ö†Ô∏è  Service running but API not responding"
        fi
    else
        print_error "‚ùå Service is not running"
    fi
    
    echo ""
    print_status "Detailed systemd status:"
    systemctl --user status "$SERVICE_NAME" --lines=5 --no-pager || true
}

# Function to show logs
show_logs() {
    local lines="${1:-50}"
    print_status "Showing last $lines log lines:"
    echo "================================"
    journalctl --user -u "$SERVICE_NAME" -n "$lines" --no-pager
}

# Function to start service
start_service() {
    print_status "Starting LiteLLM service..."
    
    if is_service_running; then
        print_warning "Service is already running"
        return 0
    fi
    
    systemctl --user start "$SERVICE_NAME"
    sleep 3
    
    if is_service_running; then
        print_success "‚úÖ Service started successfully"
        if test_api; then
            print_success "‚úÖ API is responding at $SERVICE_URL"
        fi
    else
        print_error "‚ùå Failed to start service"
        return 1
    fi
}

# Function to stop service
stop_service() {
    print_status "Stopping LiteLLM service..."
    
    if ! is_service_running; then
        print_warning "Service is not running"
        return 0
    fi
    
    systemctl --user stop "$SERVICE_NAME"
    sleep 2
    
    if ! is_service_running; then
        print_success "‚úÖ Service stopped successfully"
    else
        print_error "‚ùå Failed to stop service"
        return 1
    fi
}

# Function to restart service
restart_service() {
    print_status "Restarting LiteLLM service..."
    systemctl --user restart "$SERVICE_NAME"
    sleep 3
    
    if is_service_running && test_api; then
        print_success "‚úÖ Service restarted successfully"
        print_success "‚úÖ API is responding at $SERVICE_URL"
    else
        print_error "‚ùå Service restart failed or API not responding"
        return 1
    fi
}

# Function to enable service
enable_service() {
    print_status "Enabling LiteLLM service for auto-start..."
    
    if is_service_enabled; then
        print_warning "Service is already enabled"
        return 0
    fi
    
    systemctl --user enable "$SERVICE_NAME"
    print_success "‚úÖ Service enabled for auto-start at login"
}

# Function to disable service
disable_service() {
    print_status "Disabling LiteLLM service auto-start..."
    
    if ! is_service_enabled; then
        print_warning "Service is not enabled"
        return 0
    fi
    
    systemctl --user disable "$SERVICE_NAME"
    print_success "‚úÖ Service disabled (will not auto-start)"
}

# Function to show usage
show_usage() {
    echo "Usage: pai-litellm-service <command>"
    echo ""
    echo "Commands:"
    echo "  status       Show service status and API connectivity"
    echo "  start        Start the LiteLLM service"
    echo "  stop         Stop the LiteLLM service"  
    echo "  restart      Restart the LiteLLM service"
    echo "  enable       Enable auto-start at login"
    echo "  disable      Disable auto-start at login"
    echo "  logs [N]     Show last N log lines (default: 50)"
    echo "  test         Test API connectivity"
    echo "  help         Show this help message"
    echo ""
    echo "Examples:"
    echo "  pai-litellm-service status"
    echo "  pai-litellm-service logs 100"
    echo "  pai-litellm-service restart"
}

# Function to test API
test_api_command() {
    print_status "Testing LiteLLM API connectivity..."
    
    if test_api; then
        print_success "‚úÖ API is responding at $SERVICE_URL"
        
        # Test models endpoint
        if curl -s "$SERVICE_URL/v1/models" >/dev/null 2>&1; then
            print_success "‚úÖ Models endpoint is accessible"
        else
            print_warning "‚ö†Ô∏è  Models endpoint not responding"
        fi
    else
        print_error "‚ùå API is not responding"
        print_status "Check service status with: pai-litellm-service status"
        return 1
    fi
}

# Main script logic
main() {
    local command="${1:-status}"
    
    case "$command" in
        "status")
            show_status
            ;;
        "start")
            start_service
            ;;
        "stop")
            stop_service
            ;;
        "restart")
            restart_service
            ;;
        "enable")
            enable_service
            ;;
        "disable")
            disable_service
            ;;
        "logs")
            show_logs "${2:-50}"
            ;;
        "test")
            test_api_command
            ;;
        "help"|"-h"|"--help")
            show_usage
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
