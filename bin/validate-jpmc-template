#!/bin/bash

# JPMC RFE/Bug Template Validation Script
# Purpose: Validate the JPMC enterprise-grade template meets 99%+ accuracy standards
# Usage: ./bin/validate-jpmc-template

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "ðŸ” JPMC RFE/Bug Template Validation"
echo "===================================="
echo ""

# Check if we're in the right directory
if [ ! -f "README.md" ] || [ ! -d "templates" ]; then
    echo -e "${RED}âŒ Error: Please run this script from the RFE automation tool directory${NC}"
    exit 1
fi

# Function to print colored output
print_status() {
    local status=$1
    local message=$2
    case $status in
        "SUCCESS")
            echo -e "${GREEN}âœ… $message${NC}"
            ;;
        "WARNING")
            echo -e "${YELLOW}âš ï¸  $message${NC}"
            ;;
        "ERROR")
            echo -e "${RED}âŒ $message${NC}"
            ;;
        "INFO")
            echo -e "${BLUE}â„¹ï¸  $message${NC}"
            ;;
    esac
}

# Template file path
TEMPLATE_FILE="templates/jpmc_rfe_bug_template_enterprise.md"

# Check if template exists
if [ ! -f "$TEMPLATE_FILE" ]; then
    print_status "ERROR" "Template file not found: $TEMPLATE_FILE"
    exit 1
fi

print_status "SUCCESS" "Template file found: $TEMPLATE_FILE"

# Validation counters
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0
WARNING_CHECKS=0

# Function to run a validation check
run_check() {
    local check_name="$1"
    local check_command="$2"
    local expected_result="$3"
    
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    
    if eval "$check_command" > /dev/null 2>&1; then
        if [ "$expected_result" = "pass" ]; then
            print_status "SUCCESS" "$check_name"
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
        else
            print_status "ERROR" "$check_name (Unexpected result)"
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
        fi
    else
        if [ "$expected_result" = "fail" ]; then
            print_status "SUCCESS" "$check_name"
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
        else
            print_status "ERROR" "$check_name"
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
        fi
    fi
}

# Function to run a warning check
run_warning_check() {
    local check_name="$1"
    local check_command="$2"
    
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    
    if eval "$check_command" > /dev/null 2>&1; then
        print_status "SUCCESS" "$check_name"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
    else
        print_status "WARNING" "$check_name"
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
}

echo "ðŸ“‹ Running Enterprise-Grade Template Validation..."
echo "------------------------------------------------"

# 1. Check for required sections
echo ""
echo "ðŸ” Checking Required Sections..."

run_check "Executive Summary section present" "grep -q '## ðŸ“Š Executive Summary' $TEMPLATE_FILE" "pass"
run_check "RFE section present" "grep -q '# ðŸ”§ \*\*REQUEST FOR ENHANCEMENTS' $TEMPLATE_FILE" "pass"
run_check "Bug section present" "grep -q '# ðŸ› \*\*ACTIVE BUG REPORTS' $TEMPLATE_FILE" "pass"
run_check "Closed cases section present" "grep -q '# ðŸ“ˆ \*\*CLOSED JIRA TICKET HISTORY' $TEMPLATE_FILE" "pass"
run_check "Component distribution section present" "grep -q '# ðŸ“Š \*\*COMPONENT DISTRIBUTION ANALYSIS' $TEMPLATE_FILE" "pass"
run_check "Strategic priorities section present" "grep -q '# ðŸŽ¯ \*\*STRATEGIC PRIORITIES' $TEMPLATE_FILE" "pass"
run_check "Quality assurance section present" "grep -q '# ðŸ” \*\*QUALITY ASSURANCE' $TEMPLATE_FILE" "pass"

# 2. Check for enterprise-grade features
echo ""
echo "ðŸ¢ Checking Enterprise-Grade Features..."

run_check "Validation status mentioned" "grep -q 'Validation Status.*Enterprise-Grade Accuracy' $TEMPLATE_FILE" "pass"
run_check "Business impact columns present" "grep -q 'Business Impact' $TEMPLATE_FILE" "pass"
run_check "Component organization present" "grep -q 'Component:' $TEMPLATE_FILE" "pass"
run_check "Severity levels defined" "grep -q 'Severity.*Impact' $TEMPLATE_FILE" "pass"
run_check "Quality assurance checklist present" "grep -q 'Validation Checklist' $TEMPLATE_FILE" "pass"

# 3. Check for proper formatting
echo ""
echo "ðŸ“ Checking Formatting Standards..."

run_check "Proper markdown table headers" "grep -q '| Case Number |' $TEMPLATE_FILE" "pass"
run_check "Proper markdown table separators" "grep -q '|-------------|' $TEMPLATE_FILE" "pass"
run_check "Consistent emoji usage" "grep -q 'ðŸ”§\|ðŸ›\|ðŸ“Š\|ðŸŽ¯\|ðŸ”' $TEMPLATE_FILE" "pass"
run_check "Professional language" "grep -q 'Enterprise-Grade\|Business Impact\|Strategic' $TEMPLATE_FILE" "pass"

# 4. Check for template variables
echo ""
echo "ðŸ”§ Checking Template Variables..."

run_check "Current date variable" "grep -q '{{ current_date }}' $TEMPLATE_FILE" "pass"
run_check "Case count variables" "grep -q '{{ total_active_cases }}' $TEMPLATE_FILE" "pass"
run_check "Component variables" "grep -q '{{ api_integration_count }}' $TEMPLATE_FILE" "pass"
run_check "Business impact variables" "grep -q '{{ case.business_impact' $TEMPLATE_FILE" "pass"

# 5. Check for validation features
echo ""
echo "ðŸ›¡ï¸ Checking Validation Features..."

run_check "Accuracy percentage mentioned" "grep -q '99%+' $TEMPLATE_FILE" "pass"
run_check "Validation results section" "grep -q 'Content Accuracy.*Enterprise-Grade' $TEMPLATE_FILE" "pass"
run_check "Validation checklist items" "grep -q 'Case numbers verified' $TEMPLATE_FILE" "pass"
run_check "Enterprise standards compliance" "grep -q 'Enterprise Standards Met' $TEMPLATE_FILE" "pass"

# 6. Check for professional presentation
echo ""
echo "ðŸ’¼ Checking Professional Presentation..."

run_check "Executive summary metrics" "grep -q 'Key Insights' $TEMPLATE_FILE" "pass"
run_check "Strategic priorities section" "grep -q 'High Priority Components' $TEMPLATE_FILE" "pass"
run_check "Business value alignment" "grep -q 'Business Value Alignment' $TEMPLATE_FILE" "pass"
run_check "Professional footer" "grep -q 'Automated Update via Red Hat' $TEMPLATE_FILE" "pass"

# 7. Check for JPMC-specific content
echo ""
echo "ðŸ¦ Checking JPMC-Specific Content..."

run_check "JPMC customer name" "grep -q 'JP Morgan Chase' $TEMPLATE_FILE" "pass"
run_check "JPMC account number" "grep -q 'Account Number.*334224' $TEMPLATE_FILE" "pass"
run_check "Financial industry context" "grep -q 'Regulatory Compliance\|Risk Mitigation' $TEMPLATE_FILE" "pass"

# Calculate accuracy score
ACCURACY_SCORE=$(echo "scale=2; $PASSED_CHECKS * 100 / $TOTAL_CHECKS" | bc -l)

echo ""
echo "ðŸ“Š Validation Results"
echo "===================="
echo ""
echo "Total Checks: $TOTAL_CHECKS"
echo "Passed: $PASSED_CHECKS"
echo "Failed: $FAILED_CHECKS"
echo "Warnings: $WARNING_CHECKS"
echo ""
echo "Accuracy Score: ${ACCURACY_SCORE}%"

# Determine validation status
if (( $(echo "$ACCURACY_SCORE >= 99" | bc -l) )); then
    VALIDATION_STATUS="ENTERPRISE_GRADE"
    STATUS_COLOR=$GREEN
    STATUS_ICON="âœ…"
elif (( $(echo "$ACCURACY_SCORE >= 95" | bc -l) )); then
    VALIDATION_STATUS="ACCEPTABLE"
    STATUS_COLOR=$YELLOW
    STATUS_ICON="âš ï¸"
else
    VALIDATION_STATUS="NEEDS_IMPROVEMENT"
    STATUS_COLOR=$RED
    STATUS_ICON="âŒ"
fi

echo ""
echo -e "${STATUS_COLOR}${STATUS_ICON} Template Validation Status: $VALIDATION_STATUS${NC}"

# Provide recommendations
echo ""
echo "ðŸ’¡ Recommendations:"
if [ $FAILED_CHECKS -gt 0 ]; then
    echo "   â€¢ Fix $FAILED_CHECKS failed validation checks"
fi
if [ $WARNING_CHECKS -gt 0 ]; then
    echo "   â€¢ Review $WARNING_CHECKS warning items"
fi
if (( $(echo "$ACCURACY_SCORE >= 99" | bc -l) )); then
    echo "   â€¢ Template meets enterprise-grade standards"
    echo "   â€¢ Ready for customer distribution"
    echo "   â€¢ Consider this template as the gold standard"
fi

echo ""
echo "ðŸ“‹ Next Steps:"
if (( $(echo "$ACCURACY_SCORE >= 99" | bc -l) )); then
    echo "   â€¢ Template is ready for use"
    echo "   â€¢ Integrate with RFE automation system"
    echo "   â€¢ Deploy for JPMC customer reports"
else
    echo "   â€¢ Address failed validation checks"
    echo "   â€¢ Re-run validation: ./bin/validate-jpmc-template"
    echo "   â€¢ Achieve 99%+ accuracy before deployment"
fi

# Return appropriate exit code
if (( $(echo "$ACCURACY_SCORE >= 99" | bc -l) )); then
    exit 0  # Success
elif (( $(echo "$ACCURACY_SCORE >= 95" | bc -l) )); then
    exit 2  # Warning
else
    exit 1  # Failure
fi
