#!/bin/bash

# pai-task-sync-cron - Automated PAI-Taskwarrior sync for cron execution
# Runs bidirectional sync with proper logging and error handling

set -euo pipefail

# Configuration
LOG_DIR="$HOME/.claude/context/logs"
SYNC_LOG="$LOG_DIR/pai-task-sync-cron.log"
ERROR_LOG="$LOG_DIR/pai-task-sync-error.log"
LOCK_FILE="/tmp/pai-task-sync.lock"

# Create log directory
mkdir -p "$LOG_DIR"

# Function to log with timestamp
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$SYNC_LOG"
}

# Function to log errors
log_error() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: $1" >> "$ERROR_LOG"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: $1" >> "$SYNC_LOG"
}

# Cleanup function
cleanup() {
    rm -f "$LOCK_FILE"
}

# Set trap for cleanup
trap cleanup EXIT

# Check if another sync is running
if [[ -f "$LOCK_FILE" ]]; then
    # Check if the process is actually running
    if kill -0 $(cat "$LOCK_FILE") 2>/dev/null; then
        log_message "Sync already running (PID: $(cat "$LOCK_FILE")), skipping"
        exit 0
    else
        log_message "Stale lock file found, removing"
        rm -f "$LOCK_FILE"
    fi
fi

# Create lock file
echo $$ > "$LOCK_FILE"

log_message "Starting automated PAI task sync"

# Set PATH to ensure pai-task-sync is found
export PATH="$HOME/.local/bin:$PATH"

# Check if pai-task-sync exists
if ! command -v pai-task-sync &> /dev/null; then
    log_error "pai-task-sync command not found in PATH"
    exit 1
fi

# Check if projects file exists
PROJECTS_FILE="$HOME/.claude/context/create/outputs/projects/projects.yaml"
if [[ ! -f "$PROJECTS_FILE" ]]; then
    log_error "Projects file not found: $PROJECTS_FILE"
    exit 1
fi

# Run the sync with timeout
if timeout 300 pai-task-sync bidirectional >> "$SYNC_LOG" 2>&1; then
    log_message "Sync completed successfully"

    # Log sync statistics
    PAI_TASKS=$(python3 -c "
import yaml
try:
    with open('$PROJECTS_FILE', 'r') as f:
        data = yaml.safe_load(f)
    if data and 'projects' in data:
        count = sum(len(project.get('tasks', [])) for project in data['projects'].values())
        print(count)
    else:
        print(0)
except:
    print(0)
" 2>/dev/null || echo "0")

    TW_PAI_TASKS=$(task export 2>/dev/null | python3 -c "
import json, sys
try:
    tasks = json.load(sys.stdin)
    count = len([t for t in tasks if t.get('tags') and 'pai' in t.get('tags', [])])
    print(count)
except:
    print(0)
" 2>/dev/null || echo "0")

    log_message "Sync stats: PAI tasks: $PAI_TASKS, Taskwarrior PAI tasks: $TW_PAI_TASKS"

else
    log_error "Sync failed or timed out"
    exit 1
fi

log_message "Automated sync cycle completed"