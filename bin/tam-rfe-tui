#!/bin/bash
# RFE Tools - Text User Interface
# Menu-driven interface for routine TAM workflows

set -euo pipefail

# Colors for non-dialog fallback
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_DIR="$HOME/.config/tam-rfe-tools"
CUSTOMERS_CONF="$CONFIG_DIR/customers.conf"
TAMSCRIPTS_CONFIG="$HOME/.config/tamscripts/tamscripts.config"

# Check if dialog is available
if command -v dialog &>/dev/null; then
    HAS_DIALOG=true
else
    HAS_DIALOG=false
fi

# Dialog wrapper
show_menu() {
    local title="$1"
    local text="$2"
    shift 2
    local options=("$@")
    
    if [ "$HAS_DIALOG" = true ]; then
        dialog --clear --title "$title" --menu "$text" 20 70 10 "${options[@]}" 2>&1 >/dev/tty
    else
        # Fallback to simple menu
        echo -e "${BOLD}=== $title ===${NC}"
        echo "$text"
        echo ""
        for ((i=0; i<${#options[@]}; i+=2)); do
            echo "  ${options[i]}. ${options[i+1]}"
        done
        echo ""
        read -p "Select option: " choice
        echo "$choice"
    fi
}

show_msgbox() {
    local title="$1"
    local text="$2"
    
    if [ "$HAS_DIALOG" = true ]; then
        dialog --clear --title "$title" --msgbox "$text" 15 70
    else
        echo -e "${BOLD}=== $title ===${NC}"
        echo "$text"
        read -p "Press Enter to continue..."
    fi
}

show_inputbox() {
    local title="$1"
    local text="$2"
    local default="${3:-}"
    
    if [ "$HAS_DIALOG" = true ]; then
        dialog --clear --title "$title" --inputbox "$text" 10 70 "$default" 2>&1 >/dev/tty
    else
        echo -e "${BOLD}=== $title ===${NC}"
        echo "$text"
        read -p "> " -e -i "$default" input
        echo "$input"
    fi
}

show_yesno() {
    local title="$1"
    local text="$2"
    
    if [ "$HAS_DIALOG" = true ]; then
        dialog --clear --title "$title" --yesno "$text" 10 70
        return $?
    else
        echo -e "${BOLD}=== $title ===${NC}"
        echo "$text"
        read -p "Continue? [y/N]: " -n 1 -r
        echo
        [[ $REPLY =~ ^[Yy]$ ]]
    fi
}

show_infobox() {
    local text="$1"
    
    if [ "$HAS_DIALOG" = true ]; then
        dialog --clear --infobox "$text" 5 50
        sleep 1
    else
        echo -e "${BLUE}ℹ️  $text${NC}"
    fi
}

# Get system status
get_status() {
    local status=""
    
    # Check rhcase
    if command -v rhcase &>/dev/null; then
        if rhcase --version &>/dev/null; then
            status+="✅ rhcase: Available"
        else
            status+="⚠️  rhcase: Not authenticated"
        fi
    else
        status+="❌ rhcase: Not installed"
    fi
    
    # Check customers
    if [ -f "$CUSTOMERS_CONF" ]; then
        local count=$(grep -c ":" "$CUSTOMERS_CONF" 2>/dev/null || echo "0")
        status+=" | $count customers"
    else
        status+=" | 0 customers"
    fi
    
    # Check scheduler daemon
    if pgrep -f "tam-rfe-scheduler-daemon" &>/dev/null; then
        status+=" | Scheduler: Running"
    else
        status+=" | Scheduler: Stopped"
    fi
    
    echo "$status"
}

# Main Menu
main_menu() {
    while true; do
        local status=$(get_status)
        
        choice=$(show_menu "RFE Tools Control Panel - Sys Admin Edition" \
            "Status: $status\n\nSelect an option:" \
            "1" "Customer Management" \
            "2" "Case Intelligence" \
            "3" "Report Scheduler" \
            "4" "Customer Discovery" \
            "5" "System Status" \
            "6" "Advanced (CLI Mode)" \
            "Q" "Quit")
        
        case "$choice" in
            1) customer_management_menu ;;
            2) case_intelligence_menu ;;
            3) report_scheduler_menu ;;
            4) customer_discovery_menu ;;
            5) system_status_menu ;;
            6) advanced_cli_mode ;;
            Q|q) exit 0 ;;
            "") exit 0 ;;
        esac
    done
}

# Customer Management Menu
customer_management_menu() {
    while true; do
        # Get current customers
        local customers=""
        if [ -f "$CUSTOMERS_CONF" ]; then
            customers=$(awk -F: '{printf "  %-15s %-30s %s\n", $1, $2, $3}' "$CUSTOMERS_CONF" 2>/dev/null || echo "  No customers configured")
        else
            customers="  No customers configured"
        fi
        
        choice=$(show_menu "Customer Management" \
            "Current Customers:\n$customers\n\nSelect an option:" \
            "1" "Onboard New Customer (Intelligent)" \
            "2" "Onboard New Customer (Manual)" \
            "3" "View Customer Details" \
            "4" "Validate Customer Configuration" \
            "5" "Remove Customer" \
            "B" "Back to Main Menu")
        
        case "$choice" in
            1) onboard_customer_intelligent ;;
            2) onboard_customer_manual ;;
            3) view_customer_details ;;
            4) validate_customer ;;
            5) remove_customer ;;
            B|b|"") return ;;
        esac
    done
}

# Intelligent Customer Onboarding
onboard_customer_intelligent() {
    show_infobox "Launching intelligent onboarding..."
    
    # Check if dialog is available for better UX
    if [ "$HAS_DIALOG" = true ]; then
        clear
        echo -e "${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${BOLD}║        Intelligent Customer Onboarding - Step 1/3         ║${NC}"
        echo -e "${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
        echo ""
    fi
    
    # Run tam-rfe-onboard-intelligent
    if [ -x "$SCRIPT_DIR/tam-rfe-onboard-intelligent" ]; then
        "$SCRIPT_DIR/tam-rfe-onboard-intelligent"
        local result=$?
        
        if [ $result -eq 0 ]; then
            show_msgbox "Success" "Customer onboarded successfully!\n\nNext steps:\n• View cases: Case Intelligence menu\n• Schedule reports: Report Scheduler menu\n• Validate setup: System Status menu"
        else
            show_msgbox "Error" "Onboarding failed or was cancelled."
        fi
    else
        show_msgbox "Error" "tam-rfe-onboard-intelligent not found.\n\nPlease ensure RFE tools are properly installed."
    fi
}

# Manual Customer Onboarding
onboard_customer_manual() {
    local shortname=$(show_inputbox "Manual Onboarding - Step 1/4" "Enter customer short name (e.g., 'acme'):")
    [ -z "$shortname" ] && return
    
    local fullname=$(show_inputbox "Manual Onboarding - Step 2/4" "Enter full customer name:")
    [ -z "$fullname" ] && return
    
    local account=$(show_inputbox "Manual Onboarding - Step 3/4" "Enter account number:")
    [ -z "$account" ] && return
    
    local products=$(show_inputbox "Manual Onboarding - Step 4/4" "Enter products (comma-separated, e.g., 'OpenShift,Ansible'):")
    [ -z "$products" ] && products="unknown"
    
    # Add to customers.conf
    mkdir -p "$CONFIG_DIR"
    echo "$shortname:$fullname:$account:$products" >> "$CUSTOMERS_CONF"
    
    show_msgbox "Success" "Customer added to configuration.\n\nCustomer: $fullname\nAccount: $account\nProducts: $products\n\nNote: You may need to manually update tamscripts.config for rhcase access."
}

# View Customer Details
view_customer_details() {
    if [ ! -f "$CUSTOMERS_CONF" ] || [ ! -s "$CUSTOMERS_CONF" ]; then
        show_msgbox "No Customers" "No customers are configured.\n\nUse 'Onboard New Customer' to add customers."
        return
    fi
    
    # Build customer list for menu
    local options=()
    local i=1
    while IFS=: read -r shortname fullname account products; do
        options+=("$i" "$shortname - $fullname")
        ((i++))
    done < "$CUSTOMERS_CONF"
    options+=("B" "Back")
    
    choice=$(show_menu "Customer Details" "Select a customer to view:" "${options[@]}")
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -le "${#options[@]}" ]; then
        local line=$(sed -n "${choice}p" "$CUSTOMERS_CONF")
        IFS=: read -r shortname fullname account products <<< "$line"
        
        local details="Short Name: $shortname\nFull Name: $fullname\nAccount: $account\nProducts: $products"
        
        # Check if in tamscripts.config
        if [ -f "$TAMSCRIPTS_CONFIG" ] && grep -q "account_numbers:\s*- '$account'" "$TAMSCRIPTS_CONFIG" 2>/dev/null; then
            details+="\n\n✅ Configured in tamscripts.config"
        else
            details+="\n\n⚠️  Not found in tamscripts.config"
        fi
        
        show_msgbox "Customer Details: $shortname" "$details"
    fi
}

# Validate Customer Configuration
validate_customer() {
    show_infobox "Running validation..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-validate-intelligence" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-validate-intelligence"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-validate-intelligence not found."
    fi
}

# Remove Customer
remove_customer() {
    if [ ! -f "$CUSTOMERS_CONF" ] || [ ! -s "$CUSTOMERS_CONF" ]; then
        show_msgbox "No Customers" "No customers are configured."
        return
    fi
    
    # Build customer list
    local options=()
    local i=1
    while IFS=: read -r shortname fullname account products; do
        options+=("$i" "$shortname - $fullname")
        ((i++))
    done < "$CUSTOMERS_CONF"
    options+=("B" "Back")
    
    choice=$(show_menu "Remove Customer" "Select a customer to remove:" "${options[@]}")
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -le "${#options[@]}" ]; then
        local line=$(sed -n "${choice}p" "$CUSTOMERS_CONF")
        IFS=: read -r shortname fullname account products <<< "$line"
        
        if show_yesno "Confirm Removal" "Remove customer: $fullname ($shortname)?\n\nThis will remove from customers.conf only.\nYou may need to manually update tamscripts.config."; then
            # Cross-platform sed
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' "${choice}d" "$CUSTOMERS_CONF"
            else
                sed -i "${choice}d" "$CUSTOMERS_CONF"
            fi
            show_msgbox "Success" "Customer removed: $fullname"
        fi
    fi
}

# Case Intelligence Menu
case_intelligence_menu() {
    while true; do
        choice=$(show_menu "Case Intelligence" \
            "View and analyze customer cases\n\nSelect an option:" \
            "1" "View All Cases (Table)" \
            "2" "View Cases by Customer" \
            "3" "View Sev 1 Cases (All Customers)" \
            "4" "Natural Language Query (Advanced)" \
            "5" "Case Similarity Search" \
            "B" "Back to Main Menu")
        
        case "$choice" in
            1) view_all_cases ;;
            2) view_cases_by_customer ;;
            3) view_sev1_cases ;;
            4) natural_language_query ;;
            5) case_similarity_search ;;
            B|b|"") return ;;
        esac
    done
}

# View Cases by Customer
view_cases_by_customer() {
    if [ ! -f "$CUSTOMERS_CONF" ] || [ ! -s "$CUSTOMERS_CONF" ]; then
        show_msgbox "No Customers" "No customers are configured.\n\nUse Customer Management to add customers."
        return
    fi
    
    # Build customer list
    local options=()
    local i=1
    while IFS=: read -r shortname fullname account products; do
        options+=("$i" "$shortname - $fullname")
        ((i++))
    done < "$CUSTOMERS_CONF"
    options+=("B" "Back")
    
    choice=$(show_menu "Select Customer" "Which customer's cases do you want to view?" "${options[@]}")
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -le "${#options[@]}" ]; then
        local line=$(sed -n "${choice}p" "$CUSTOMERS_CONF")
        IFS=: read -r shortname fullname account products <<< "$line"
        
        show_infobox "Fetching cases for $fullname..."
        
        if [ -x "$SCRIPT_DIR/tam-rfe-chat" ]; then
            clear
            echo -e "${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
            echo -e "${BOLD}║          $fullname - Open Cases          ║${NC}"
            echo -e "${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
            echo ""
            "$SCRIPT_DIR/tam-rfe-chat" "Show all $shortname cases"
            echo ""
            read -p "Press Enter to continue..."
        else
            show_msgbox "Error" "tam-rfe-chat not found."
        fi
    fi
}

# View All Cases
view_all_cases() {
    show_infobox "Fetching all cases..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-chat" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-chat" "Show all cases for all customers"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-chat not found."
    fi
}

# View Sev 1 Cases
view_sev1_cases() {
    show_infobox "Fetching Sev 1 cases..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-chat" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-chat" "Show all Sev 1 cases"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-chat not found."
    fi
}

# Natural Language Query
natural_language_query() {
    local query=$(show_inputbox "Natural Language Query" "Enter your query (e.g., 'Show Westpac OpenShift cases from last month'):")
    
    [ -z "$query" ] && return
    
    show_infobox "Processing query..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-chat" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-chat" "$query"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-chat not found."
    fi
}

# Case Similarity Search
case_similarity_search() {
    local case_number=$(show_inputbox "Case Similarity Search" "Enter case number to find similar cases:")
    
    [ -z "$case_number" ] && return
    
    show_infobox "Searching for similar cases..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-chat" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-chat" "Find cases similar to $case_number"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-chat not found."
    fi
}

# Report Scheduler Menu
report_scheduler_menu() {
    while true; do
        # Check daemon status
        local daemon_status="Stopped"
        local daemon_pid=""
        if pgrep -f "tam-rfe-scheduler-daemon" &>/dev/null; then
            daemon_pid=$(pgrep -f "tam-rfe-scheduler-daemon")
            daemon_status="Running (PID $daemon_pid)"
        fi
        
        # Count schedules
        local schedule_count=0
        if [ -f "$HOME/.config/tam-rfe-scheduler/schedules.yaml" ]; then
            schedule_count=$(grep -c "^  - id:" "$HOME/.config/tam-rfe-scheduler/schedules.yaml" 2>/dev/null || echo "0")
        fi
        
        choice=$(show_menu "Report Scheduler" \
            "Daemon: $daemon_status\nActive Schedules: $schedule_count\n\nSelect an option:" \
            "1" "Add New Schedule (Wizard)" \
            "2" "Add New Schedule (Advanced/CLI)" \
            "3" "List Schedules" \
            "4" "Run Schedule Manually" \
            "5" "Remove Schedule" \
            "6" "View Logs" \
            "7" "Daemon Control (Start/Stop/Restart)" \
            "B" "Back to Main Menu")
        
        case "$choice" in
            1) add_schedule_wizard ;;
            2) add_schedule_advanced ;;
            3) list_schedules ;;
            4) run_schedule_manual ;;
            5) remove_schedule ;;
            6) view_scheduler_logs ;;
            7) daemon_control ;;
            B|b|"") return ;;
        esac
    done
}

# Add Schedule Wizard
add_schedule_wizard() {
    # Step 1: Name
    local name=$(show_inputbox "Schedule Wizard - Step 1/5" "Enter a name for this schedule:")
    [ -z "$name" ] && return
    
    # Step 2: Report Type
    local report_type=$(show_menu "Schedule Wizard - Step 2/5" "What type of report?" \
        "1" "Customer case summary" \
        "2" "Sev 1 alert" \
        "3" "Portfolio overview" \
        "4" "Custom command")
    [ -z "$report_type" ] && return
    
    local command=""
    case "$report_type" in
        1)
            # Customer case summary - need to select customer
            if [ ! -f "$CUSTOMERS_CONF" ] || [ ! -s "$CUSTOMERS_CONF" ]; then
                show_msgbox "Error" "No customers configured. Please onboard customers first."
                return
            fi
            
            local options=()
            local i=1
            while IFS=: read -r shortname fullname account products; do
                options+=("$i" "$shortname - $fullname")
                ((i++))
            done < "$CUSTOMERS_CONF"
            
            local customer_choice=$(show_menu "Schedule Wizard - Step 3/5" "Select customer:" "${options[@]}")
            [ -z "$customer_choice" ] && return
            
            local line=$(sed -n "${customer_choice}p" "$CUSTOMERS_CONF")
            IFS=: read -r shortname fullname account products <<< "$line"
            
            command="tam-rfe-chat 'Show $shortname cases last 7 days'"
            ;;
        2)
            command="tam-rfe-chat 'Show all Sev 1 cases'"
            ;;
        3)
            command="tam-rfe-discover-customers-hydra my-portfolio"
            ;;
        4)
            command=$(show_inputbox "Custom Command" "Enter command to execute:")
            [ -z "$command" ] && return
            ;;
    esac
    
    # Step 4: Frequency
    local frequency=$(show_menu "Schedule Wizard - Step 4/5" "How often should this run?" \
        "1" "Daily (9am)" \
        "2" "Weekly (Monday 8am)" \
        "3" "Hourly" \
        "4" "Custom (cron expression)")
    [ -z "$frequency" ] && return
    
    local cron=""
    case "$frequency" in
        1) cron="0 9 * * *" ;;
        2) cron="0 8 * * 1" ;;
        3) cron="0 * * * *" ;;
        4)
            cron=$(show_inputbox "Custom Cron" "Enter cron expression (e.g., '0 9 * * *'):")
            [ -z "$cron" ] && return
            ;;
    esac
    
    # Step 5: Delivery
    local email=$(show_inputbox "Schedule Wizard - Step 5/5" "Enter email address:" "jbyrd@redhat.com")
    [ -z "$email" ] && return
    
    # Confirm
    if show_yesno "Confirm Schedule" "Create schedule?\n\nName: $name\nCommand: $command\nFrequency: $cron\nEmail: $email"; then
        if command -v tam-rfe-schedule &>/dev/null; then
            tam-rfe-schedule add "$name" --command "$command" --frequency "$cron" --email "$email"
            show_msgbox "Success" "Schedule created successfully!\n\nName: $name\nNext: Use 'Daemon Control' to start scheduler"
        else
            show_msgbox "Error" "tam-rfe-schedule command not found."
        fi
    fi
}

# Add Schedule Advanced (CLI)
add_schedule_advanced() {
    show_infobox "Launching CLI scheduler..."
    clear
    echo -e "${BOLD}Advanced Schedule Creation${NC}"
    echo "Use tam-rfe-schedule to create a schedule with full control."
    echo ""
    echo "Example:"
    echo "  tam-rfe-schedule add \"Report Name\" \\"
    echo "    --command \"tam-rfe-chat 'query'\" \\"
    echo "    --frequency \"0 9 * * *\" \\"
    echo "    --email jbyrd@redhat.com \\"
    echo "    --template weekly_digest"
    echo ""
    read -p "Press Enter to continue..."
}

# List Schedules
list_schedules() {
    if command -v tam-rfe-schedule &>/dev/null; then
        clear
        tam-rfe-schedule list
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-schedule command not found."
    fi
}

# Run Schedule Manually
run_schedule_manual() {
    local schedule_id=$(show_inputbox "Run Schedule" "Enter schedule ID to run:")
    [ -z "$schedule_id" ] && return
    
    show_infobox "Running schedule: $schedule_id..."
    
    if command -v tam-rfe-schedule &>/dev/null; then
        clear
        tam-rfe-schedule run "$schedule_id"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-schedule command not found."
    fi
}

# Remove Schedule
remove_schedule() {
    local schedule_id=$(show_inputbox "Remove Schedule" "Enter schedule ID to remove:")
    [ -z "$schedule_id" ] && return
    
    if show_yesno "Confirm Removal" "Remove schedule: $schedule_id?"; then
        if command -v tam-rfe-schedule &>/dev/null; then
            tam-rfe-schedule remove "$schedule_id"
            show_msgbox "Success" "Schedule removed: $schedule_id"
        else
            show_msgbox "Error" "tam-rfe-schedule command not found."
        fi
    fi
}

# View Scheduler Logs
view_scheduler_logs() {
    if command -v tam-rfe-schedule &>/dev/null; then
        clear
        tam-rfe-schedule logs
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-schedule command not found."
    fi
}

# Daemon Control
daemon_control() {
    local action=$(show_menu "Daemon Control" "Control the scheduler daemon:" \
        "1" "Start Daemon" \
        "2" "Stop Daemon" \
        "3" "Restart Daemon" \
        "4" "View Status" \
        "B" "Back")
    
    case "$action" in
        1)
            if command -v tam-rfe-schedule &>/dev/null; then
                tam-rfe-schedule start
                show_msgbox "Success" "Daemon started"
            else
                show_msgbox "Error" "tam-rfe-schedule command not found."
            fi
            ;;
        2)
            if command -v tam-rfe-schedule &>/dev/null; then
                tam-rfe-schedule stop
                show_msgbox "Success" "Daemon stopped"
            else
                show_msgbox "Error" "tam-rfe-schedule command not found."
            fi
            ;;
        3)
            if command -v tam-rfe-schedule &>/dev/null; then
                tam-rfe-schedule restart
                show_msgbox "Success" "Daemon restarted"
            else
                show_msgbox "Error" "tam-rfe-schedule command not found."
            fi
            ;;
        4)
            if command -v tam-rfe-schedule &>/dev/null; then
                clear
                tam-rfe-schedule status
                echo ""
                read -p "Press Enter to continue..."
            else
                show_msgbox "Error" "tam-rfe-schedule command not found."
            fi
            ;;
    esac
}

# Customer Discovery Menu
customer_discovery_menu() {
    while true; do
        choice=$(show_menu "Customer Discovery" \
            "Discover customers in your portfolio\n\nSelect an option:" \
            "1" "Discover by Region" \
            "2" "Discover by Organization (NAPS/Commercial)" \
            "3" "Search by Name" \
            "4" "View My Portfolio" \
            "B" "Back to Main Menu")
        
        case "$choice" in
            1) discover_by_region ;;
            2) discover_by_organization ;;
            3) search_by_name ;;
            4) view_portfolio ;;
            B|b|"") return ;;
        esac
    done
}

# Discover by Region
discover_by_region() {
    local region=$(show_menu "Discover by Region" "Select region:" \
        "1" "APAC" \
        "2" "EMEA" \
        "3" "NAMER" \
        "4" "LATAM")
    
    local region_name=""
    case "$region" in
        1) region_name="APAC" ;;
        2) region_name="EMEA" ;;
        3) region_name="NAMER" ;;
        4) region_name="LATAM" ;;
        *) return ;;
    esac
    
    show_infobox "Discovering customers in $region_name..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-discover-customers-hydra" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-discover-customers-hydra" geo "$region_name"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-discover-customers-hydra not found."
    fi
}

# Discover by Organization
discover_by_organization() {
    local org=$(show_menu "Discover by Organization" "Select organization type:" \
        "1" "NAPS (North American Public Sector)" \
        "2" "Commercial")
    
    local org_name=""
    case "$org" in
        1) org_name="NAPS" ;;
        2) org_name="Commercial" ;;
        *) return ;;
    esac
    
    show_infobox "Discovering $org_name customers..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-hydra-api" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-hydra-api" org "$org_name"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-hydra-api not found."
    fi
}

# Search by Name
search_by_name() {
    local search_term=$(show_inputbox "Search by Name" "Enter customer name to search:")
    [ -z "$search_term" ] && return
    
    show_infobox "Searching for: $search_term..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-discover-customers" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-discover-customers" search "$search_term"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-discover-customers not found."
    fi
}

# View Portfolio
view_portfolio() {
    show_infobox "Fetching portfolio..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-discover-customers-hydra" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-discover-customers-hydra" my-portfolio
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-discover-customers-hydra not found."
    fi
}

# System Status Menu
system_status_menu() {
    while true; do
        choice=$(show_menu "System Status" \
            "View system configuration and status\n\nSelect an option:" \
            "1" "Show Full Status" \
            "2" "Run Full Validation" \
            "3" "Clear rhcase Cache" \
            "4" "View Detailed Logs" \
            "B" "Back to Main Menu")
        
        case "$choice" in
            1) show_full_status ;;
            2) run_full_validation ;;
            3) clear_rhcase_cache ;;
            4) view_detailed_logs ;;
            B|b|"") return ;;
        esac
    done
}

# Show Full Status
show_full_status() {
    clear
    echo -e "${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}║                      System Status                         ║${NC}"
    echo -e "${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # rhcase
    echo -e "${BOLD}Configuration:${NC}"
    if command -v rhcase &>/dev/null; then
        echo -e "  ✅ rhcase: Available"
        if rhcase --version &>/dev/null; then
            local principal=$(klist 2>/dev/null | grep "Default principal:" | cut -d: -f2 | xargs || echo "Unknown")
            echo -e "     Authenticated as: $principal"
        fi
    else
        echo -e "  ❌ rhcase: Not installed"
    fi
    
    # Customers
    if [ -f "$CUSTOMERS_CONF" ]; then
        local count=$(grep -c ":" "$CUSTOMERS_CONF" 2>/dev/null || echo "0")
        echo -e "  ✅ customers.conf: $count customers configured"
    else
        echo -e "  ⚠️  customers.conf: Not found"
    fi
    
    # tamscripts.config
    if [ -f "$TAMSCRIPTS_CONFIG" ]; then
        echo -e "  ✅ tamscripts.config: Configured"
    else
        echo -e "  ⚠️  tamscripts.config: Not found"
    fi
    
    # Scheduler
    if pgrep -f "tam-rfe-scheduler-daemon" &>/dev/null; then
        local pid=$(pgrep -f "tam-rfe-scheduler-daemon")
        echo -e "  ✅ Scheduler daemon: Running (PID $pid)"
    else
        echo -e "  ⚠️  Scheduler daemon: Stopped"
    fi
    
    echo ""
    read -p "Press Enter to continue..."
}

# Run Full Validation
run_full_validation() {
    show_infobox "Running full validation..."
    
    if [ -x "$SCRIPT_DIR/tam-rfe-validate-intelligence" ]; then
        clear
        "$SCRIPT_DIR/tam-rfe-validate-intelligence"
        echo ""
        read -p "Press Enter to continue..."
    else
        show_msgbox "Error" "tam-rfe-validate-intelligence not found."
    fi
}

# Clear rhcase Cache
clear_rhcase_cache() {
    if show_yesno "Clear Cache" "This will clear the rhcase cache.\n\nContinue?"; then
        rm -rf ~/.rhcase/cache
        show_msgbox "Success" "rhcase cache cleared"
    fi
}

# View Detailed Logs
view_detailed_logs() {
    local log_choice=$(show_menu "View Logs" "Select log to view:" \
        "1" "Scheduler Daemon Log" \
        "2" "Scheduler Execution History" \
        "3" "System Log (journalctl)" \
        "B" "Back")
    
    case "$log_choice" in
        1)
            if [ -f "$HOME/.config/tam-rfe-scheduler/logs/daemon.log" ]; then
                clear
                tail -50 "$HOME/.config/tam-rfe-scheduler/logs/daemon.log"
                echo ""
                read -p "Press Enter to continue..."
            else
                show_msgbox "Error" "Daemon log not found"
            fi
            ;;
        2)
            if [ -f "$HOME/.config/tam-rfe-scheduler/logs/execution_history.jsonl" ]; then
                clear
                tail -20 "$HOME/.config/tam-rfe-scheduler/logs/execution_history.jsonl" | jq -r '. | "\(.timestamp) | \(.schedule_id) | \(.status)"' 2>/dev/null || tail -20 "$HOME/.config/tam-rfe-scheduler/logs/execution_history.jsonl"
                echo ""
                read -p "Press Enter to continue..."
            else
                show_msgbox "Error" "Execution history not found"
            fi
            ;;
        3)
            clear
            journalctl --user -u tam-rfe-scheduler -n 50 --no-pager 2>/dev/null || echo "System journal not available"
            echo ""
            read -p "Press Enter to continue..."
            ;;
    esac
}

# Advanced CLI Mode
advanced_cli_mode() {
    show_msgbox "Advanced CLI Mode" "Dropping to CLI mode.\n\nYou can now use natural language queries directly.\n\nExamples:\n• tam-rfe-chat 'Show all Westpac cases'\n• tam-rfe-schedule add ...\n• tam-rfe-discover-customers-hydra geo APAC\n\nType 'exit' to return to TUI."
    
    clear
    echo -e "${BOLD}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BOLD}║                    Advanced CLI Mode                       ║${NC}"
    echo -e "${BOLD}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Tip: All tam-rfe-* commands are available."
    echo "Type 'exit' to return to TUI."
    echo ""
    
    bash
}

# Main entry point
main() {
    # Clear screen
    clear
    
    # Check if dialog available but warn
    if [ "$HAS_DIALOG" = false ]; then
        echo -e "${YELLOW}⚠️  'dialog' not found. Using basic text menus.${NC}"
        echo -e "   Install dialog for better UI: ${BOLD}sudo dnf install dialog${NC}"
        echo ""
        sleep 2
    fi
    
    # Run main menu
    main_menu
}

# Run
main "$@"
