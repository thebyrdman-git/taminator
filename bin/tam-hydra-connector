#!/usr/bin/env python3

"""
TAM RFE Hydra API Connector
Interfaces with Red Hat Hydra API for organizational customer discovery
"""

import json
import os
import sys
import subprocess
from pathlib import Path
from typing import Optional, Dict, List
import urllib.request
import urllib.error
import yaml

class HydraConnector:
    def __init__(self):
        self.config_file = Path.home() / ".config" / "tamscripts" / "tamscripts.config"
        self.config = self.load_config()
        self.base_url = self.config.get('hydra', {}).get('base_url', 'https://hydra.engineering.redhat.com')
        self.username = self.config.get('auth', {}).get('username', 'unknown')
        self.token = None
        
    def load_config(self) -> Dict:
        """Load tamscripts configuration"""
        try:
            with open(self.config_file, 'r') as f:
                return yaml.safe_load(f)
        except Exception as e:
            print(f"âŒ Error loading config from {self.config_file}: {e}", file=sys.stderr)
            return {}
    
    def get_auth_token(self) -> Optional[str]:
        """Get OAuth token from Red Hat SSO"""
        if self.token:
            return self.token
            
        # Check if rhcase can provide token
        try:
            # rhcase handles OAuth authentication
            result = subprocess.run(
                ['rhcase', '--version'],
                capture_output=True,
                text=True,
                timeout=5
            )
            if result.returncode == 0:
                print("âœ… Using rhcase authentication", file=sys.stderr)
                # Token will be handled by rhcase's auth mechanism
                return "rhcase-managed"
        except Exception as e:
            print(f"âš ï¸  Could not verify rhcase auth: {e}", file=sys.stderr)
            
        return None
    
    def make_request(self, endpoint: str, params: Optional[Dict] = None) -> Optional[Dict]:
        """Make authenticated request to Hydra API"""
        url = f"{self.base_url}{endpoint}"
        
        if params:
            query_string = '&'.join([f"{k}={v}" for k, v in params.items()])
            url = f"{url}?{query_string}"
        
        try:
            # For now, attempt basic request
            # In production, this would use OAuth token from rhcase
            req = urllib.request.Request(url)
            req.add_header('User-Agent', 'TAM-RFE-Automation/1.0')
            
            with urllib.request.urlopen(req, timeout=10) as response:
                return json.loads(response.read().decode('utf-8'))
                
        except urllib.error.URLError as e:
            if 'Could not resolve host' in str(e):
                print("âŒ Cannot reach Hydra API. Are you connected to Red Hat VPN?", file=sys.stderr)
            else:
                print(f"âŒ Hydra API error: {e}", file=sys.stderr)
            return None
        except Exception as e:
            print(f"âŒ Request failed: {e}", file=sys.stderr)
            return None
    
    def get_my_customers(self) -> List[Dict]:
        """Get customers assigned to this TAM"""
        print(f"ğŸ” Fetching customer portfolio for: {self.username}")
        
        # Hydra API endpoint for TAM assignments
        # Actual endpoint TBD - this is the interface structure
        endpoint = f"/api/v1/tam/{self.username}/customers"
        
        result = self.make_request(endpoint)
        if result:
            return result.get('customers', [])
        return []
    
    def get_org_customers(self, org: str) -> List[Dict]:
        """Get all customers in an organization (e.g., NAPS)"""
        print(f"ğŸ” Fetching customers for organization: {org}")
        
        # Hydra API endpoint for org-based customer lists
        endpoint = f"/api/v1/organizations/{org}/customers"
        
        result = self.make_request(endpoint)
        if result:
            return result.get('customers', [])
        return []
    
    def get_geo_customers(self, geo: str) -> List[Dict]:
        """Get all customers in a geographic region"""
        print(f"ğŸ” Fetching customers for region: {geo}")
        
        # Hydra API endpoint for geo-based customer lists
        endpoint = f"/api/v1/regions/{geo}/customers"
        
        result = self.make_request(endpoint)
        if result:
            return result.get('customers', [])
        return []
    
    def search_customer(self, search_term: str) -> List[Dict]:
        """Search for customers by name"""
        print(f"ğŸ” Searching Hydra for: {search_term}")
        
        endpoint = "/api/v1/customers/search"
        params = {'q': search_term}
        
        result = self.make_request(endpoint, params)
        if result:
            return result.get('results', [])
        return []
    
    def get_customer_details(self, account_number: str) -> Optional[Dict]:
        """Get detailed information about a specific customer"""
        print(f"ğŸ” Fetching details for account: {account_number}")
        
        endpoint = f"/api/v1/customers/{account_number}"
        
        return self.make_request(endpoint)

def format_customer(customer: Dict) -> str:
    """Format customer information for display"""
    lines = []
    lines.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    lines.append(f"ğŸ¢ Customer: {customer.get('name', 'Unknown')}")
    lines.append(f"   Account #: {customer.get('accountNumber', 'Unknown')}")
    
    if 'organization' in customer:
        lines.append(f"   Organization: {customer['organization']}")
    if 'geo' in customer:
        lines.append(f"   Region: {customer['geo']}")
    if 'vertical' in customer:
        lines.append(f"   Vertical: {customer['vertical']}")
    if 'tam' in customer:
        lines.append(f"   TAM: {customer['tam']}")
    if 'csm' in customer:
        lines.append(f"   CSM: {customer['csm']}")
    
    lines.append("")
    return "\n".join(lines)

def main():
    import argparse
    
    parser = argparse.ArgumentParser(
        description='Hydra API Connector for TAM Customer Discovery',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s my-portfolio              # Get your assigned customers
  %(prog)s org NAPS                  # Get all NAPS customers
  %(prog)s org Commercial            # Get all Commercial customers
  %(prog)s geo NAMER                 # Get all North America customers
  %(prog)s search "Acme Corp"        # Search for customer
  %(prog)s account 123456            # Get account details

Note: Requires Red Hat VPN connection and valid authentication
        """
    )
    
    parser.add_argument('command', choices=[
        'my-portfolio', 'org', 'geo', 'search', 'account', 'test'
    ], help='Command to execute')
    
    parser.add_argument('argument', nargs='?', help='Command argument (org name, geo, search term, account number)')
    
    args = parser.parse_args()
    
    connector = HydraConnector()
    
    # Test connectivity
    if args.command == 'test':
        print("ğŸ” Testing Hydra API connectivity...")
        print(f"   Base URL: {connector.base_url}")
        print(f"   Username: {connector.username}")
        token = connector.get_auth_token()
        if token:
            print(f"   Auth: âœ… Token available")
        else:
            print(f"   Auth: âš ï¸  No token (may still work with rhcase)")
        
        # Try a test request
        result = connector.make_request("/api/v1/health")
        if result:
            print("   Connection: âœ… Hydra API reachable")
        else:
            print("   Connection: âŒ Cannot reach Hydra API")
            print("\nğŸ’¡ Make sure you're connected to Red Hat VPN")
        return
    
    # Execute commands
    customers = []
    
    if args.command == 'my-portfolio':
        customers = connector.get_my_customers()
        
    elif args.command == 'org':
        if not args.argument:
            print("âŒ Error: Organization name required", file=sys.stderr)
            print("Example: tam-rfe-hydra-connector org NAPS", file=sys.stderr)
            sys.exit(1)
        customers = connector.get_org_customers(args.argument)
        
    elif args.command == 'geo':
        if not args.argument:
            print("âŒ Error: Geographic region required", file=sys.stderr)
            print("Example: tam-rfe-hydra-connector geo NAMER", file=sys.stderr)
            sys.exit(1)
        customers = connector.get_geo_customers(args.argument)
        
    elif args.command == 'search':
        if not args.argument:
            print("âŒ Error: Search term required", file=sys.stderr)
            print("Example: tam-rfe-hydra-connector search 'Acme Corp'", file=sys.stderr)
            sys.exit(1)
        customers = connector.search_customer(args.argument)
        
    elif args.command == 'account':
        if not args.argument:
            print("âŒ Error: Account number required", file=sys.stderr)
            print("Example: tam-rfe-hydra-connector account 123456", file=sys.stderr)
            sys.exit(1)
        customer = connector.get_customer_details(args.argument)
        if customer:
            print(format_customer(customer))
        return
    
    # Display results
    if customers:
        print(f"\nâœ… Found {len(customers)} customer(s):\n")
        for customer in customers:
            print(format_customer(customer))
        
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("\nğŸ’¡ To add any customer to your automation:")
        print("   ./bin/tam-rfe-onboard-intelligent\n")
    else:
        print("âš ï¸  No customers found (or API unavailable)")
        print("\nğŸ’¡ Troubleshooting:")
        print("   â€¢ Check Red Hat VPN connection")
        print("   â€¢ Verify authentication: ./bin/tam-rfe-hydra-connector test")
        print("   â€¢ Try case-based discovery: ./bin/tam-rfe-discover-customers list")

if __name__ == '__main__':
    main()

