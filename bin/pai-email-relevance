#!/usr/bin/env bash
set -euo pipefail

# PAI Email Relevance Analysis
# Reviews recent emails for TAM relevance using internal granite model

DAYS="${1:-1}"
MAX_EMAILS="${2:-50}"
FABRIC_MODEL="${EMAIL_RELEVANCE_MODEL:-remote-local-granite-3-2-8b-instruct}"
OUTPUT_DIR="$HOME/.claude/context/create/outputs/email/relevance"

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

# Function to URL encode subject for Gmail links
url_encode_subject() {
    local subject="$1"
    # Replace spaces with + and encode special characters for Gmail search
    echo "$subject" | sed 's/ /+/g' | sed 's/[^a-zA-Z0-9+]/%&/g'
}

# Function to process emails and check relevance
analyze_email_relevance() {
    local date_str=$(date +%Y-%m-%d)
    local output_file="$OUTPUT_DIR/email-relevance-$date_str.md"
    
    echo "Analyzing email relevance for last $DAYS day(s)..."
    echo "Using internal granite model: $FABRIC_MODEL"
    
    # Get recent emails using pai-email-processor
    if command -v pai-email-processor >/dev/null 2>&1; then
        echo "Processing recent emails..."
        local email_data=$(pai-email-processor process "$DAYS" "$MAX_EMAILS" 2>/dev/null)
        
        if [[ -n "$email_data" ]]; then
            # Create analysis using fabric pattern with granite model
            local analysis_prompt="Analyze these recent emails for TAM relevance:

$email_data

Focus on emails related to:
- Customer accounts: BNY, CIBC, Citi, Discover, Wells Fargo
- Products: OpenShift, RHACM, RHACS, OpenShift Pipelines, Red Hat Developer Hub
- Strategic projects: AI TAM, Security TAM, TAM Lab GPU
- Case numbers and technical issues
- Security concerns

Exclude emails from support@redhat.com unless they indicate customer escalations."

            echo "Running relevance analysis with granite model..."
            local relevance_analysis=$(echo "$analysis_prompt" | fabric -p tam_email_relevance -m "$FABRIC_MODEL" 2>/dev/null || echo "Analysis failed - check fabric configuration")
            
            # Create output file
            cat > "$output_file" << REPORT_EOF
---
title: Email Relevance Analysis ($date_str)
generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
days_analyzed: $DAYS
max_emails: $MAX_EMAILS
model: $FABRIC_MODEL
tags: [email, relevance, tam, daily]
---

# Email Relevance Analysis - $date_str

## Analysis Period
- **Days**: Last $DAYS day(s)
- **Max Emails**: $MAX_EMAILS
- **Model**: $FABRIC_MODEL (Internal Red Hat Granite)

## Relevance Assessment

$relevance_analysis

## Search Links
For relevant emails, use these Gmail search links to access full threads:
- Format: https://mail.google.com/mail/#search/[subject-keywords]
- Click links to open specific email threads in Gmail

## Action Items
Review HIGH relevance emails for:
- Customer communications requiring response
- Case updates needing attention  
- Strategic project developments
- Security issues requiring escalation

---
Generated by pai-email-relevance at $(date -u +%Y-%m-%dT%H:%M:%SZ)
REPORT_EOF
            
            echo "Email relevance analysis saved to: $output_file"
            
            # Also output to terminal for immediate review
            cat "$output_file"
            
            # Log the analysis
            pai-audit log "EMAIL_RELEVANCE_ANALYSIS" "Analyzed $DAYS days of emails with granite model"
            
        else
            echo "No email data available for analysis"
        fi
    else
        echo "Error: pai-email-processor not available"
        exit 1
    fi
}

# Command dispatch
case "${1:-analyze}" in
    analyze)
        shift 2>/dev/null || true
        days="${1:-1}"
        max="${2:-50}"
        analyze_email_relevance "$days" "$max"
        ;;
    help|--help|-h)
        cat << 'HELP'
PAI Email Relevance Analysis Tool

Usage: pai-email-relevance [command] [days] [max_emails]

Commands:
  analyze [days] [max]     Analyze recent emails for TAM relevance (default)
  help                     Show this help

Examples:
  pai-email-relevance                    # Analyze last day, max 50 emails
  pai-email-relevance analyze 2 30       # Last 2 days, max 30 emails
  pai-email-relevance analyze 7 100      # Weekly review, max 100 emails

Features:
  - Uses internal Red Hat granite model for analysis
  - Identifies customer, product, and project relevance
  - Generates Gmail search links for relevant emails
  - Creates structured reports for daily briefing integration
  - Excludes support@redhat.com unless customer escalations

Output: ~/.claude/context/create/outputs/email/relevance/
HELP
        ;;
    *)
        analyze_email_relevance "$1" "${2:-50}"
        ;;
esac
