#!/usr/bin/env python3
"""
TAM RFE Clear Customers
Clear customer configurations with backup and safety checks
"""

import sys
import shutil
from pathlib import Path
from datetime import datetime
import yaml
import argparse

# Configuration
CONFIG_DIR = Path.home() / ".config" / "rfe-tool"
CUSTOMERS_CONF = CONFIG_DIR / "customers.conf"
TAMSCRIPTS_CONFIG = CONFIG_DIR / "tamscripts.config"
BACKUP_DIR = CONFIG_DIR / "backups"

# Colors
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
NC = '\033[0m'


def print_header():
    print("=" * 70)
    print("TAM RFE Clear Customers")
    print("=" * 70)
    print()


def print_success(msg):
    print(f"{GREEN}[OK]{NC} {msg}")


def print_error(msg):
    print(f"{RED}[FAIL]{NC} {msg}")


def print_warning(msg):
    print(f"{YELLOW}[WARN]{NC} {msg}")


def print_info(msg):
    print(f"{BLUE}[INFO]{NC} {msg}")


def list_customers():
    """List all configured customers"""
    customers = []
    
    if TAMSCRIPTS_CONFIG.exists():
        with open(TAMSCRIPTS_CONFIG) as f:
            config = yaml.safe_load(f) or {}
        customers = config.get('customers', [])
    
    return customers


def show_clear_preview():
    """Show what will be cleared"""
    print_warning("This will clear the following:")
    print()
    
    if CUSTOMERS_CONF.exists():
        content = CUSTOMERS_CONF.read_text()
        customer_count = content.count("CUSTOMER_")
        print(f"  ðŸ“„ customers.conf: ~{customer_count} customer entries")
    else:
        print(f"  ðŸ“„ customers.conf: (not found)")
    
    customers = list_customers()
    if customers:
        print(f"  ðŸ“„ tamscripts.config: {len(customers)} customers")
        print()
        print("  Customers:")
        for cust in customers[:10]:  # Show first 10
            print(f"    - {cust.get('account_name', 'Unknown')} ({cust.get('customer_shortname', 'unknown')})")
        if len(customers) > 10:
            print(f"    ... and {len(customers) - 10} more")
    else:
        print(f"  ðŸ“„ tamscripts.config: (no customers found)")
    
    print()


def create_backup():
    """Create backup of current configs"""
    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")
    backup_path = BACKUP_DIR / timestamp
    backup_path.mkdir(parents=True, exist_ok=True)
    
    backed_up = []
    
    if CUSTOMERS_CONF.exists():
        shutil.copy(CUSTOMERS_CONF, backup_path / "customers.conf")
        backed_up.append("customers.conf")
    
    if TAMSCRIPTS_CONFIG.exists():
        shutil.copy(TAMSCRIPTS_CONFIG, backup_path / "tamscripts.config")
        backed_up.append("tamscripts.config")
    
    if backed_up:
        print_success(f"Backup created: {backup_path}")
        for file in backed_up:
            print(f"  âœ“ {file}")
        return backup_path
    else:
        print_warning("No config files to backup")
        return None


def clear_customers():
    """Clear all customer configurations"""
    # Clear customers.conf
    if CUSTOMERS_CONF.exists():
        header = f"""# TAM RFE Automation - Customer Configuration
# All customers cleared on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
# Backup available in: {BACKUP_DIR}/

"""
        CUSTOMERS_CONF.write_text(header)
        print_success("Cleared customers.conf")
    
    # Clear tamscripts.config
    if TAMSCRIPTS_CONFIG.exists():
        with open(TAMSCRIPTS_CONFIG) as f:
            config = yaml.safe_load(f) or {}
        
        # Keep other config, just clear customers
        config['customers'] = []
        config['cleared_date'] = datetime.now().isoformat()
        config['cleared_by'] = 'tam-rfe-clear-customers'
        
        with open(TAMSCRIPTS_CONFIG, 'w') as f:
            yaml.dump(config, f, default_flow_style=False, sort_keys=False)
        
        print_success("Cleared tamscripts.config")


def clear_single_customer(short_name):
    """Remove a single customer"""
    print(f"Removing customer: {short_name}")
    print()
    
    removed = False
    
    # Remove from customers.conf
    if CUSTOMERS_CONF.exists():
        content = CUSTOMERS_CONF.read_text()
        lines = content.split('\n')
        new_lines = []
        skip_next = False
        
        for line in lines:
            if f'CUSTOMER_{short_name.upper()}' in line or f'# {short_name}' in line.lower():
                skip_next = True
                continue
            if skip_next and line.strip() == '':
                skip_next = False
                continue
            new_lines.append(line)
        
        CUSTOMERS_CONF.write_text('\n'.join(new_lines))
        print_success(f"Removed from customers.conf")
        removed = True
    
    # Remove from tamscripts.config
    if TAMSCRIPTS_CONFIG.exists():
        with open(TAMSCRIPTS_CONFIG) as f:
            config = yaml.safe_load(f) or {}
        
        customers = config.get('customers', [])
        original_count = len(customers)
        
        customers = [c for c in customers if c.get('customer_shortname') != short_name]
        
        if len(customers) < original_count:
            config['customers'] = customers
            
            with open(TAMSCRIPTS_CONFIG, 'w') as f:
                yaml.dump(config, f, default_flow_style=False, sort_keys=False)
            
            print_success(f"Removed from tamscripts.config")
            removed = True
    
    if removed:
        print()
        print_success(f"Customer '{short_name}' removed successfully")
    else:
        print_error(f"Customer '{short_name}' not found")
        return False
    
    return True


def main():
    parser = argparse.ArgumentParser(description='Clear customer configurations')
    parser.add_argument('--all', action='store_true', help='Clear all customers')
    parser.add_argument('--customer', type=str, help='Clear specific customer (short name)')
    parser.add_argument('--dry-run', action='store_true', help='Show what would be cleared')
    parser.add_argument('--no-backup', action='store_true', help='Skip backup (NOT RECOMMENDED)')
    parser.add_argument('--list', action='store_true', help='List all customers')
    
    args = parser.parse_args()
    
    print_header()
    
    # List customers
    if args.list:
        customers = list_customers()
        if customers:
            print(f"Configured customers ({len(customers)}):")
            print()
            for cust in customers:
                print(f"  - {cust.get('account_name', 'Unknown'):40} ({cust.get('customer_shortname', 'unknown')})")
        else:
            print("No customers configured")
        print()
        return
    
    # Clear single customer
    if args.customer:
        if args.dry_run:
            print_info(f"[DRY RUN] Would remove customer: {args.customer}")
            return
        
        if not args.no_backup:
            create_backup()
            print()
        
        clear_single_customer(args.customer)
        return
    
    # Clear all customers
    if args.all:
        show_clear_preview()
        
        if args.dry_run:
            print_info("[DRY RUN] No changes made")
            return
        
        print_warning("âš ï¸  WARNING: This will remove ALL customer configurations!")
        print()
        print("Type 'DELETE ALL' to confirm (or Ctrl+C to cancel): ", end='')
        
        try:
            response = input()
        except KeyboardInterrupt:
            print()
            print("Cancelled")
            return
        
        if response != "DELETE ALL":
            print("Cancelled - confirmation text did not match")
            return
        
        print()
        
        # Create backup (unless skipped)
        if not args.no_backup:
            backup_path = create_backup()
            print()
        
        # Clear customers
        clear_customers()
        
        print()
        print_success("All customers cleared!")
        if not args.no_backup:
            print()
            print(f"Backup location: {backup_path}")
            print("To restore: tam-rfe-restore-customers " + backup_path.name)
        print()
        return
    
    # No action specified
    parser.print_help()
    print()
    print("Examples:")
    print("  tam-rfe-clear-customers --list")
    print("  tam-rfe-clear-customers --customer westpac")
    print("  tam-rfe-clear-customers --all --dry-run")
    print("  tam-rfe-clear-customers --all")
    print()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print()
        print("Interrupted by user")
        sys.exit(1)
    except Exception as e:
        print()
        print_error(f"Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

