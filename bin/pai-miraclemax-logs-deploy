#!/bin/bash
# pai-miraclemax-logs-deploy - Deploy Loki Log Aggregation Stack
# Part of PAI MiracleMax Infrastructure Management

set -euo pipefail

# Configuration
MIRACLEMAX_HOST="jbyrd@192.168.1.34"
REPO_DIR="/home/jbyrd/pai/repositories/pai-infrastructure-automation/miraclemax"
LOG_FILE="/tmp/miraclemax-logs-deploy-$(date +%Y%m%d-%H%M%S).log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Functions
log_info() {
    echo -e "${BLUE}â–¸${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}âœ“${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}âš ${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}âœ—${NC} $1" | tee -a "$LOG_FILE"
}

deploy_failed() {
    log_error "Deployment failed. Check log: $LOG_FILE"
    exit 1
}

# Banner
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  MiracleMax Log Aggregation Deployment"
echo "  Loki + Promtail for Enterprise-Grade Logging"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Step 1: Validate connectivity
log_info "Step 1/6: Validating connectivity to $MIRACLEMAX_HOST..."
if ssh "$MIRACLEMAX_HOST" "echo 'Connection OK'" >/dev/null 2>&1; then
    log_success "Connected to $MIRACLEMAX_HOST"
else
    log_error "Cannot connect to $MIRACLEMAX_HOST"
    deploy_failed
fi

# Step 2: Create monitoring network if needed
log_info "Step 2/6: Ensuring monitoring network exists..."
if ssh "$MIRACLEMAX_HOST" "podman network inspect monitoring-network >/dev/null 2>&1"; then
    log_success "monitoring-network already exists"
else
    log_info "Creating monitoring-network..."
    ssh "$MIRACLEMAX_HOST" "podman network create monitoring-network" || deploy_failed
    log_success "Created monitoring-network"
fi

# Step 3: Sync configuration files
log_info "Step 3/6: Syncing Loki/Promtail configurations..."
rsync -az --delete \
    "$REPO_DIR/config/loki/" \
    "$MIRACLEMAX_HOST:/home/jbyrd/miraclemax-infrastructure/config/loki/" || deploy_failed

rsync -az --delete \
    "$REPO_DIR/config/promtail/" \
    "$MIRACLEMAX_HOST:/home/jbyrd/miraclemax-infrastructure/config/promtail/" || deploy_failed

rsync -az \
    "$REPO_DIR/compose/loki.yml" \
    "$MIRACLEMAX_HOST:/home/jbyrd/miraclemax-infrastructure/compose/" || deploy_failed

rsync -az \
    "$REPO_DIR/compose/promtail.yml" \
    "$MIRACLEMAX_HOST:/home/jbyrd/miraclemax-infrastructure/compose/" || deploy_failed

log_success "Configurations and compose files synced"

# Step 4: Deploy Loki
log_info "Step 4/6: Deploying Loki log aggregation service..."
ssh "$MIRACLEMAX_HOST" "cd /home/jbyrd/miraclemax-infrastructure/compose && podman-compose -f loki.yml down 2>/dev/null || true" >> "$LOG_FILE" 2>&1
ssh "$MIRACLEMAX_HOST" "cd /home/jbyrd/miraclemax-infrastructure/compose && podman-compose -f loki.yml up -d" || deploy_failed

# Wait for Loki to be healthy
log_info "Waiting for Loki to become healthy..."
for i in {1..30}; do
    if ssh "$MIRACLEMAX_HOST" "curl -sf http://localhost:3100/ready >/dev/null 2>&1"; then
        log_success "Loki is healthy"
        break
    fi
    if [ $i -eq 30 ]; then
        log_error "Loki failed to become healthy"
        deploy_failed
    fi
    sleep 2
done

# Step 5: Deploy Promtail
log_info "Step 5/6: Deploying Promtail log collection agent..."
ssh "$MIRACLEMAX_HOST" "cd /home/jbyrd/miraclemax-infrastructure/compose && podman-compose -f promtail.yml down 2>/dev/null || true" >> "$LOG_FILE" 2>&1
ssh "$MIRACLEMAX_HOST" "cd /home/jbyrd/miraclemax-infrastructure/compose && podman-compose -f promtail.yml up -d" || deploy_failed

# Wait for Promtail to be healthy
log_info "Waiting for Promtail to become healthy..."
for i in {1..30}; do
    if ssh "$MIRACLEMAX_HOST" "curl -sf http://localhost:9080/ready >/dev/null 2>&1"; then
        log_success "Promtail is healthy"
        break
    fi
    if [ $i -eq 30 ]; then
        log_error "Promtail failed to become healthy"
        deploy_failed
    fi
    sleep 2
done

# Step 6: Reload Prometheus to pick up new scrape targets
log_info "Step 6/6: Reloading Prometheus configuration..."
ssh "$MIRACLEMAX_HOST" "curl -X POST http://localhost:9090/-/reload" >> "$LOG_FILE" 2>&1 || log_warning "Failed to reload Prometheus (non-critical)"

# Step 7: Reload Grafana to pick up Loki datasource
log_info "Reloading Grafana datasources..."
ssh "$MIRACLEMAX_HOST" "podman restart grafana" >> "$LOG_FILE" 2>&1 || log_warning "Failed to restart Grafana (non-critical)"

# Summary
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log_success "Log Aggregation Stack Deployed Successfully!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š Access Points:"
echo "  â€¢ Loki API:     https://loki.jbyrd.org"
echo "  â€¢ Grafana:      https://grafana.jbyrd.org"
echo "  â€¢ Real-time:    https://logs.jbyrd.org (Dozzle)"
echo ""
echo "ğŸ” Quick Tests:"
echo "  â€¢ Check Loki:     curl -s https://loki.jbyrd.org/ready"
echo "  â€¢ Check Promtail: ssh miraclemax 'podman logs promtail --tail 20'"
echo "  â€¢ Query logs:     Use Grafana Explore â†’ Select 'Loki' datasource"
echo ""
echo "ğŸ“ˆ Prometheus Metrics:"
echo "  â€¢ Loki:     http://loki:3100/metrics"
echo "  â€¢ Promtail: http://promtail:9080/metrics"
echo ""
echo "ğŸ“ Example LogQL Queries (use in Grafana):"
echo '  â€¢ All containers:     {job="containers"}'
echo '  â€¢ Specific service:   {service="traefik"}'
echo '  â€¢ Error logs:         {job="containers"} |= "error"'
echo '  â€¢ n8n workflows:      {container_name="n8n"}'
echo ""
echo "Log file: $LOG_FILE"
echo ""

