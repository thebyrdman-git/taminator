#!/bin/bash

# PAI Context Creation Tool
# Automatically creates new contexts with beautiful visual progress bars
# PRIORITY #1: VISUALLY STUNNING interface for all PAI work

set -euo pipefail

# Configuration
PAI_ROOT="/home/jbyrd/hatter-pai"
CONTEXTS_DIR="$PAI_ROOT/contexts"
BIN_DIR="$PAI_ROOT/bin"
TEMPLATES_DIR="$PAI_ROOT/templates"

# Colors and visual elements
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Visual excellence emojis
SPARKLES='âœ¨'
ROCKET='ğŸš€'
RAINBOW='ğŸŒˆ'
DIAMOND='ğŸ’'
STAR='â­'
MAGIC='ğŸª„'

show_stunning_header() {
    echo
    echo -e "${BOLD}${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘${NC} ${BOLD}${CYAN}${MAGIC} PAI CONTEXT CREATOR - VISUALLY STUNNING ${MAGIC} ${BOLD}${MAGENTA}â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘${NC} ${DIM}Priority #1: Beautiful, elegant, stunning interfaces${NC} ${BOLD}${MAGENTA}â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo
}

show_help() {
    show_stunning_header
    cat << EOF
${BOLD}${CYAN}USAGE:${NC}
    pai-context-create <context-name> [options]

${BOLD}${CYAN}OPTIONS:${NC}
    --description TEXT   Brief description of the context
    --focus AREAS       Primary focus areas (comma-separated)
    --tools LIST        Initial tools to create (comma-separated)
    --visual-theme      Visual theme (default: rainbow)
    --help, -h          Show this stunning help

${BOLD}${CYAN}EXAMPLES:${NC}
    pai-context-create smart-home --description "IoT management" --focus "automation,monitoring"
    pai-context-create finance --description "Personal finance tracking" --tools "budget,expense"

${BOLD}${YELLOW}VISUAL EXCELLENCE GUARANTEE:${NC}
Every context created includes:
${SPARKLES} Beautiful Unicode progress bars with animations
${RAINBOW} Color-coded status indicators and themes  
${DIAMOND} Elegant headers with box-drawing characters
${STAR} Emoji-enhanced feedback and summaries
${ROCKET} Stunning visual feedback for all operations

EOF
}

# Create stunning progress bar for context creation
create_context_progress_bar() {
    local context_name="$1"
    local context_name_clean="${context_name//-/_}"
    
    cat > "$BIN_DIR/pai-${context_name}-progress-bar" << EOF
#!/bin/bash

# PAI ${context_name^} Beautiful Progress Bar System
# PRIORITY #1: VISUALLY STUNNING interface
# Enhanced visual progress tracking for ${context_name} operations

# Colors and visual excellence
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Beautiful Unicode characters
FULL_BLOCK='â–ˆ'
THREE_FOURTHS_BLOCK='â–Š'
HALF_BLOCK='â–Œ'
ONE_FOURTH_BLOCK='â–'
EMPTY_BLOCK=' '

# ${context_name^}-specific emojis and visual elements
${context_name_clean}_EMOJI='${SPARKLES}'
SUCCESS_EMOJI='âœ…'
ERROR_EMOJI='âŒ'
WARNING_EMOJI='âš ï¸'
PROCESSING_EMOJI='ğŸ”„'

# Show stunning progress bar with ${context_name} theming
show_${context_name_clean}_progress() {
    local current="\${1:-0}"
    local total="\${2:-100}"
    local task="\${3:-Processing}"
    local width="\${4:-50}"
    local show_percentage="\${5:-true}"
    
    # Calculate percentage
    local percentage=\$((current * 100 / total))
    
    # Calculate filled blocks
    local filled=\$((current * width / total))
    local partial=\$((current * width % total))
    
    # Build stunning progress bar
    local bar=""
    local i
    
    # Full blocks
    for ((i = 0; i < filled; i++)); do
        bar+="\${FULL_BLOCK}"
    done
    
    # Partial block for smooth animation
    if [[ \$partial -gt 0 && \$filled -lt \$width ]]; then
        if [[ \$partial -ge 75 ]]; then
            bar+="\${THREE_FOURTHS_BLOCK}"
        elif [[ \$partial -ge 50 ]]; then
            bar+="\${HALF_BLOCK}"
        elif [[ \$partial -ge 25 ]]; then
            bar+="\${ONE_FOURTH_BLOCK}"
        fi
        ((filled++))
    fi
    
    # Empty blocks
    for ((i = filled; i < \$width; i++)); do
        bar+="\${EMPTY_BLOCK}"
    done
    
    # Rainbow color progression for visual excellence
    local color
    if [[ \$percentage -ge 100 ]]; then
        color="\$GREEN"
    elif [[ \$percentage -ge 80 ]]; then
        color="\$CYAN"
    elif [[ \$percentage -ge 60 ]]; then
        color="\$BLUE"
    elif [[ \$percentage -ge 40 ]]; then
        color="\$MAGENTA"
    elif [[ \$percentage -ge 20 ]]; then
        color="\$YELLOW"
    else
        color="\$RED"
    fi
    
    # Percentage display
    local pct_display=""
    if [[ "\$show_percentage" == "true" ]]; then
        pct_display=" \${percentage}%"
    fi
    
    # Display the stunning progress bar
    printf "\r\${BOLD}\${task}\${NC} [\${color}\${bar}\${NC}]\${pct_display} (\${current}/\${total})"
    
    # New line when complete
    if [[ \$current -eq \$total ]]; then
        printf "\n"
    fi
}

# Beautiful header for ${context_name} operations
show_${context_name_clean}_header() {
    local title="\${1:-${context_name^} Operations}"
    local subtitle="\${2:-}"
    
    echo
    echo -e "\${BOLD}\${MAGENTA}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\${NC}"
    printf "\${BOLD}\${MAGENTA}â”‚\${NC} \${BOLD}\${CYAN}\${${context_name_clean}_EMOJI} %-45s \${MAGENTA}â”‚\${NC}\n" "\$title"
    
    if [[ -n "\$subtitle" ]]; then
        printf "\${BOLD}\${MAGENTA}â”‚\${NC} \${DIM}%-47s \${MAGENTA}â”‚\${NC}\n" "\$subtitle"
    fi
    
    echo -e "\${BOLD}\${MAGENTA}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\${NC}"
    echo
}

# Show operation status with stunning visuals
show_${context_name_clean}_status() {
    local operation="\${1:-Unknown Operation}"
    local status="\${2:-processing}"
    local details="\${3:-}"
    
    local emoji
    local color
    
    case "\$status" in
        "processing"|"running")
            emoji="\$PROCESSING_EMOJI"
            color="\$YELLOW"
            ;;
        "complete"|"success")
            emoji="\$SUCCESS_EMOJI"
            color="\$GREEN"
            ;;
        "error"|"failed")
            emoji="\$ERROR_EMOJI"
            color="\$RED"
            ;;
        "warning")
            emoji="\$WARNING_EMOJI"
            color="\$CYAN"
            ;;
    esac
    
    printf "\${emoji} \${BOLD}\${operation}\${NC} - \${color}\${status}\${NC}"
    
    if [[ -n "\$details" ]]; then
        printf " - \${DIM}\${details}\${NC}"
    fi
    
    printf "\n"
}

# Stunning summary display
show_${context_name_clean}_summary() {
    local operations="\${1:-0}"
    local successes="\${2:-0}" 
    local errors="\${3:-0}"
    local custom_metric="\${4:-0}"
    local custom_label="\${5:-Items}"
    
    echo
    echo -e "\${BOLD}\${BLUE}ğŸ“Š OPERATION SUMMARY\${NC}"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    if [[ \$operations -gt 0 ]]; then
        echo -e "\${PROCESSING_EMOJI} \${CYAN}Total operations:\${NC} \$operations"
    fi
    
    if [[ \$successes -gt 0 ]]; then
        echo -e "\${SUCCESS_EMOJI} \${GREEN}Successful:\${NC} \$successes"
    fi
    
    if [[ \$errors -gt 0 ]]; then
        echo -e "\${ERROR_EMOJI} \${RED}Errors:\${NC} \$errors"
    fi
    
    if [[ \$custom_metric -gt 0 ]]; then
        echo -e "\${${context_name_clean}_EMOJI} \${YELLOW}\${custom_label}:\${NC} \$custom_metric"
    fi
    
    echo
}

# Export functions for stunning visuals
export -f show_${context_name_clean}_progress
export -f show_${context_name_clean}_header
export -f show_${context_name_clean}_status
export -f show_${context_name_clean}_summary

# Demo if called directly
if [[ "\${BASH_SOURCE[0]}" == "\${0}" ]]; then
    show_${context_name_clean}_header "${context_name^} Progress Demo" "Testing stunning visual indicators"
    
    echo "Testing progress bar:"
    for i in {0..100..10}; do
        show_${context_name_clean}_progress "\$i" 100 "Processing ${context_name} operations" 40 true
        sleep 0.2
    done
    
    echo
    show_${context_name_clean}_status "Sample Operation" "complete" "Finished successfully"
    show_${context_name_clean}_summary 10 8 2 50 "Items Processed"
fi
EOF

    chmod +x "$BIN_DIR/pai-${context_name}-progress-bar"
    echo -e "${GREEN}${DIAMOND} Created stunning progress bar: pai-${context_name}-progress-bar${NC}"
}

# Create beautiful context from template
create_context() {
    local context_name="$1"
    local description="${2:-AI-powered automation system}"
    local focus_areas="${3:-automation,monitoring,optimization}"
    local tools="${4:-status,monitor,manage}"
    
    # Create context file from template
    local context_file="$CONTEXTS_DIR/${context_name}.md"
    local template_file="$TEMPLATES_DIR/pai-context-template.md"
    
    if [[ ! -f "$template_file" ]]; then
        echo -e "${ERROR_EMOJI} ${RED}Template file not found: $template_file${NC}"
        return 1
    fi
    
    # Replace template variables
    sed "s/{CONTEXT_NAME}/${context_name^}/g; \
         s/{context_name}/${context_name}/g; \
         s/{SYSTEM_DESCRIPTION}/${description}/g; \
         s/{PRIMARY_FOCUS_AREAS}/${focus_areas}/g; \
         s/{WORKFLOW_PRIORITIES}/Beautiful visual feedback and stunning user experience/g; \
         s/{INTEGRATION_POINTS}/Visual consistency across all PAI tools/g; \
         s/{CONTEXT_SPECIFIC_COMMANDS}/Context-specific voice commands/g; \
         s/{CURRENT_OBJECTIVES}/Establish visually stunning ${context_name} automation/g" \
         "$template_file" > "$context_file"
    
    echo -e "${GREEN}${SPARKLES} Created stunning context: ${context_name}.md${NC}"
    
    # Create beautiful progress bar
    create_context_progress_bar "$context_name"
    
    # Create basic tools with visual enhancement
    IFS=',' read -ra TOOLS_ARRAY <<< "$tools"
    for tool in "${TOOLS_ARRAY[@]}"; do
        create_stunning_tool "$context_name" "$tool"
    done
    
    return 0
}

# Create a tool with stunning visuals
create_stunning_tool() {
    local context_name="$1"
    local tool_name="$2"
    local tool_file="$BIN_DIR/pai-${context_name}-${tool_name}"
    
    cat > "$tool_file" << EOF
#!/bin/bash

# PAI ${context_name^} ${tool_name^} Tool
# PRIORITY #1: VISUALLY STUNNING interface
# Part of ${context_name} context automation

set -euo pipefail

# Beautiful progress bars
source "\$(dirname "\$0")/pai-${context_name}-progress-bar" 2>/dev/null || {
    show_${context_name//-/_}_progress() { echo "Progress: \$1/\$2 - \$3"; }
    show_${context_name//-/_}_header() { echo "=== \$1 ==="; }
    show_${context_name//-/_}_status() { echo "\$1: \$2"; }
    show_${context_name//-/_}_summary() { echo "Summary: \$1 operations"; }
}

show_help() {
    show_${context_name//-/_}_header "${context_name^} ${tool_name^}" "Visually stunning ${tool_name} operations"
    cat << 'HELP_EOF'
USAGE:
    pai-${context_name}-${tool_name} [options]

OPTIONS:
    --verbose           Show detailed visual output
    --help, -h          Show this beautiful help

EXAMPLES:
    pai-${context_name}-${tool_name} --verbose

This tool provides stunning visual feedback for all operations.
HELP_EOF
}

# Main function with beautiful visuals
main() {
    show_${context_name//-/_}_header "${context_name^} ${tool_name^}" "Beautiful ${tool_name} operations"
    
    # Simulate beautiful operation
    echo "Starting ${tool_name} operations..."
    for i in {1..10}; do
        show_${context_name//-/_}_progress "\$i" 10 "Processing ${tool_name}" 30 true
        sleep 0.1
    done
    
    show_${context_name//-/_}_status "${tool_name^} Operation" "complete" "Finished with stunning visuals"
    show_${context_name//-/_}_summary 10 10 0 100 "Items Processed"
}

# Parse arguments
while [[ \$# -gt 0 ]]; do
    case \$1 in
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: \$1"
            show_help >&2
            exit 1
            ;;
    esac
done

main "\$@"
EOF

    chmod +x "$tool_file"
    echo -e "${GREEN}${STAR} Created stunning tool: pai-${context_name}-${tool_name}${NC}"
}

# Main execution
main() {
    show_stunning_header
    
    if [[ $# -eq 0 ]]; then
        echo -e "${ERROR_EMOJI} ${RED}Context name required${NC}"
        show_help
        exit 1
    fi
    
    local context_name="$1"
    local description=""
    local focus_areas=""
    local tools=""
    
    shift
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --description)
                description="$2"
                shift 2
                ;;
            --focus)
                focus_areas="$2"
                shift 2
                ;;
            --tools)
                tools="$2"
                shift 2
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            *)
                echo -e "${ERROR_EMOJI} ${RED}Unknown option: $1${NC}"
                show_help >&2
                exit 1
                ;;
        esac
    done
    
    # Set defaults if not provided
    description="${description:-AI-powered ${context_name} automation system}"
    focus_areas="${focus_areas:-automation,monitoring,visual excellence}"
    tools="${tools:-status,monitor,manage}"
    
    echo -e "${ROCKET} ${BOLD}Creating visually stunning context: ${context_name}${NC}"
    echo -e "${DIAMOND} Description: ${description}"
    echo -e "${RAINBOW} Focus: ${focus_areas}"
    echo -e "${SPARKLES} Tools: ${tools}"
    echo
    
    # Create directories
    mkdir -p "$CONTEXTS_DIR" "$BIN_DIR" "$TEMPLATES_DIR"
    
    # Create the context
    if create_context "$context_name" "$description" "$focus_areas" "$tools"; then
        echo
        echo -e "âœ… ${GREEN}${BOLD}STUNNING CONTEXT CREATED SUCCESSFULLY!${NC}"
        echo -e "${SPARKLES} Context: ${CYAN}${context_name}${NC}"
        echo -e "${RAINBOW} Switch with: ${YELLOW}pai-context-switch ${context_name}${NC}"
        echo -e "${DIAMOND} All tools include beautiful visual progress bars!"
        echo
    else
        echo -e "${ERROR_EMOJI} ${RED}Failed to create context${NC}"
        exit 1
    fi
}

main "$@"
