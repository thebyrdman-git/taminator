#!/bin/bash

# YouTube API-powered sync for Charles's automation
# Uses terrysnuckers@gmail.com authenticated access

set -euo pipefail

# Configuration
STORAGE_DIR="/mnt/nfs_share/charles/youtube"
CONFIG_DIR="$HOME/.config/pai/youtube"
API_HELPER="$HOME/youtube-api-helper.py"
CREDENTIALS_FILE="$HOME/oauth_credentials.json"

echo "üé¨ YOUTUBE API AUTOMATION - CHARLES'S VIDEOS"
echo "============================================"
echo "Account: terrysnuckers@gmail.com (authenticated)"
echo "Storage: $STORAGE_DIR"
echo ""

# Ensure directories exist
sudo mkdir -p "$STORAGE_DIR"
mkdir -p "$CONFIG_DIR"
sudo chmod 777 "$STORAGE_DIR"

# Check dependencies
if ! command -v python3 >/dev/null 2>&1; then
    echo "‚ùå Python3 not found. Installing..."
    sudo apt update && sudo apt install -y python3 python3-pip
fi

# Use virtual environment for Python
PYTHON_BIN="$HOME/youtube-api-env/bin/python"
if [[ ! -f "$PYTHON_BIN" ]]; then
    echo "‚ùå Virtual environment not found. Please run setup first."
    exit 1
fi

# Check files exist
if [[ ! -f "$CREDENTIALS_FILE" ]]; then
    echo "‚ùå OAuth credentials not found: $CREDENTIALS_FILE"
    echo "üí° Make sure oauth_credentials.json is uploaded to the server"
    exit 1
fi

if [[ ! -f "$API_HELPER" ]]; then
    echo "‚ùå API helper not found: $API_HELPER"
    exit 1
fi

echo "üîê Getting subscriptions via YouTube API..."

# Get subscriptions from API using virtual environment  
subscriptions_output=$($PYTHON_BIN "$API_HELPER" subscriptions 2>&1)
subscriptions_json=$(echo "$subscriptions_output" | grep -A999 "^{" | head -n -0)

if [[ -z "$subscriptions_json" ]]; then
    echo "‚ùå Failed to get subscriptions from API"
    echo "üí° You may need to authenticate terrysnuckers@gmail.com"
    echo "üí° Run: python3 $API_HELPER subscriptions"
    exit 1
fi

echo "‚úÖ API access successful!"

# Parse and process subscriptions
echo "$subscriptions_json" > "$CONFIG_DIR/current_subscriptions.json"
total_channels=$(echo "$subscriptions_json" | jq -r '.subscriptions | length')

echo "üìä Found $total_channels subscribed channels"
echo ""

# Process each channel
current=0
success=0
total_downloaded=0

while IFS=$'\t' read -r channel_id channel_name channel_url; do
    ((current++))
    echo "üì∫ [$current/$total_channels] Processing: $channel_name"
    
    # Create channel directory
    safe_name=$(echo "$channel_name" | tr -cd '[:alnum:] ' | tr ' ' '_')
    channel_dir="$STORAGE_DIR/$safe_name"
    sudo mkdir -p "$channel_dir"
    sudo chmod 777 "$channel_dir"
    
    # Count existing videos
    before_count=$(find "$channel_dir" -name "*.mp4" 2>/dev/null | wc -l)
    
    # Download latest videos using yt-dlp
    echo "   üîÑ Downloading latest videos..."
    
    if yt-dlp \
        --format "best[height<=720]/best" \
        --output "$channel_dir/%(upload_date)s - %(title)s.%(ext)s" \
        --playlist-end 3 \
        --no-overwrites \
        --ignore-errors \
        --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
        --sleep-interval 1 \
        --max-sleep-interval 3 \
        "https://www.youtube.com/channel/$channel_id/videos" >/dev/null 2>&1; then
        
        # Count new videos
        after_count=$(find "$channel_dir" -name "*.mp4" 2>/dev/null | wc -l)
        new_videos=$((after_count - before_count))
        
        if [[ $new_videos -gt 0 ]]; then
            echo "   ‚úÖ Downloaded $new_videos videos"
            ((success++))
            ((total_downloaded += new_videos))
        else
            echo "   ‚ÑπÔ∏è  No new videos"
        fi
    else
        echo "   ‚ùå Download failed"
    fi
    
    # Brief pause
    sleep 2
    
done < <(echo "$subscriptions_json" | jq -r '.subscriptions[] | [.id, .name, .url] | @tsv')

# Fix permissions for Plex
echo ""
echo "üîß Setting final permissions for Plex..."
sudo chown -R plex:plex "$STORAGE_DIR"
sudo chmod -R 755 "$STORAGE_DIR"

# Summary
echo ""
echo "üéâ YOUTUBE API SYNC COMPLETE!"
echo "============================="
echo "Channels processed: $total_channels"
echo "Successful downloads: $success"
echo "Total videos downloaded: $total_downloaded"
echo "Storage: $STORAGE_DIR"
echo ""
echo "üìÅ Directory structure:"
ls -la "$STORAGE_DIR" | head -10

echo ""
echo "‚úÖ Ready for Plex to scan!"
echo "‚úÖ Authenticated API access working!"
echo "‚úÖ Charles's automation is LIVE! üöÄ"
