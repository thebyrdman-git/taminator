#!/usr/bin/env python3

"""
pai-contacts-label - Add labels to Google Workspace contacts
Purpose: Stdin/stdout tool for adding labels to contacts by email address
"""

import os
import sys
import json
import argparse
from pathlib import Path

try:
    from google.auth.transport.requests import Request
    from google.oauth2.credentials import Credentials
    from google_auth_oauthlib.flow import InstalledAppFlow
    from googleapiclient.discovery import build
    from googleapiclient.errors import HttpError
except ImportError:
    print("ERROR: Google API libraries not installed", file=sys.stderr)
    print("Install with: pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib", file=sys.stderr)
    sys.exit(1)

# Required scopes for modifying contacts and groups
SCOPES = ['https://www.googleapis.com/auth/contacts']

class ContactsLabeler:
    def __init__(self):
        self.service = None
        # Use existing Google OAuth credentials from secrets directory
        self.credentials_file = Path.home() / '.claude' / 'context' / 'secrets' / 'client_secret_604570179581-e7njihorvctfebcfi6k57jr9c1km18vs.apps.googleusercontent.com.json'
        self.token_file = Path.home() / '.claude' / 'context' / 'secrets' / 'google-contacts-token.json'

        # Ensure config directory exists
        self.credentials_file.parent.mkdir(parents=True, exist_ok=True)

        self.authenticate()

    def authenticate(self):
        """Authenticate with Google Workspace using OAuth2"""
        creds = None

        # Check for existing token
        if self.token_file.exists():
            creds = Credentials.from_authorized_user_file(str(self.token_file), SCOPES)

        # If no valid credentials, get new ones
        if not creds or not creds.valid:
            if creds and creds.expired and creds.refresh_token:
                try:
                    creds.refresh(Request())
                except Exception:
                    creds = None

            if not creds:
                if not self.credentials_file.exists():
                    print("ERROR: Google OAuth credentials file not found", file=sys.stderr)
                    print(f"Expected location: {self.credentials_file}", file=sys.stderr)
                    print("Download from Google Cloud Console and place there", file=sys.stderr)
                    sys.exit(1)

                flow = InstalledAppFlow.from_client_secrets_file(
                    str(self.credentials_file), SCOPES)
                creds = flow.run_local_server(port=0)

            # Save credentials for next run
            with open(self.token_file, 'w') as token:
                token.write(creds.to_json())

        self.service = build('people', 'v1', credentials=creds)

    def find_contact_by_email(self, email: str):
        """Find contact resource name by email address"""
        try:
            # Search for contact by email
            results = self.service.people().searchContacts(
                query=email,
                readMask='names,emailAddresses'
            ).execute()

            connections = results.get('results', [])

            for result in connections:
                person = result.get('person', {})
                email_addresses = person.get('emailAddresses', [])

                for email_addr in email_addresses:
                    if email_addr.get('value', '').lower() == email.lower():
                        return person.get('resourceName')

        except HttpError as e:
            print(f"ERROR: Failed to search contacts: {e}", file=sys.stderr)

        return None

    def find_or_create_contact_group(self, label_name: str):
        """Find existing contact group or create new one"""
        try:
            # List existing contact groups
            results = self.service.contactGroups().list().execute()
            contact_groups = results.get('contactGroups', [])

            # Look for existing group
            for group in contact_groups:
                if group.get('name') == label_name:
                    return group.get('resourceName')

            # Create new group if not found
            group_body = {
                'contactGroup': {
                    'name': label_name
                }
            }

            result = self.service.contactGroups().create(body=group_body).execute()
            return result.get('resourceName')

        except HttpError as e:
            print(f"ERROR: Failed to create/find contact group '{label_name}': {e}", file=sys.stderr)
            return None

    def add_contact_to_group(self, contact_resource_name: str, group_resource_name: str):
        """Add contact to group/label"""
        try:
            modify_body = {
                'resourceNamesToAdd': [contact_resource_name]
            }

            self.service.contactGroups().members().modify(
                resourceName=group_resource_name,
                body=modify_body
            ).execute()

            return True

        except HttpError as e:
            print(f"ERROR: Failed to add contact to group: {e}", file=sys.stderr)
            return False

    def create_contact(self, email: str):
        """Create a new contact with the given email address"""
        try:
            # Extract name from email if possible
            email_local = email.split('@')[0]
            if '.' in email_local:
                first_name = email_local.split('.')[0].capitalize()
                last_name = email_local.split('.')[1].capitalize()
            else:
                first_name = email_local.capitalize()
                last_name = ""

            contact_body = {
                'names': [{
                    'givenName': first_name,
                    'familyName': last_name
                }],
                'emailAddresses': [{
                    'value': email,
                    'type': 'work'
                }]
            }

            result = self.service.people().createContact(body=contact_body).execute()
            return result.get('resourceName')

        except HttpError as e:
            print(f"ERROR: Failed to create contact for {email}: {e}", file=sys.stderr)
            return None

    def label_contact(self, email: str, label: str):
        """Add label to contact by email address, creating contact if needed"""
        # Find contact
        contact_resource = self.find_contact_by_email(email)

        if not contact_resource:
            print(f"Contact not found for {email}, creating...", file=sys.stderr)
            contact_resource = self.create_contact(email)

            if not contact_resource:
                print(f"ERROR: Failed to create contact for {email}", file=sys.stderr)
                return False
            else:
                print(f"Created contact for {email}", file=sys.stderr)

        # Find or create label group
        group_resource = self.find_or_create_contact_group(label)
        if not group_resource:
            print(f"ERROR: Failed to create/find label '{label}'", file=sys.stderr)
            return False

        # Add contact to group
        success = self.add_contact_to_group(contact_resource, group_resource)
        if success:
            print(f"SUCCESS: Added {email} to label '{label}'")
            return True
        else:
            print(f"ERROR: Failed to add {email} to label '{label}'", file=sys.stderr)
            return False

def main():
    parser = argparse.ArgumentParser(
        description="Add labels to Google Workspace contacts",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Add single contact to label
  pai-contacts-label --label "TAM-BNY" john.doe@company.com

  # Process emails from stdin
  cat email_list.txt | pai-contacts-label --label "TAM-BNY"

  # Process with multiple labels
  echo "user@domain.com" | pai-contacts-label --label "TAM-BNY" --label "OpenShift"
        """
    )

    parser.add_argument('--label', action='append', required=True,
                       help='Label name to apply (can specify multiple)')
    parser.add_argument('email', nargs='?',
                       help='Email address (optional if using stdin)')

    args = parser.parse_args()

    # Initialize contacts labeler
    try:
        labeler = ContactsLabeler()
    except Exception as e:
        print(f"ERROR: Failed to initialize Google Contacts: {e}", file=sys.stderr)
        sys.exit(1)

    # Get emails to process
    emails = []

    if args.email:
        # Single email from command line
        emails = [args.email]
    else:
        # Read from stdin
        try:
            stdin_content = sys.stdin.read().strip()
            if stdin_content:
                emails = [line.strip() for line in stdin_content.split('\n') if line.strip()]
        except:
            pass

    if not emails:
        print("ERROR: No email addresses provided", file=sys.stderr)
        sys.exit(1)

    # Process each email
    success_count = 0
    error_count = 0

    for email in emails:
        if not email or '@' not in email:
            continue

        print(f"Processing: {email}", file=sys.stderr)

        # Apply each label
        email_success = True
        for label in args.label:
            if not labeler.label_contact(email, label):
                email_success = False

        if email_success:
            success_count += 1
            print(f"LABELED: {email}")
        else:
            error_count += 1
            print(f"FAILED: {email}")

    # Summary
    print(f"Summary: {success_count} successful, {error_count} failed", file=sys.stderr)

    if error_count > 0:
        sys.exit(1)

if __name__ == "__main__":
    main()