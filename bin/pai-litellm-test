#!/bin/bash

# pai-litellm-test - Test LiteLLM setup with Red Hat internal models
# Part of the PAI (Personal AI Infrastructure) System

set -euo pipefail

# Configuration
CONFIG_FILE="$HOME/.config/litellm/config.yaml"
PROXY_URL="${1:-http://localhost:4000}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[PAI-LiteLLM-Test]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[PAI-LiteLLM-Test]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[PAI-LiteLLM-Test]${NC} $1"
}

print_error() {
    echo -e "${RED}[PAI-LiteLLM-Test]${NC} $1"
}

# Test function for chat completions
test_chat_completion() {
    local model="$1"
    local test_prompt="Hello! Please respond with a brief greeting and confirm you are the $model model."
    
    print_status "Testing chat completion with model: $model"
    
    local response=$(curl -s -X POST "$PROXY_URL/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer test-key" \
        -d "{
            \"model\": \"$model\",
            \"messages\": [{\"role\": \"user\", \"content\": \"$test_prompt\"}],
            \"max_tokens\": 150,
            \"temperature\": 0.7
        }" 2>/dev/null)
    
    if [[ $? -eq 0 ]] && echo "$response" | jq -e '.choices[0].message.content' >/dev/null 2>&1; then
        local content=$(echo "$response" | jq -r '.choices[0].message.content')
        print_success "‚úÖ $model: ${content:0:100}..."
        return 0
    else
        print_error "‚ùå $model: Failed to get response"
        echo "Response: $response" | head -3
        return 1
    fi
}

# Test function for embeddings
test_embedding() {
    local model="$1"
    local test_text="This is a test sentence for embedding generation."
    
    print_status "Testing embedding with model: $model"
    
    local response=$(curl -s -X POST "$PROXY_URL/v1/embeddings" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer test-key" \
        -d "{
            \"model\": \"$model\",
            \"input\": \"$test_text\"
        }" 2>/dev/null)
    
    if [[ $? -eq 0 ]] && echo "$response" | jq -e '.data[0].embedding' >/dev/null 2>&1; then
        local embedding_length=$(echo "$response" | jq '.data[0].embedding | length')
        print_success "‚úÖ $model: Generated embedding with $embedding_length dimensions"
        return 0
    else
        print_error "‚ùå $model: Failed to generate embedding"
        echo "Response: $response" | head -3
        return 1
    fi
}

# Check prerequisites
print_status "Checking prerequisites..."

if ! command -v curl &> /dev/null; then
    print_error "curl is required but not installed"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    print_error "jq is required but not installed. Install with: sudo dnf install jq"
    exit 1
fi

if [[ ! -f "$CONFIG_FILE" ]]; then
    print_error "Configuration file not found: $CONFIG_FILE"
    exit 1
fi

print_status "Testing LiteLLM proxy at: $PROXY_URL"
print_status "========================================"

# Test if proxy is running
if ! curl -s "$PROXY_URL/health" >/dev/null 2>&1; then
    print_error "LiteLLM proxy is not running at $PROXY_URL"
    print_status "Start the proxy with: pai-litellm-proxy"
    exit 1
fi

print_success "‚úÖ LiteLLM proxy is running"

# Test models endpoint
print_status "Testing models endpoint..."
models_response=$(curl -s "$PROXY_URL/v1/models" -H "Authorization: Bearer test-key")
if echo "$models_response" | jq -e '.data' >/dev/null 2>&1; then
    model_count=$(echo "$models_response" | jq '.data | length')
    print_success "‚úÖ Models endpoint: $model_count models available"
else
    print_error "‚ùå Models endpoint failed"
fi

print_status ""
print_status "Testing chat completion models..."
print_status "================================="

# Test chat models
chat_models=("granite-3.2-8b-instruct" "granite-3.1-8b-instruct" "granite-8b-code-instruct" "mistral-7b-instruct")
chat_success=0
for model in "${chat_models[@]}"; do
    if test_chat_completion "$model"; then
        ((chat_success++))
    fi
    sleep 1  # Brief pause between tests
done

print_status ""
print_status "Testing embedding models..."
print_status "==========================="

# Test embedding models
embedding_models=("modernbert-embed-base" "nomic-embed-text")
embedding_success=0
for model in "${embedding_models[@]}"; do
    if test_embedding "$model"; then
        ((embedding_success++))
    fi
    sleep 1  # Brief pause between tests
done

print_status ""
print_status "Test Summary"
print_status "============"
print_success "Chat models: $chat_success/${#chat_models[@]} working"
print_success "Embedding models: $embedding_success/${#embedding_models[@]} working"

total_models=$((${#chat_models[@]} + ${#embedding_models[@]}))
total_success=$((chat_success + embedding_success))

if [[ $total_success -eq $total_models ]]; then
    print_success "üéâ All tests passed! LiteLLM setup is working correctly."
    exit 0
else
    print_warning "‚ö†Ô∏è  Some tests failed. Check the configuration and network connectivity."
    exit 1
fi
