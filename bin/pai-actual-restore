#!/bin/bash
#
# pai-actual-restore - Restore Actual Budget data to miraclemax
#
# Description:
#   Restores Actual Budget SQLite databases and blobs from local backup
#   to miraclemax container volume (DESTRUCTIVE OPERATION)
#
# Usage:
#   pai-actual-restore [--from-git] [--backup-dir PATH]
#
# Options:
#   --from-git         Pull latest backup from GitHub first
#   --backup-dir PATH  Restore from specific backup directory
#
# WARNING: This will OVERWRITE existing data on miraclemax
#
# Location: /home/jbyrd/pai/bin/pai-actual-restore
# Author: Hatter (PAI System)
# Date: 2025-10-14

set -euo pipefail

# Configuration
MIRACLEMAX_HOST="jbyrd@192.168.1.34"
VOLUME_PATH="/home/jbyrd/.local/share/containers/storage/volumes/compose_actual-budget-data/_data"
BACKUP_DIR="/home/jbyrd/pai/repositories/pai-personal-finance/backups/actual-budget"
GIT_REPO="/home/jbyrd/pai/repositories/pai-personal-finance"
LOG_FILE="/home/jbyrd/.local/share/pai/logs/actual-restore.log"

# Options
PULL_FROM_GIT=false
CUSTOM_BACKUP_DIR=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --from-git)
            PULL_FROM_GIT=true
            shift
            ;;
        --backup-dir)
            CUSTOM_BACKUP_DIR="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: pai-actual-restore [--from-git] [--backup-dir PATH]"
            exit 1
            ;;
    esac
done

# Use custom backup dir if provided
if [ -n "$CUSTOM_BACKUP_DIR" ]; then
    BACKUP_DIR="$CUSTOM_BACKUP_DIR"
fi

# Logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Create log directory if needed
mkdir -p "$(dirname "$LOG_FILE")"

log "=== Starting Actual Budget Restore ==="

# Pull from Git if requested
if [ "$PULL_FROM_GIT" = true ]; then
    log "Pulling latest backup from GitHub..."
    cd "$GIT_REPO"
    git pull origin master || {
        log "WARNING: Failed to pull from GitHub, using local backup"
    }
    log "‚úÖ Git pull complete"
fi

# Verify backup directory exists
if [ ! -d "$BACKUP_DIR" ]; then
    log "ERROR: Backup directory not found: $BACKUP_DIR"
    exit 1
fi

# Check if backup files exist
if [ ! -f "$BACKUP_DIR/server-files/account.sqlite" ]; then
    log "ERROR: account.sqlite not found in backup"
    exit 1
fi

if [ ! -d "$BACKUP_DIR/user-files" ] || [ -z "$(ls -A "$BACKUP_DIR/user-files")" ]; then
    log "ERROR: user-files directory is empty in backup"
    exit 1
fi

# Show what will be restored
log "Backup to restore from: $BACKUP_DIR"
log "Files to restore:"
ls -lh "$BACKUP_DIR/server-files/" | tail -n +2 | while read -r line; do
    log "  server-files: $line"
done
ls -lh "$BACKUP_DIR/user-files/" | tail -n +2 | while read -r line; do
    log "  user-files: $line"
done

# Confirmation prompt
echo ""
echo "‚ö†Ô∏è  WARNING: This will OVERWRITE existing Actual Budget data on miraclemax"
echo ""
echo "Backup source: $BACKUP_DIR"
echo "Target server: $MIRACLEMAX_HOST"
echo "Target path: $VOLUME_PATH"
echo ""
read -p "Are you sure you want to continue? (type 'yes' to confirm): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    log "Restore cancelled by user"
    echo "Restore cancelled."
    exit 0
fi

# Check if miraclemax is reachable
if ! ssh -o ConnectTimeout=5 "$MIRACLEMAX_HOST" "echo 'Connection OK'" &>/dev/null; then
    log "ERROR: Cannot reach miraclemax at $MIRACLEMAX_HOST"
    exit 1
fi

# Stop Actual Budget container
log "Stopping Actual Budget container..."
if ssh "$MIRACLEMAX_HOST" "podman ps --filter name=actual-budget --format '{{.Names}}'" | grep -q "actual-budget"; then
    ssh "$MIRACLEMAX_HOST" "cd /home/jbyrd/pai/repositories/pai-infrastructure-automation/miraclemax/compose && podman-compose -f actual-budget.yml down" || {
        log "ERROR: Failed to stop Actual Budget container"
        exit 1
    }
    log "‚úÖ Container stopped"
    sleep 2
else
    log "‚ÑπÔ∏è  Actual Budget container was not running"
fi

# Restore server-files
log "Restoring server-files..."
ssh "$MIRACLEMAX_HOST" "mkdir -p $VOLUME_PATH/server-files"
scp -q "$BACKUP_DIR/server-files/"* "$MIRACLEMAX_HOST:$VOLUME_PATH/server-files/" || {
    log "ERROR: Failed to restore server-files"
    exit 1
}
log "‚úÖ Server files restored"

# Restore user-files
log "Restoring user-files..."
ssh "$MIRACLEMAX_HOST" "mkdir -p $VOLUME_PATH/user-files"
scp -q "$BACKUP_DIR/user-files/"* "$MIRACLEMAX_HOST:$VOLUME_PATH/user-files/" || {
    log "ERROR: Failed to restore user-files"
    exit 1
}
log "‚úÖ User files restored"

# Restore .migrate file
if [ -f "$BACKUP_DIR/.migrate" ]; then
    log "Restoring .migrate file..."
    scp -q "$BACKUP_DIR/.migrate" "$MIRACLEMAX_HOST:$VOLUME_PATH/.migrate" || {
        log "WARNING: Failed to restore .migrate file"
    }
    log "‚úÖ Migration file restored"
fi

# Fix permissions
log "Fixing permissions..."
ssh "$MIRACLEMAX_HOST" "chown -R jbyrd:jbyrd $VOLUME_PATH" || {
    log "WARNING: Failed to fix permissions (may require manual intervention)"
}

# Start Actual Budget container
log "Starting Actual Budget container..."
ssh "$MIRACLEMAX_HOST" "cd /home/jbyrd/pai/repositories/pai-infrastructure-automation/miraclemax/compose && podman-compose -f actual-budget.yml up -d" || {
    log "ERROR: Failed to start Actual Budget container"
    exit 1
}
log "‚úÖ Container started"

# Wait for container to be healthy
log "Waiting for container to be healthy..."
sleep 5

log "=== Restore Complete ==="
echo ""
echo "‚úÖ Actual Budget data restored successfully"
echo "üåê Access at: http://money.jbyrd.org or http://budget.jbyrd.org"
echo "üìù Log: $LOG_FILE"
echo ""
echo "Next steps:"
echo "  1. Open money.jbyrd.org"
echo "  2. Verify your budget data is intact"
echo "  3. Check that all transactions are present"





