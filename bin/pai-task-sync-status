#!/bin/bash

# pai-task-sync-status - Monitor PAI task sync health and status
# Shows sync statistics, recent activity, and any issues

# Configuration
LOG_DIR="$HOME/.claude/context/logs"
SYNC_LOG="$LOG_DIR/pai-task-sync-cron.log"
ERROR_LOG="$LOG_DIR/pai-task-sync-error.log"
PROJECTS_FILE="$HOME/.claude/context/create/outputs/projects/projects.yaml"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîÑ PAI Task Sync Status${NC}"
echo "=================================================="

# Check if sync is currently running
if [[ -f "/tmp/pai-task-sync.lock" ]]; then
    PID=$(cat "/tmp/pai-task-sync.lock" 2>/dev/null || echo "")
    if [[ -n "$PID" ]] && kill -0 "$PID" 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Sync currently running (PID: $PID)${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Stale lock file found${NC}"
    fi
    echo
fi

# Get sync statistics
echo -e "${BLUE}üìä Current Statistics${NC}"
echo "----------------------------------"

# PAI task count
if [[ -f "$PROJECTS_FILE" ]]; then
    PAI_TASKS=$(python3 -c "
import yaml
try:
    with open('$PROJECTS_FILE', 'r') as f:
        data = yaml.safe_load(f)
    if data and 'projects' in data:
        total = 0
        by_status = {'pending': 0, 'in-progress': 0, 'completed': 0, 'blocked': 0}
        for project in data['projects'].values():
            for task in project.get('tasks', []):
                total += 1
                status = task.get('status', 'pending')
                if status in by_status:
                    by_status[status] += 1
        print(f'Total: {total}')
        print(f'Pending: {by_status[\"pending\"]}')
        print(f'In-Progress: {by_status[\"in-progress\"]}')
        print(f'Completed: {by_status[\"completed\"]}')
        print(f'Blocked: {by_status[\"blocked\"]}')
    else:
        print('Total: 0')
except Exception as e:
    print(f'Error: {e}')
" 2>/dev/null)
    echo -e "PAI Tasks:"
    echo "$PAI_TASKS" | sed 's/^/  /'
else
    echo -e "${RED}‚ùå PAI projects file not found${NC}"
fi

echo

# Taskwarrior PAI task count
TW_STATS=$(task export 2>/dev/null | python3 -c "
import json, sys
try:
    tasks = json.load(sys.stdin)
    pai_tasks = [t for t in tasks if t.get('tags') and 'pai' in t.get('tags', [])]
    by_status = {'pending': 0, 'completed': 0, 'deleted': 0, 'waiting': 0}
    for task in pai_tasks:
        status = task.get('status', 'pending')
        if status in by_status:
            by_status[status] += 1
    print(f'Total: {len(pai_tasks)}')
    print(f'Pending: {by_status[\"pending\"]}')
    print(f'Completed: {by_status[\"completed\"]}')
    print(f'Waiting: {by_status[\"waiting\"]}')
    print(f'Deleted: {by_status[\"deleted\"]}')
except Exception as e:
    print(f'Error: {e}')
" 2>/dev/null || echo "Error: Could not get Taskwarrior stats")

echo -e "Taskwarrior PAI Tasks:"
echo "$TW_STATS" | sed 's/^/  /'

echo

# Recent sync activity
echo -e "${BLUE}üìã Recent Sync Activity${NC}"
echo "----------------------------------"
if [[ -f "$SYNC_LOG" ]]; then
    echo "Last 5 sync events:"
    tail -10 "$SYNC_LOG" | grep -E "(Starting|completed|ERROR)" | tail -5 | sed 's/^/  /'
    echo

    # Last successful sync
    LAST_SUCCESS=$(grep "Sync completed successfully" "$SYNC_LOG" | tail -1 | cut -d' ' -f1-2)
    if [[ -n "$LAST_SUCCESS" ]]; then
        echo -e "${GREEN}‚úÖ Last successful sync: $LAST_SUCCESS${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No successful syncs found in log${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  No sync log found${NC}"
fi

echo

# Error status
echo -e "${BLUE}‚ö†Ô∏è  Error Status${NC}"
echo "----------------------------------"
if [[ -f "$ERROR_LOG" ]]; then
    ERROR_COUNT=$(wc -l < "$ERROR_LOG" 2>/dev/null || echo "0")
    if [[ "$ERROR_COUNT" -gt 0 ]]; then
        echo -e "${RED}‚ùå $ERROR_COUNT errors found${NC}"
        echo "Recent errors:"
        tail -3 "$ERROR_LOG" | sed 's/^/  /'
    else
        echo -e "${GREEN}‚úÖ No errors${NC}"
    fi
else
    echo -e "${GREEN}‚úÖ No error log (no errors)${NC}"
fi

echo

# Cron job status
echo -e "${BLUE}‚è∞ Cron Job Status${NC}"
echo "----------------------------------"
if crontab -l 2>/dev/null | grep -q "pai-task-sync-cron"; then
    echo -e "${GREEN}‚úÖ Cron job active (every 15 minutes)${NC}"
    CRON_LINE=$(crontab -l | grep "pai-task-sync-cron")
    echo "  Schedule: $CRON_LINE"
else
    echo -e "${RED}‚ùå Cron job not found${NC}"
fi

echo

# Next sync prediction
if [[ -f "$SYNC_LOG" ]]; then
    LAST_SYNC=$(grep "Starting automated" "$SYNC_LOG" | tail -1 | cut -d' ' -f1-2)
    if [[ -n "$LAST_SYNC" ]]; then
        # Calculate next sync (15 minutes from last)
        if command -v date &> /dev/null; then
            LAST_EPOCH=$(date -d "$LAST_SYNC" +%s 2>/dev/null || echo "")
            if [[ -n "$LAST_EPOCH" ]]; then
                NEXT_EPOCH=$((LAST_EPOCH + 900)) # 15 minutes = 900 seconds
                NEXT_SYNC=$(date -d "@$NEXT_EPOCH" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "Unknown")
                echo -e "${BLUE}‚è≠Ô∏è  Next scheduled sync: $NEXT_SYNC${NC}"
            fi
        fi
    fi
fi

echo
echo "=================================================="
echo -e "${BLUE}Commands:${NC}"
echo "  pai-task-sync bidirectional  # Manual sync"
echo "  pai-projects summary         # View projects"
echo "  tail -f $SYNC_LOG            # Watch live sync"