#!/usr/bin/env bash
set -euo pipefail

# PAI Work Email Processor - Process Red Hat work emails for TAM insights
# Red Hat compliant email processing for jbyrd@redhat.com

# Configuration
PAI_DIR="$HOME/.claude/context"
EMAIL_DIR="$PAI_DIR/capture/email/gmail-jbyrd-redhat"
OUTPUT_DIR="$PAI_DIR/create/outputs/email/work"
FABRIC_MODEL="${WORK_EMAIL_PROCESSOR_MODEL:-granite-3-2-8b-instruct}"
RESEARCH_MODEL="${WORK_EMAIL_RESEARCH_MODEL:-granite-3-2-8b-instruct}"

# Red Hat compliance - use only approved models
export LITELLM_MODEL="$FABRIC_MODEL"

# Ensure directories exist
mkdir -p "$OUTPUT_DIR/daily" "$OUTPUT_DIR/contacts" "$OUTPUT_DIR/cases" "$OUTPUT_DIR/projects"

# Function to log with audit trail
log_with_audit() {
    local message="$1"
    local level="${2:-INFO}"
    
    echo "[$(date -u +%Y-%m-%dT%H:%M:%SZ)] $level: $message"
    pai-audit log "WORK_EMAIL_PROCESSOR" "$level: $message"
}

# Function to process daily work emails
process_daily_emails() {
    local days="${1:-1}"
    
    log_with_audit "Starting daily work email processing (last $days days)"
    
    # Sync emails first
    if pai-gmail-work-sync; then
        log_with_audit "Work email sync completed successfully"
    else
        log_with_audit "Work email sync failed" "ERROR"
        return 1
    fi
    
    # Process emails for Red Hat specific patterns
    local today=$(date +%Y-%m-%d)
    local output_file="$OUTPUT_DIR/daily/work-email-analysis-$today.md"
    
    cat > "$output_file" << EOF
---
title: "Red Hat Work Email Analysis - $today"
type: "work_email_analysis"
account: "jbyrd@redhat.com"
generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
compliance: "red_hat_approved_models"
tags: [email, work, redhat, tam, analysis]
---

# Red Hat Work Email Analysis - $today

**Account**: jbyrd@redhat.com  
**Generated**: $(date -u +%Y-%m-%d)  
**Period**: Last $days days  
**Model**: $FABRIC_MODEL (Red Hat approved)

## Summary

Processing work emails for Red Hat TAM operations using approved models only.

## Key Categories

### ðŸŽ¯ Customer Cases
- New case notifications
- Case updates and responses
- Escalations and priority changes

### ðŸ‘¥ Team Communications
- TAM team updates
- Account strategy discussions
- Technical consultations

### ðŸ“š Knowledge & Training
- Product updates
- Training materials
- Best practices sharing

### ðŸ”§ Internal Operations
- Process updates
- Tool notifications
- Administrative items

## Analysis Notes
- All processing uses Red Hat approved AI models
- Customer data handled per Red Hat AI policy
- Audit logging enabled for compliance

## Next Steps
- Review high-priority customer communications
- Update case tracking systems
- Follow up on action items
EOF

    log_with_audit "Daily analysis saved to: $output_file"
}

# Function to extract Red Hat case information
extract_case_info() {
    log_with_audit "Extracting Red Hat case information from work emails"
    
    # Look for case numbers in subject lines (Red Hat format: 8 digits)
    local case_pattern="[Cc]ase\s*#?\s*([0-9]{8})"
    local today=$(date +%Y-%m-%d)
    local cases_file="$OUTPUT_DIR/cases/cases-extracted-$today.md"
    
    cat > "$cases_file" << EOF
---
title: "Red Hat Cases Extracted - $today"
type: "case_extraction"
generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
tags: [cases, redhat, supportshell, tam]
---

# Red Hat Cases from Work Emails - $today

## Cases Found in Recent Emails

<!-- Case extraction will be implemented with notmuch integration -->

## Integration Notes

- Cases should be tracked in SupportShell
- Use pai-case-processor for detailed analysis  
- Customer communications require Red Hat approved models

## Next Steps

- Set up notmuch for work email indexing
- Create case-specific processing workflows
- Integrate with pai-supportshell tool
EOF

    log_with_audit "Case extraction saved to: $cases_file"
}

# Function to analyze team communications
analyze_team_comms() {
    log_with_audit "Analyzing Red Hat team communications"
    
    local today=$(date +%Y-%m-%d)
    local team_file="$OUTPUT_DIR/daily/team-comms-$today.md"
    
    cat > "$team_file" << EOF
---
title: "Red Hat Team Communications - $today"
type: "team_analysis"
generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)
tags: [team, communications, tam, redhat]
---

# Red Hat Team Communications Analysis - $today

## Key Topics

### Strategy & Planning
- Account strategy updates
- Quarterly planning items
- Resource allocation discussions

### Technical Discussions
- Product roadmap updates
- Technical solution reviews
- Customer technical challenges

### Process & Operations
- TAM process improvements
- Tool updates and changes
- Best practice sharing

## Action Items Identified

<!-- Action items will be extracted and tracked -->

## Follow-up Required

<!-- High-priority items requiring immediate attention -->
EOF

    log_with_audit "Team communications analysis saved to: $team_file"
}

# Function to setup work email automation
setup_automation() {
    local interval="${1:-30min}"
    
    log_with_audit "Setting up work email processing automation every $interval"
    
    # Create systemd service for work email processing
    cat > "$HOME/.config/systemd/user/pai-email-work-processor.service" << EOF
[Unit]
Description=PAI Red Hat Work Email Processor
Documentation=Red Hat PAI Tools
After=network.target

[Service]
Type=oneshot
Environment=PATH=/home/jbyrd/.local/bin:/home/jbyrd/hatter-pai/bin:/usr/bin
ExecStart=/home/jbyrd/hatter-pai/bin/pai-email-work-processor process
StandardOutput=journal
StandardError=journal
EOF

    # Create systemd timer
    cat > "$HOME/.config/systemd/user/pai-email-work-processor.timer" << EOF
[Unit]
Description=PAI Work Email Processing Timer
Requires=pai-email-work-processor.service

[Timer]
OnCalendar=*:0/30
Persistent=true

[Install]
WantedBy=timers.target
EOF

    # Enable and start the timer
    systemctl --user daemon-reload
    systemctl --user enable pai-email-work-processor.timer
    systemctl --user start pai-email-work-processor.timer
    
    log_with_audit "Work email automation setup completed"
    echo "âœ… Work email processing will run every $interval"
    echo "ðŸ“Š View logs: journalctl --user -u pai-email-work-processor.service"
}

# Main function
main() {
    case "${1:-}" in
        "process")
            log_with_audit "Starting comprehensive work email processing"
            process_daily_emails 1
            extract_case_info
            analyze_team_comms
            log_with_audit "Work email processing completed"
            ;;
        "setup")
            setup_automation "${2:-30min}"
            ;;
        "daily")
            process_daily_emails "${2:-1}"
            ;;
        "cases")
            extract_case_info
            ;;
        "team")
            analyze_team_comms
            ;;
        *)
            echo "Usage: pai-email-work-processor [process|setup|daily|cases|team]"
            echo ""
            echo "Commands:"
            echo "  process  - Run comprehensive email processing"
            echo "  setup    - Set up automation (optional: interval like '30min')"
            echo "  daily    - Process daily emails (optional: days back)"
            echo "  cases    - Extract case information"
            echo "  team     - Analyze team communications"
            echo ""
            echo "Examples:"
            echo "  pai-email-work-processor process"
            echo "  pai-email-work-processor setup 15min"
            echo "  pai-email-work-processor daily 3"
            exit 1
            ;;
    esac
}

main "$@"
