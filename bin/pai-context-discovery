#!/bin/bash
# PAI Context Discovery Engine - Service Discovery and Mapping
# The foundation of full context awareness across the infrastructure

set -euo pipefail

# Gandalf Colors for Beautiful Progress
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GOLD='\033[38;5;220m'
ELECTRIC='\033[38;5;51m'
COSMIC='\033[38;5;165m'
BOLD='\033[1m'
NC='\033[0m'

# Configuration
PAI_CONFIG_DIR="$HOME/.config/pai"
DISCOVERY_DATA_DIR="$PAI_CONFIG_DIR/context-discovery"
SERVICES_DB="$DISCOVERY_DATA_DIR/services.json"
NETWORK_MAP="$DISCOVERY_DATA_DIR/network-topology.json"
HEALTH_STATUS="$DISCOVERY_DATA_DIR/health-status.json"

# Create directories
mkdir -p "$DISCOVERY_DATA_DIR"

# Beautiful Progress Bar Function
show_magical_progress() {
    local current=$1
    local total=$2
    local task=$3
    local width=60
    local percentage=$((current * 100 / total))
    local completed=$((current * width / total))
    
    printf "${PURPLE}üîÆ ${BOLD}${WHITE}Gandalf's Discovery:${NC} "
    printf "${CYAN}[${NC}"
    
    # Create rainbow gradient in progress bar
    for ((i=1; i<=completed; i++)); do
        if ((i <= width/6)); then printf "${RED}‚ñà${NC}"
        elif ((i <= width/3)); then printf "${YELLOW}‚ñà${NC}"
        elif ((i <= width/2)); then printf "${GREEN}‚ñà${NC}"
        elif ((i <= 2*width/3)); then printf "${CYAN}‚ñà${NC}"
        elif ((i <= 5*width/6)); then printf "${BLUE}‚ñà${NC}"
        else printf "${PURPLE}‚ñà${NC}"
        fi
    done
    
    printf "%$((width-completed))s" | tr ' ' '‚ñë'
    printf "${CYAN}]${NC} ${BOLD}%3d%%${NC} ${PURPLE}‚ö° %s${NC}\n" "$percentage" "$task"
}

# Help function
show_help() {
    cat << EOF
üßô‚Äç‚ôÇÔ∏è PAI Context Discovery Engine - Service Discovery and Mapping

USAGE:
    pai-context-discovery <command> [options]

COMMANDS:
    scan            Scan network for all services and devices
    map             Create network topology map
    health          Check health status of all discovered services
    services        List all discovered services
    network         Show network topology
    status          Show discovery engine status
    export          Export discovery data
    import          Import discovery data
    
    --create        Initialize discovery engine (first time setup)
    --reset         Reset all discovery data
    --update        Update existing discovery data

OPTIONS:
    --network RANGE     Network range to scan (default: 192.168.1.0/24)
    --ports PORTS       Ports to scan (default: common ports)
    --timeout SEC       Scan timeout (default: 5)
    --json              Output in JSON format
    --verbose           Show detailed information
    --help, -h          Show this help message

EXAMPLES:
    pai-context-discovery --create
    pai-context-discovery scan --network 192.168.1.0/24
    pai-context-discovery map --verbose
    pai-context-discovery health --json
    pai-context-discovery services

EXIT CODES:
    0   Success
    1   Discovery errors
    2   Configuration error
    3   Invalid arguments

üßô‚Äç‚ôÇÔ∏è "All we have to decide is what to do with the services that are given to us."
EOF
}

# Initialize discovery engine
initialize_discovery() {
    echo -e "${PURPLE}üßô‚Äç‚ôÇÔ∏è ${BOLD}${WHITE}INITIALIZING CONTEXT DISCOVERY ENGINE${NC} ${PURPLE}‚ö°${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    show_magical_progress 1 5 "Creating discovery directories..."
    mkdir -p "$DISCOVERY_DATA_DIR"/{logs,cache,exports}
    
    show_magical_progress 2 5 "Initializing service database..."
    echo '{"services": [], "last_scan": null, "version": "1.0.0"}' > "$SERVICES_DB"
    
    show_magical_progress 3 5 "Creating network topology map..."
    echo '{"nodes": [], "edges": [], "last_updated": null}' > "$NETWORK_MAP"
    
    show_magical_progress 4 5 "Setting up health monitoring..."
    echo '{"health_checks": [], "last_check": null, "overall_status": "unknown"}' > "$HEALTH_STATUS"
    
    show_magical_progress 5 5 "Discovery engine ready!"
    
    echo -e "\n${GREEN}‚úÖ ${BOLD}Context Discovery Engine initialized successfully!${NC}"
    echo -e "${CYAN}üìÅ Data directory: $DISCOVERY_DATA_DIR${NC}"
    echo -e "${CYAN}üóÑÔ∏è  Services database: $SERVICES_DB${NC}"
    echo -e "${CYAN}üó∫Ô∏è  Network map: $NETWORK_MAP${NC}"
    echo -e "${CYAN}‚ù§Ô∏è  Health status: $HEALTH_STATUS${NC}"
}

# Scan network for services
scan_network() {
    local network_range="${NETWORK_RANGE:-192.168.1.0/24}"
    local ports="${PORTS:-22,80,443,3000,32400,8123,9090,9100,11434,6333,5678,8080}"
    local timeout="${TIMEOUT:-5}"
    
    echo -e "${PURPLE}üîç ${BOLD}${WHITE}SCANNING THE REALM FOR SERVICES${NC} ${PURPLE}‚ö°${NC}"
    echo -e "${CYAN}Network: $network_range | Ports: $ports | Timeout: ${timeout}s${NC}"
    echo
    
    # Initialize services array
    local services=()
    local total_hosts=0
    local discovered_services=0
    
    # Get list of hosts in network range
    show_magical_progress 1 4 "Discovering hosts in network..."
    local hosts
    if command -v nmap >/dev/null 2>&1; then
        hosts=$(nmap -sn "$network_range" 2>/dev/null | grep "Nmap scan report" | awk '{print $5}' | grep -v "^$" || echo "")
    else
        # Fallback to ping sweep
        hosts=$(for i in {1..254}; do timeout 1 ping -c 1 "192.168.1.$i" >/dev/null 2>&1 && echo "192.168.1.$i"; done)
    fi
    
    total_hosts=$(echo "$hosts" | wc -l)
    echo -e "${CYAN}Found $total_hosts hosts to scan${NC}"
    
    show_magical_progress 2 4 "Scanning services on each host..."
    
    # Scan each host
    while IFS= read -r host; do
        [[ -z "$host" ]] && continue
        
        echo -e "${YELLOW}üîç Scanning $host...${NC}"
        
        # Scan ports on this host
        local host_services=()
        IFS=',' read -ra PORT_ARRAY <<< "$ports"
        
        for port in "${PORT_ARRAY[@]}"; do
            if timeout "$timeout" bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null; then
                # Port is open, try to identify service
                local service_info
                service_info=$(identify_service "$host" "$port")
                host_services+=("$service_info")
                ((discovered_services++))
            fi
        done
        
        # Add host services to main array
        if [[ ${#host_services[@]} -gt 0 ]]; then
            services+=("{\"host\": \"$host\", \"services\": [$(IFS=','; echo "${host_services[*]}")]}")
        fi
        
    done <<< "$hosts"
    
    show_magical_progress 3 4 "Processing discovered services..."
    
    # Update services database
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local services_json="[$(IFS=','; echo "${services[*]}")]"
    
    jq --argjson services "$services_json" --arg timestamp "$timestamp" \
       '.services = $services | .last_scan = $timestamp' \
       "$SERVICES_DB" > "$SERVICES_DB.tmp" && mv "$SERVICES_DB.tmp" "$SERVICES_DB"
    
    show_magical_progress 4 4 "Discovery complete!"
    
    echo -e "\n${GREEN}‚úÖ ${BOLD}Network scan completed!${NC}"
    echo -e "${CYAN}üìä Discovered $discovered_services services across $total_hosts hosts${NC}"
    echo -e "${CYAN}üìÅ Results saved to: $SERVICES_DB${NC}"
}

# Identify service running on a port
identify_service() {
    local host=$1
    local port=$2
    
    # Try to identify service based on port and response
    local service_name="unknown"
    local service_type="unknown"
    local version="unknown"
    
    case $port in
        22) service_name="SSH"; service_type="remote_access" ;;
        80) service_name="HTTP"; service_type="web_server" ;;
        443) service_name="HTTPS"; service_type="web_server" ;;
        3000) service_name="Grafana"; service_type="monitoring" ;;
        32400) service_name="Plex"; service_type="media_server" ;;
        8123) service_name="Home Assistant"; service_type="home_automation" ;;
        9090) service_name="Prometheus"; service_type="monitoring" ;;
        9100) service_name="Node Exporter"; service_type="monitoring" ;;
        11434) service_name="Ollama"; service_type="ai_service" ;;
        6333) service_name="Qdrant"; service_type="vector_db" ;;
        5678) service_name="n8n"; service_type="automation" ;;
        8080) service_name="HTTP Proxy"; service_type="proxy" ;;
        *) service_name="Service"; service_type="unknown" ;;
    esac
    
    # Try to get more specific info
    if [[ "$port" == "80" || "$port" == "443" ]]; then
        local protocol="http"
        [[ "$port" == "443" ]] && protocol="https"
        
        # Try to get HTTP response
        local response
        response=$(timeout 3 curl -s -I "$protocol://$host:$port" 2>/dev/null || echo "")
        
        if echo "$response" | grep -qi "grafana"; then
            service_name="Grafana"
            service_type="monitoring"
        elif echo "$response" | grep -qi "home-assistant"; then
            service_name="Home Assistant"
            service_type="home_automation"
        elif echo "$response" | grep -qi "plex"; then
            service_name="Plex"
            service_type="media_server"
        fi
    fi
    
    echo "{\"port\": $port, \"name\": \"$service_name\", \"type\": \"$service_type\", \"version\": \"$version\", \"status\": \"active\"}"
}

# List discovered services
list_services() {
    if [[ ! -f "$SERVICES_DB" ]]; then
        echo -e "${RED}‚ùå No services database found. Run 'pai-context-discovery --create' first.${NC}"
        return 1
    fi
    
    echo -e "${PURPLE}üìã ${BOLD}${WHITE}DISCOVERED SERVICES${NC} ${PURPLE}‚ö°${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    if [[ "${JSON_OUTPUT:-false}" == "true" ]]; then
        cat "$SERVICES_DB"
    else
        jq -r '.services[] | "\(.host): \(.services | length) services"' "$SERVICES_DB" 2>/dev/null || echo "No services found"
        
        echo -e "\n${YELLOW}üìä Service Details:${NC}"
        jq -r '.services[] | .host as $host | .services[] | "  \($host):\(.port) - \(.name) (\(.type))"' "$SERVICES_DB" 2>/dev/null || echo "No service details available"
        
        local last_scan
        last_scan=$(jq -r '.last_scan // "Never"' "$SERVICES_DB" 2>/dev/null)
        echo -e "\n${CYAN}üïê Last scan: $last_scan${NC}"
    fi
}

# Check health status
check_health() {
    echo -e "${PURPLE}‚ù§Ô∏è ${BOLD}${WHITE}CHECKING SERVICE HEALTH${NC} ${PURPLE}‚ö°${NC}"
    echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    
    if [[ ! -f "$SERVICES_DB" ]]; then
        echo -e "${RED}‚ùå No services database found. Run 'pai-context-discovery scan' first.${NC}"
        return 1
    fi
    
    local total_services=0
    local healthy_services=0
    local unhealthy_services=0
    
    # Check each service
    while IFS= read -r service_info; do
        [[ -z "$service_info" ]] && continue
        
        local host port name
        host=$(echo "$service_info" | jq -r '.host')
        port=$(echo "$service_info" | jq -r '.port')
        name=$(echo "$service_info" | jq -r '.name')
        
        ((total_services++))
        
        echo -e "${YELLOW}üîç Checking $name on $host:$port...${NC}"
        
        if timeout 3 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null; then
            echo -e "${GREEN}  ‚úÖ $name is healthy${NC}"
            ((healthy_services++))
        else
            echo -e "${RED}  ‚ùå $name is unhealthy${NC}"
            ((unhealthy_services++))
        fi
        
    done < <(jq -r '.services[] | .host as $host | .services[] | "{\"host\": \"\($host)\", \"port\": \(.port), \"name\": \"\(.name)\"}"' "$SERVICES_DB" 2>/dev/null)
    
    # Update health status
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local overall_status="healthy"
    [[ $unhealthy_services -gt 0 ]] && overall_status="degraded"
    [[ $healthy_services -eq 0 ]] && overall_status="unhealthy"
    
    jq --argjson total "$total_services" \
       --argjson healthy "$healthy_services" \
       --argjson unhealthy "$unhealthy_services" \
       --arg status "$overall_status" \
       --arg timestamp "$timestamp" \
       '.total_services = $total | .healthy_services = $healthy | .unhealthy_services = $unhealthy | .overall_status = $status | .last_check = $timestamp' \
       "$HEALTH_STATUS" > "$HEALTH_STATUS.tmp" && mv "$HEALTH_STATUS.tmp" "$HEALTH_STATUS"
    
    echo -e "\n${GREEN}‚úÖ ${BOLD}Health check completed!${NC}"
    echo -e "${CYAN}üìä Total: $total_services | Healthy: $healthy_services | Unhealthy: $unhealthy_services${NC}"
    echo -e "${CYAN}‚ù§Ô∏è  Overall status: $overall_status${NC}"
}

# Parse arguments
COMMAND=""
NETWORK_RANGE="192.168.1.0/24"
PORTS="22,80,443,3000,32400,8123,9090,9100,11434,6333,5678,8080"
TIMEOUT="5"
JSON_OUTPUT=false
VERBOSE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --create)
            initialize_discovery
            exit 0
            ;;
        --reset)
            echo -e "${YELLOW}üîÑ Resetting discovery data...${NC}"
            rm -rf "$DISCOVERY_DATA_DIR"
            initialize_discovery
            exit 0
            ;;
        --update)
            COMMAND="scan"
            shift
            ;;
        --network)
            NETWORK_RANGE="$2"
            shift 2
            ;;
        --ports)
            PORTS="$2"
            shift 2
            ;;
        --timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        --json)
            JSON_OUTPUT=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        -*)
            echo -e "${RED}‚ùå Unknown option: $1${NC}" >&2
            show_help >&2
            exit 3
            ;;
        *)
            if [[ -z "$COMMAND" ]]; then
                COMMAND="$1"
            else
                echo -e "${RED}‚ùå Multiple commands specified${NC}" >&2
                exit 3
            fi
            shift
            ;;
    esac
done

# Validate command
if [[ -z "$COMMAND" ]]; then
    echo -e "${RED}‚ùå Command required${NC}" >&2
    show_help >&2
    exit 2
fi

# Export variables for functions
export NETWORK_RANGE PORTS TIMEOUT JSON_OUTPUT VERBOSE

# Execute command
case "$COMMAND" in
    scan)
        scan_network
        ;;
    services)
        list_services
        ;;
    health)
        check_health
        ;;
    map|network)
        echo -e "${YELLOW}üó∫Ô∏è Network mapping not yet implemented${NC}"
        echo -e "${CYAN}Use 'pai-context-discovery services' to see discovered services${NC}"
        ;;
    status)
        echo -e "${PURPLE}üìä ${BOLD}${WHITE}DISCOVERY ENGINE STATUS${NC} ${PURPLE}‚ö°${NC}"
        echo -e "${CYAN}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo -e "${CYAN}üìÅ Data directory: $DISCOVERY_DATA_DIR${NC}"
        echo -e "${CYAN}üóÑÔ∏è  Services database: $SERVICES_DB${NC}"
        echo -e "${CYAN}üó∫Ô∏è  Network map: $NETWORK_MAP${NC}"
        echo -e "${CYAN}‚ù§Ô∏è  Health status: $HEALTH_STATUS${NC}"
        ;;
    export)
        echo -e "${YELLOW}üì§ Export functionality not yet implemented${NC}"
        ;;
    import)
        echo -e "${YELLOW}üì• Import functionality not yet implemented${NC}"
        ;;
    *)
        echo -e "${RED}‚ùå Invalid command: $COMMAND${NC}" >&2
        show_help >&2
        exit 3
        ;;
esac

exit 0
