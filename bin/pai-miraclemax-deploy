#!/bin/bash
#
# pai-miraclemax-deploy - GitOps deployment for MiracleMax infrastructure
#
# Description:
#   Deploys MiracleMax infrastructure from Git repository using Ansible
#   Implements GitOps methodology: Git as single source of truth
#
# Usage:
#   pai-miraclemax-deploy [OPTIONS]
#
# Options:
#   --check         Dry-run mode (check what would be deployed)
#   --diff          Show differences between current and new config
#   --verbose       Enable verbose output
#   --skip-backup   Skip backing up existing infrastructure
#   --restart       Restart all services after deployment
#
# Location: /home/jbyrd/pai/bin/pai-miraclemax-deploy
# Author: Hatter (PAI System)
# Date: 2025-10-16

set -euo pipefail

# Configuration
REPO_DIR="/home/jbyrd/pai/repositories/pai-infrastructure-automation"
PLAYBOOK="$REPO_DIR/miraclemax-deploy.yml"
INVENTORY="$REPO_DIR/inventory/miraclemax.yml"
LOG_FILE="/home/jbyrd/.local/share/pai/logs/miraclemax-deploy.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Options
CHECK_MODE=""
DIFF_MODE=""
VERBOSE=""
EXTRA_VARS=""
RESTART_SERVICES=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --check)
            CHECK_MODE="--check"
            shift
            ;;
        --diff)
            DIFF_MODE="--diff"
            shift
            ;;
        --verbose|-v)
            VERBOSE="-vv"
            shift
            ;;
        --skip-backup)
            EXTRA_VARS="$EXTRA_VARS -e skip_backup=true"
            shift
            ;;
        --restart)
            RESTART_SERVICES=true
            shift
            ;;
        -h|--help)
            grep '^#' "$0" | grep -v '#!/bin/bash' | sed 's/^# \?//'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Create log directory
mkdir -p "$(dirname "$LOG_FILE")"

echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║         MiracleMax GitOps Deployment                                 ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Verify we're in a Git repository
if ! cd "$REPO_DIR" 2>/dev/null; then
    echo -e "${RED}✗ Repository not found: $REPO_DIR${NC}"
    exit 1
fi

# Check for uncommitted changes
if [[ -n $(git status --porcelain) ]]; then
    echo -e "${YELLOW}⚠ Warning: You have uncommitted changes in the repository${NC}"
    echo -e "${YELLOW}  Consider committing changes before deployment${NC}"
    git status --short
    echo ""
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Deployment cancelled"
        exit 0
    fi
fi

# Show current Git status
CURRENT_COMMIT=$(git rev-parse --short HEAD)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
log "Deploying from: $CURRENT_BRANCH ($CURRENT_COMMIT)"
echo -e "${BLUE}→ Source: $CURRENT_BRANCH @ $CURRENT_COMMIT${NC}"
echo ""

# Verify Ansible is available
if ! command -v ansible-playbook &> /dev/null; then
    echo -e "${RED}✗ Ansible not found. Install with: dnf install ansible${NC}"
    exit 1
fi

# Verify connectivity to MiracleMax
echo -e "${BLUE}→ Testing connection to MiracleMax...${NC}"
if ! ansible miraclemax -i "$INVENTORY" -m ping &>/dev/null; then
    echo -e "${RED}✗ Cannot reach MiracleMax. Check SSH connectivity${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Connection established${NC}"
echo ""

# Run Ansible playbook
log "Running Ansible deployment"
echo -e "${BLUE}━━━ Ansible Deployment ━━━${NC}"
echo ""

if ansible-playbook \
    -i "$INVENTORY" \
    "$PLAYBOOK" \
    $CHECK_MODE \
    $DIFF_MODE \
    $VERBOSE \
    $EXTRA_VARS \
    2>&1 | tee -a "$LOG_FILE"; then
    
    echo ""
    echo -e "${GREEN}✓ Deployment completed successfully${NC}"
    log "Deployment successful"
    
    # Restart services if requested
    if [ "$RESTART_SERVICES" = true ] && [ -z "$CHECK_MODE" ]; then
        echo ""
        echo -e "${BLUE}━━━ Restarting Services ━━━${NC}"
        ssh jbyrd@192.168.1.34 'cd ~/miraclemax-infrastructure/compose && for f in *.yml; do podman-compose -f $f restart; done'
        echo -e "${GREEN}✓ Services restarted${NC}"
    fi
    
    # Show deployment summary
    echo ""
    echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║         Deployment Summary                                           ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "  Source: $CURRENT_BRANCH @ $CURRENT_COMMIT"
    echo "  Mode: $([ -n "$CHECK_MODE" ] && echo "DRY-RUN" || echo "LIVE")"
    echo "  Target: miraclemax.local (192.168.1.34)"
    echo "  Log: $LOG_FILE"
    echo ""
    echo "Next Steps:"
    echo "  1. Verify services: ssh jbyrd@192.168.1.34 'podman ps'"
    echo "  2. Check logs: ssh jbyrd@192.168.1.34 'podman logs <container>'"
    echo "  3. Test endpoints: curl http://192.168.1.34:8080"
    echo ""
    
    exit 0
else
    echo ""
    echo -e "${RED}✗ Deployment failed${NC}"
    echo -e "${RED}  Check logs: $LOG_FILE${NC}"
    log "Deployment failed"
    exit 1
fi
