#!/usr/bin/env bash
set -euo pipefail

# PAI GitLab Webhook Manager
# Part of the Personal AI Infrastructure (PAI)
# Created for Hatter - Red Hat Digital Assistant

SCRIPT_DIR="$(dirname "$0")"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
WEBHOOK_SCRIPT="$PROJECT_ROOT/src/gitlab_webhook_receiver.py"
PID_FILE="$HOME/.config/pai/gitlab-webhook.pid"
LOG_FILE="$HOME/.config/pai/logs/gitlab-webhook.log"
CONFIG_DIR="$HOME/.config/pai"

# Ensure directories exist
mkdir -p "$CONFIG_DIR/logs"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Check if Python is installed
check_python() {
    if ! command -v python3 >/dev/null 2>&1; then
        print_error "Python 3 is not installed."
        exit 1
    fi
}

# Check and install Python dependencies
check_dependencies() {
    print_info "Checking Python dependencies..."
    
    # Check if Flask is installed
    if ! python3 -c "import flask" 2>/dev/null; then
        print_warning "Flask not installed. Installing..."
        pip3 install --user flask || {
            print_error "Failed to install Flask"
            exit 1
        }
        print_success "Flask installed"
    fi
}

# Get webhook status
get_status() {
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            echo "running:$pid"
            return 0
        else
            echo "stopped"
            rm -f "$PID_FILE"
            return 1
        fi
    else
        echo "stopped"
        return 1
    fi
}

# Start webhook server
start_webhook() {
    check_python
    check_dependencies
    
    local status=$(get_status)
    if [[ "$status" == running:* ]]; then
        local pid="${status#running:}"
        print_success "GitLab webhook server already running (PID: $pid)"
        print_info "URL: http://localhost:3002/webhook/gitlab"
        return 0
    fi
    
    print_info "Starting PAI GitLab webhook receiver..."
    
    # Export configuration from environment or use defaults
    export GITLAB_WEBHOOK_PORT="${GITLAB_WEBHOOK_PORT:-3002}"
    export GITLAB_WEBHOOK_EMAIL="${GITLAB_WEBHOOK_EMAIL:-${USER}@redhat.com}"
    export GITLAB_WEBHOOK_FROM="${GITLAB_WEBHOOK_FROM:-hatter@localhost}"
    export SMTP_SERVER="${SMTP_SERVER:-localhost}"
    export SMTP_PORT="${SMTP_PORT:-25}"
    
    # Start server in background
    nohup python3 "$WEBHOOK_SCRIPT" > "$LOG_FILE" 2>&1 &
    local server_pid=$!
    
    # Save PID
    echo $server_pid > "$PID_FILE"
    
    # Wait and verify startup
    sleep 2
    if kill -0 "$server_pid" 2>/dev/null; then
        print_success "GitLab webhook server started"
        echo ""
        print_info "Process ID: $server_pid"
        print_info "Server URL: http://localhost:${GITLAB_WEBHOOK_PORT}/webhook/gitlab"
        print_info "Health Check: http://localhost:${GITLAB_WEBHOOK_PORT}/health"
        print_info "Statistics: http://localhost:${GITLAB_WEBHOOK_PORT}/stats"
        print_info "Email notifications: ${GITLAB_WEBHOOK_EMAIL}"
        print_info "Logs: $LOG_FILE"
        echo ""
        print_warning "Configure GitLab webhook:"
        print_info "URL: http://$(hostname -f):${GITLAB_WEBHOOK_PORT}/webhook/gitlab"
        print_info "Secret Token: (set GITLAB_WEBHOOK_SECRET env var)"
        print_info "Trigger: Issues events"
    else
        print_error "Failed to start webhook server"
        rm -f "$PID_FILE"
        exit 1
    fi
}

# Stop webhook server
stop_webhook() {
    local status=$(get_status)
    if [[ "$status" != running:* ]]; then
        print_error "GitLab webhook server is not running"
        return 1
    fi
    
    local pid="${status#running:}"
    print_info "Stopping GitLab webhook server (PID: $pid)..."
    
    if kill "$pid" 2>/dev/null; then
        # Wait for process to stop
        local wait_count=0
        while kill -0 "$pid" 2>/dev/null && [[ $wait_count -lt 10 ]]; do
            sleep 1
            ((wait_count++))
        done
        
        if kill -0 "$pid" 2>/dev/null; then
            print_warning "Process didn't stop gracefully, forcing..."
            kill -9 "$pid" 2>/dev/null || true
        fi
        
        rm -f "$PID_FILE"
        print_success "GitLab webhook server stopped"
    else
        print_error "Failed to stop webhook server"
        rm -f "$PID_FILE"
        return 1
    fi
}

# Restart webhook server
restart_webhook() {
    print_info "Restarting GitLab webhook server..."
    stop_webhook || true
    sleep 1
    start_webhook
}

# Show webhook status
status_webhook() {
    local status=$(get_status)
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "PAI GitLab Webhook Server Status"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    
    if [[ "$status" == running:* ]]; then
        local pid="${status#running:}"
        print_success "Status: Running (PID: $pid)"
        
        # Get port from config
        local port="${GITLAB_WEBHOOK_PORT:-3002}"
        echo ""
        echo "Service Information:"
        echo "  • Port: $port"
        echo "  • Webhook URL: http://localhost:$port/webhook/gitlab"
        echo "  • Health Check: http://localhost:$port/health"
        echo "  • Statistics: http://localhost:$port/stats"
        echo "  • Email: ${GITLAB_WEBHOOK_EMAIL:-${USER}@redhat.com}"
        echo "  • Log File: $LOG_FILE"
        echo ""
        
        # Test health endpoint
        if command -v curl >/dev/null 2>&1; then
            local health_response=$(curl -s "http://localhost:$port/health" 2>/dev/null || echo "")
            if [[ -n "$health_response" ]]; then
                print_success "Health check: OK"
            else
                print_warning "Health check: Unable to reach server"
            fi
        fi
    else
        print_error "Status: Stopped"
        echo ""
        echo "Start with: pai-gitlab-webhook start"
    fi
    
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
}

# Show logs
show_logs() {
    if [[ ! -f "$LOG_FILE" ]]; then
        print_error "Log file not found: $LOG_FILE"
        return 1
    fi
    
    local lines="${1:-50}"
    print_info "Showing last $lines lines of webhook logs..."
    echo ""
    tail -n "$lines" "$LOG_FILE"
}

# Test webhook
test_webhook() {
    local status=$(get_status)
    if [[ "$status" != running:* ]]; then
        print_error "GitLab webhook server is not running. Start it first."
        return 1
    fi
    
    local port="${GITLAB_WEBHOOK_PORT:-3002}"
    print_info "Testing GitLab webhook receiver..."
    
    # Test health endpoint
    print_info "Testing health endpoint..."
    local health=$(curl -s "http://localhost:$port/health" 2>/dev/null || echo "")
    if [[ -n "$health" ]]; then
        print_success "Health check passed"
        echo "$health" | python3 -m json.tool 2>/dev/null || echo "$health"
    else
        print_error "Health check failed"
        return 1
    fi
    
    echo ""
    print_info "Test complete. Webhook receiver is operational."
    print_info "Configure GitLab to send webhooks to: http://$(hostname -f):$port/webhook/gitlab"
}

# Show usage
usage() {
    cat << EOF
PAI GitLab Webhook Manager

Usage: pai-gitlab-webhook <command>

Commands:
  start       Start the GitLab webhook receiver
  stop        Stop the GitLab webhook receiver
  restart     Restart the GitLab webhook receiver
  status      Show webhook server status
  logs [N]    Show last N lines of logs (default: 50)
  test        Test webhook server health
  help        Show this help message

Environment Variables:
  GITLAB_WEBHOOK_PORT     Port to listen on (default: 3002)
  GITLAB_WEBHOOK_EMAIL    Email address for notifications (default: \$USER@redhat.com)
  GITLAB_WEBHOOK_FROM     From address for emails (default: hatter@localhost)
  GITLAB_WEBHOOK_SECRET   Secret token for webhook verification (optional)
  SMTP_SERVER             SMTP server address (default: localhost)
  SMTP_PORT               SMTP server port (default: 25)

Examples:
  pai-gitlab-webhook start
  pai-gitlab-webhook status
  pai-gitlab-webhook logs 100
  GITLAB_WEBHOOK_EMAIL=myemail@redhat.com pai-gitlab-webhook start

EOF
}

# Main command handler
main() {
    case "${1:-}" in
        start)
            start_webhook
            ;;
        stop)
            stop_webhook
            ;;
        restart)
            restart_webhook
            ;;
        status)
            status_webhook
            ;;
        logs)
            show_logs "${2:-50}"
            ;;
        test)
            test_webhook
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            print_error "Unknown command: ${1:-}"
            echo ""
            usage
            exit 1
            ;;
    esac
}

main "$@"

