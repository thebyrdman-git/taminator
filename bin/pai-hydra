#!/usr/bin/env python3

"""
pai-hydra - Red Hat Hydra API Query Tool
Purpose: Ad-hoc lookups and queries against the Hydra API for TAM workflows
"""

import argparse
import json
import os
import sys
import requests
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional, Any

# PAI audit logging
def log_audit(action: str, details: str = ""):
    """Log to PAI audit system"""
    try:
        os.system(f'pai-audit log HYDRA_API "{action}" "{details}"')
    except:
        pass

class HydraClient:
    """Hydra API client with Red Hat authentication"""

    def __init__(self):
        self.base_url = "https://access.redhat.com/hydra/rest"
        self.access_token = None
        self.session = requests.Session()

        # Get offline token from config
        self.config_file = Path.home() / '.config' / 'tamscripts' / 'tamscripts.config'
        self.load_config()

    def load_config(self):
        """Load authentication from environment variables"""
        self.username = os.getenv('REDHAT_USERNAME')
        self.password = os.getenv('REDHAT_PASSWORD')

        if not self.username or not self.password:
            print("‚ùå Missing authentication credentials")
            print("   Set REDHAT_USERNAME and REDHAT_PASSWORD environment variables")
            sys.exit(1)

    def make_request(self, endpoint: str, params: Dict = None) -> Dict:
        """Make authenticated request to Hydra API using basic auth"""
        url = f"{self.base_url}{endpoint}"

        try:
            response = self.session.get(
                url,
                auth=(self.username, self.password),
                params=params,
                headers={"Accept": "application/json"}
            )
            response.raise_for_status()

            if response.text.strip():
                return response.json()
            else:
                return {}

        except requests.exceptions.HTTPError as e:
            print(f"‚ùå API Error: {e}")
            print(f"   URL: {url}")
            if hasattr(e.response, 'text'):
                print(f"   Response: {e.response.text}")
            sys.exit(1)
        except json.JSONDecodeError as e:
            print(f"‚ùå Invalid JSON response: {e}")
            print(f"   Raw response: {response.text}")
            sys.exit(1)
        except Exception as e:
            print(f"‚ùå Request failed: {e}")
            sys.exit(1)

def cmd_lookup_email(args):
    """Look up SSO username by email address"""
    client = HydraClient()

    # Use the notifyees endpoint to search by email
    # This searches across all accounts that the user has access to
    print(f"üîç Looking up SSO username for email: {args.email}")

    # Try different account contexts - we'll search through accessible accounts
    accounts_to_try = ["999625", "1460290", "540155"]  # Common accounts: Discover, CIBC, BNY

    found_contacts = []

    for account in accounts_to_try:
        try:
            print(f"   Searching in account {account}...")
            endpoint = f"/v1/accounts/{account}/notifyees/{args.email}"
            result = client.make_request(endpoint)

            if result and len(result) > 0:
                for contact in result:
                    if contact.get('email', '').lower() == args.email.lower():
                        found_contacts.append({
                            'account': account,
                            'sso_username': contact.get('ssoUserName', 'N/A'),
                            'email': contact.get('email'),
                            'name': f"{contact.get('firstName', '')} {contact.get('lastName', '')}".strip(),
                            'contact_type': contact.get('contactType', 'Unknown')
                        })
                        print(f"   ‚úÖ Found in account {account}")
        except:
            # Account access denied or not found - continue searching
            continue

    if found_contacts:
        print(f"\nüìã Found {len(found_contacts)} matching contact(s):")
        for contact in found_contacts:
            print(f"   Account: {contact['account']}")
            print(f"   SSO Username: {contact['sso_username']}")
            print(f"   Name: {contact['name']}")
            print(f"   Contact Type: {contact['contact_type']}")
            print()

        log_audit("email_lookup_success", f"email={args.email},contacts_found={len(found_contacts)}")

        if args.format == 'json':
            print(json.dumps(found_contacts, indent=2))
    else:
        print(f"‚ùå No SSO username found for email: {args.email}")
        print("   Searched accessible accounts - contact may not exist or no access")
        log_audit("email_lookup_failed", f"email={args.email}")

def cmd_lookup_sso(args):
    """Look up contact details by SSO username"""
    client = HydraClient()

    print(f"üîç Looking up contact details for SSO: {args.sso}")

    try:
        endpoint = f"/contacts/sso/{args.sso}"
        result = client.make_request(endpoint)

        if result:
            print(f"üìã Contact details for {args.sso}:")
            print(f"   Name: {result.get('firstName', '')} {result.get('lastName', '')}".strip())
            print(f"   Email: {result.get('email', 'N/A')}")
            print(f"   Phone: {result.get('phone', 'N/A')}")
            print(f"   Country: {result.get('country', 'N/A')}")
            print(f"   Company: {result.get('company', 'N/A')}")
            print(f"   Contact Type: {result.get('contactType', 'N/A')}")

            log_audit("sso_lookup_success", f"sso={args.sso}")

            if args.format == 'json':
                print("\nJSON Output:")
                print(json.dumps(result, indent=2))
        else:
            print(f"‚ùå No contact found for SSO: {args.sso}")
            log_audit("sso_lookup_failed", f"sso={args.sso}")

    except Exception as e:
        print(f"‚ùå Lookup failed: {e}")
        log_audit("sso_lookup_error", f"sso={args.sso},error={str(e)}")

def cmd_case_info(args):
    """Get basic case information"""
    client = HydraClient()

    print(f"üîç Looking up case: {args.case}")

    try:
        endpoint = f"/v1/cases/{args.case}"
        result = client.make_request(endpoint)

        if result:
            print(f"üìã Case {args.case} details:")
            print(f"   Summary: {result.get('summary', 'N/A')}")
            print(f"   Status: {result.get('status', 'N/A')}")
            print(f"   Severity: {result.get('severity', 'N/A')}")
            print(f"   Product: {result.get('product', 'N/A')}")
            print(f"   Owner: {result.get('ownerId', 'N/A')}")
            print(f"   Account: {result.get('accountNumberRef', 'N/A')}")
            print(f"   Created: {result.get('createdDate', 'N/A')}")
            print(f"   Updated: {result.get('lastModifiedDate', 'N/A')}")

            log_audit("case_lookup_success", f"case={args.case}")

            if args.format == 'json':
                print("\nJSON Output:")
                print(json.dumps(result, indent=2))
        else:
            print(f"‚ùå Case not found: {args.case}")
            log_audit("case_lookup_failed", f"case={args.case}")

    except Exception as e:
        print(f"‚ùå Case lookup failed: {e}")
        log_audit("case_lookup_error", f"case={args.case},error={str(e)}")

def cmd_account_contacts(args):
    """List contacts for an account"""
    client = HydraClient()

    print(f"üîç Looking up contacts for account: {args.account}")

    try:
        endpoint = f"/v1/accounts/{args.account}/contacts"
        result = client.make_request(endpoint)

        if result:
            contacts = result if isinstance(result, list) else [result]
            print(f"üìã Found {len(contacts)} contact(s) for account {args.account}:")

            for contact in contacts:
                print(f"   SSO: {contact.get('ssoUserName', 'N/A')}")
                print(f"   Name: {contact.get('firstName', '')} {contact.get('lastName', '')}".strip())
                print(f"   Email: {contact.get('email', 'N/A')}")
                print(f"   Type: {contact.get('contactType', 'N/A')}")
                print("   ---")

            log_audit("account_contacts_success", f"account={args.account},count={len(contacts)}")

            if args.format == 'json':
                print("\nJSON Output:")
                print(json.dumps(result, indent=2))
        else:
            print(f"‚ùå No contacts found for account: {args.account}")
            log_audit("account_contacts_failed", f"account={args.account}")

    except Exception as e:
        print(f"‚ùå Account contacts lookup failed: {e}")
        log_audit("account_contacts_error", f"account={args.account},error={str(e)}")

def cmd_test_auth(args):
    """Test Hydra API authentication"""
    client = HydraClient()

    print("üîê Testing Hydra API authentication...")

    try:
        print(f"   Username: {client.username}")
        print(f"   Password: {'*' * len(client.password) if client.password else 'Not set'}")

        # Test a simple API call
        print("\nüß™ Testing API access...")
        try:
            # Try a basic endpoint that should always work
            endpoint = "/v1/businesshours"
            result = client.make_request(endpoint, params={"timezone": "UTC"})
            print("‚úÖ Authentication and API access confirmed")
            log_audit("auth_test_success", "hydra_api_accessible")

            if args.format == 'json':
                print("\nAPI Test Response:")
                print(json.dumps(result, indent=2))

        except Exception as api_error:
            print(f"‚ö†Ô∏è Authentication configured but API access failed: {api_error}")
            log_audit("auth_test_partial", f"auth_configured_api_failed={str(api_error)}")

    except Exception as e:
        print(f"‚ùå Authentication test failed: {e}")
        log_audit("auth_test_failed", f"error={str(e)}")

def main():
    parser = argparse.ArgumentParser(
        description="PAI Hydra API Query Tool - Ad-hoc lookups against Red Hat Hydra API",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Look up SSO username by email
  pai-hydra email john.doe@company.com

  # Look up contact details by SSO
  pai-hydra sso jdoe

  # Get case information
  pai-hydra case 04245934

  # List account contacts
  pai-hydra contacts 999625

  # Test authentication
  pai-hydra auth
        """
    )

    parser.add_argument('--format', choices=['text', 'json'], default='text',
                       help='Output format (default: text)')

    subparsers = parser.add_subparsers(dest='command', help='Available commands')

    # Email lookup command
    email_parser = subparsers.add_parser('email', help='Look up SSO username by email address')
    email_parser.add_argument('email', help='Email address to lookup')
    email_parser.set_defaults(func=cmd_lookup_email)

    # SSO lookup command
    sso_parser = subparsers.add_parser('sso', help='Look up contact details by SSO username')
    sso_parser.add_argument('sso', help='SSO username to lookup')
    sso_parser.set_defaults(func=cmd_lookup_sso)

    # Case info command
    case_parser = subparsers.add_parser('case', help='Get case information')
    case_parser.add_argument('case', help='Case number (e.g., 04245934)')
    case_parser.set_defaults(func=cmd_case_info)

    # Account contacts command
    contacts_parser = subparsers.add_parser('contacts', help='List contacts for an account')
    contacts_parser.add_argument('account', help='Account number (e.g., 999625)')
    contacts_parser.set_defaults(func=cmd_account_contacts)

    # Auth test command
    auth_parser = subparsers.add_parser('auth', help='Test Hydra API authentication')
    auth_parser.set_defaults(func=cmd_test_auth)

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    # Execute the selected command
    try:
        args.func(args)
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è Operation cancelled by user")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå Unexpected error: {e}")
        log_audit("hydra_tool_error", f"command={args.command},error={str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()