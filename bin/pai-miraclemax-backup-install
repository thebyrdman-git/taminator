#!/bin/bash
#
# pai-miraclemax-backup-install - Install MiracleMax backup automation
#
# Description:
#   Installs and enables systemd timer for automated MiracleMax backups
#
# Usage:
#   pai-miraclemax-backup-install
#
# Location: /home/jbyrd/pai/bin/pai-miraclemax-backup-install
# Author: Hatter (PAI System)
# Date: 2025-10-16

set -euo pipefail

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║         MiracleMax Backup Automation Installer                       ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Check if running as user (not root)
if [ "$EUID" -eq 0 ]; then
    echo -e "${RED}✗ Do not run as root. Run as regular user.${NC}"
    exit 1
fi

# Create directories
echo -e "${BLUE}→ Creating directories...${NC}"
mkdir -p ~/backups/miraclemax
mkdir -p ~/.local/share/pai/logs
mkdir -p ~/.config/systemd/user
sudo mkdir -p /var/lib/node_exporter/textfile_collector
sudo chown jbyrd:jbyrd /var/lib/node_exporter/textfile_collector
echo -e "${GREEN}✓ Directories created${NC}"

# Install systemd user units
echo -e "${BLUE}→ Installing systemd units...${NC}"
cp /home/jbyrd/pai/systemd/pai-miraclemax-backup.service ~/.config/systemd/user/
cp /home/jbyrd/pai/systemd/pai-miraclemax-backup.timer ~/.config/systemd/user/
echo -e "${GREEN}✓ Systemd units installed${NC}"

# Reload systemd
echo -e "${BLUE}→ Reloading systemd...${NC}"
systemctl --user daemon-reload
echo -e "${GREEN}✓ Systemd reloaded${NC}"

# Enable timer
echo -e "${BLUE}→ Enabling backup timer...${NC}"
systemctl --user enable pai-miraclemax-backup.timer
systemctl --user start pai-miraclemax-backup.timer
echo -e "${GREEN}✓ Backup timer enabled and started${NC}"

# Enable lingering (allows user services to run when not logged in)
echo -e "${BLUE}→ Enabling user lingering...${NC}"
sudo loginctl enable-linger $USER
echo -e "${GREEN}✓ User lingering enabled${NC}"

# Check GPG key
echo -e "${BLUE}→ Checking GPG configuration...${NC}"
if gpg --list-keys jbyrd@redhat.com >/dev/null 2>&1; then
    echo -e "${GREEN}✓ GPG key found for jbyrd@redhat.com${NC}"
else
    echo -e "${YELLOW}⚠ WARNING: No GPG key found for jbyrd@redhat.com${NC}"
    echo -e "${YELLOW}  Backup will work, but encryption requires GPG key setup${NC}"
    echo -e "${YELLOW}  Run: gpg --gen-key and follow prompts${NC}"
fi

# Check SSH connectivity
echo -e "${BLUE}→ Checking MiracleMax connectivity...${NC}"
if ssh -o ConnectTimeout=5 jbyrd@192.168.1.34 "echo 'Connection OK'" >/dev/null 2>&1; then
    echo -e "${GREEN}✓ Can reach miraclemax at 192.168.1.34${NC}"
else
    echo -e "${YELLOW}⚠ WARNING: Cannot reach miraclemax at 192.168.1.34${NC}"
    echo -e "${YELLOW}  Backup will fail until connectivity is restored${NC}"
fi

# Show timer status
echo ""
echo -e "${BLUE}═══ Installation Complete ═══${NC}"
echo ""
systemctl --user list-timers pai-miraclemax-backup.timer
echo ""

# Next steps
echo -e "${BLUE}╔═══════════════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║         Next Steps                                                   ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  1. Test backup manually:"
echo -e "     ${BLUE}pai-miraclemax-backup${NC}"
echo ""
echo -e "  2. Verify backup created successfully:"
echo -e "     ${BLUE}ls -lh ~/backups/miraclemax/latest/${NC}"
echo ""
echo -e "  3. Test restore (dry-run):"
echo -e "     ${BLUE}pai-miraclemax-restore --latest --dry-run${NC}"
echo ""
echo -e "  4. Check timer status:"
echo -e "     ${BLUE}systemctl --user status pai-miraclemax-backup.timer${NC}"
echo ""
echo -e "  5. View backup logs:"
echo -e "     ${BLUE}journalctl --user -u pai-miraclemax-backup.service${NC}"
echo ""
echo -e "  Backup Schedule: Daily at 3:00 AM"
echo -e "  Retention: 30 days"
echo -e "  Next Run: $(systemctl --user list-timers pai-miraclemax-backup.timer --no-pager | grep miraclemax | awk '{print $1, $2, $3, $4}')"
echo ""

