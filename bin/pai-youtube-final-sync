#!/bin/bash

# Final YouTube downloader - gets latest videos without date restrictions

set -euo pipefail

STORAGE_DIR="/mnt/nfs_share/charles/youtube"

echo "ðŸš€ FINAL YOUTUBE SYNC - GETTING LATEST VIDEOS"
echo "=============================================="
echo "Storage: $STORAGE_DIR"
echo "Getting the latest videos from each channel..."
echo ""

# Create storage with proper permissions
sudo mkdir -p "$STORAGE_DIR"
sudo chmod 777 "$STORAGE_DIR"

# Using confirmed working channel ID from Kurzgesagt (we saw it downloading)
CHANNELS=(
    "UCsXVk37bltHxD1rDPwtNM8Q:Kurzgesagt"
)

total_downloaded=0
total_videos=0

for channel_info in "${CHANNELS[@]}"; do
    IFS=':' read -r channel_id channel_name <<< "$channel_info"
    
    echo "ðŸ“º Processing: $channel_name"
    echo "   Channel ID: $channel_id"
    
    # Create channel directory
    channel_dir="$STORAGE_DIR/$channel_name"
    sudo mkdir -p "$channel_dir"
    sudo chmod 777 "$channel_dir"
    
    # Count videos before download
    before_count=$(find "$channel_dir" -name "*.mp4" 2>/dev/null | wc -l)
    
    # Download LATEST videos (no date filter, just get the newest 3)
    echo "   Downloading latest 3 videos..."
    if yt-dlp \
        --format "best[height<=720]/best" \
        --output "$channel_dir/%(upload_date)s - %(title)s.%(ext)s" \
        --playlist-end 3 \
        --no-overwrites \
        --ignore-errors \
        "https://www.youtube.com/channel/$channel_id/videos"; then
        
        # Count videos after download
        after_count=$(find "$channel_dir" -name "*.mp4" 2>/dev/null | wc -l)
        new_videos=$((after_count - before_count))
        
        if [[ $new_videos -gt 0 ]]; then
            echo "   âœ… Downloaded $new_videos videos!"
            ((total_downloaded++))
            ((total_videos += new_videos))
            
            # Show what we got
            echo "   ðŸ“¹ Files downloaded:"
            ls -la "$channel_dir"/*.mp4 2>/dev/null | tail -3 || echo "   (Files processing...)"
        else
            echo "   â„¹ï¸  No new videos"
        fi
    else
        echo "   âŒ Failed to download"
    fi
    
    echo ""
done

# Fix all permissions for Plex
echo "ðŸ”§ Setting permissions for Plex..."
sudo chown -R plex:plex "$STORAGE_DIR"
sudo chmod -R 755 "$STORAGE_DIR"

echo ""
echo "ðŸŽ‰ SUCCESS! VIDEOS ARE DOWNLOADING!"
echo "=================================="
echo "Channels processed: ${#CHANNELS[@]}"
echo "Channels with new content: $total_downloaded"
echo "Total videos downloaded: $total_videos"
echo ""
echo "ðŸ“ Final check - what's in the storage:"
find "$STORAGE_DIR" -name "*.mp4" -ls 2>/dev/null || echo "Videos still processing..."
echo ""
echo "âœ… YouTube automation is WORKING!"
echo "âœ… Videos are in: $STORAGE_DIR"
echo "âœ… Plex can now scan and add them!"

