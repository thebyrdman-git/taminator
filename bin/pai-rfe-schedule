#!/usr/bin/env bash

# PAI RFE Schedule - Automated Scheduling Management for RFE Automation
# Purpose: Install, manage, and monitor automated RFE scheduling
# Usage: pai-rfe-schedule [--install|--remove|--status|--test|--help]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PAI_ROOT="$(dirname "$SCRIPT_DIR")"
CRON_CONFIG="$PAI_ROOT/config/rfe-automation-cron.txt"
CRON_BACKUP="/tmp/crontab-backup-$(date +%Y%m%d-%H%M%S).txt"

# Logging
LOG_FILE="/tmp/pai-rfe-schedule-$(date +%Y%m%d-%H%M%S).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2> >(tee -a "$LOG_FILE" >&2)

print_header() {
    echo -e "${CYAN}"
    echo "üìÖ PAI RFE SCHEDULE - Automated Scheduling Management"
    echo "=" * 55
    echo -e "${NC}"
    echo "üìÖ Current Time: $(date)"
    echo "üìÅ Log File: $LOG_FILE"
    echo "‚öôÔ∏è  Cron Config: $CRON_CONFIG"
    echo ""
}

print_section() {
    echo -e "${BLUE}$1${NC}"
    echo "$(echo "$1" | sed 's/./=/g')"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_info() {
    echo -e "${PURPLE}üí° $1${NC}"
}

backup_crontab() {
    print_info "Creating crontab backup..."
    
    if crontab -l > "$CRON_BACKUP" 2>/dev/null; then
        print_success "Crontab backed up to: $CRON_BACKUP"
        return 0
    else
        print_warning "No existing crontab found (this is normal for first-time setup)"
        touch "$CRON_BACKUP"
        return 0
    fi
}

install_cron_jobs() {
    print_section "üìÖ INSTALLING RFE AUTOMATION CRON JOBS"
    
    # Backup existing crontab
    backup_crontab
    
    # Check if RFE automation jobs already exist
    if crontab -l 2>/dev/null | grep -q "pai-rfe-monitor"; then
        print_warning "RFE automation cron jobs already exist"
        print_info "Use --remove first to clean up existing jobs"
        return 1
    fi
    
    # Validate cron configuration file
    if [[ ! -f "$CRON_CONFIG" ]]; then
        print_error "Cron configuration file not found: $CRON_CONFIG"
        return 1
    fi
    
    print_info "Installing cron jobs from: $CRON_CONFIG"
    
    # Create temporary combined crontab
    local temp_cron="/tmp/combined-crontab-$(date +%Y%m%d-%H%M%S).txt"
    
    # Add existing crontab (if any)
    if [[ -s "$CRON_BACKUP" ]]; then
        cat "$CRON_BACKUP" > "$temp_cron"
        echo "" >> "$temp_cron"
        echo "# === RFE AUTOMATION SYSTEM JOBS ===" >> "$temp_cron"
    else
        echo "# RFE Automation System - Cron Jobs" > "$temp_cron"
        echo "# Installed: $(date)" >> "$temp_cron"
        echo "" >> "$temp_cron"
    fi
    
    # Add RFE automation jobs (skip comments and empty lines)
    grep -v '^#' "$CRON_CONFIG" | grep -v '^$' >> "$temp_cron"
    
    # Install the combined crontab
    if crontab "$temp_cron"; then
        print_success "RFE automation cron jobs installed successfully"
        
        # Show installed jobs
        echo ""
        print_info "Installed cron jobs:"
        crontab -l | grep -E "(pai-rfe|pai-weekly|pai-alerts|pai-maintenance)" | while read -r line; do
            echo "  üìÖ $line"
        done
        
        # Clean up temp file
        rm -f "$temp_cron"
        
        return 0
    else
        print_error "Failed to install cron jobs"
        rm -f "$temp_cron"
        return 1
    fi
}

remove_cron_jobs() {
    print_section "üóëÔ∏è  REMOVING RFE AUTOMATION CRON JOBS"
    
    # Backup existing crontab
    backup_crontab
    
    # Check if RFE automation jobs exist
    if ! crontab -l 2>/dev/null | grep -q "pai-rfe-monitor\|pai-weekly\|pai-alerts\|pai-maintenance"; then
        print_warning "No RFE automation cron jobs found"
        return 0
    fi
    
    print_info "Removing RFE automation cron jobs..."
    
    # Create temporary crontab without RFE jobs
    local temp_cron="/tmp/cleaned-crontab-$(date +%Y%m%d-%H%M%S).txt"
    
    # Remove RFE automation jobs
    crontab -l 2>/dev/null | grep -v -E "(pai-rfe|pai-weekly|pai-alerts|pai-maintenance)" > "$temp_cron"
    
    # Remove RFE automation section header if it exists
    sed -i '/# === RFE AUTOMATION SYSTEM JOBS ===/d' "$temp_cron"
    
    # Install cleaned crontab
    if crontab "$temp_cron"; then
        print_success "RFE automation cron jobs removed successfully"
        
        # Clean up temp file
        rm -f "$temp_cron"
        
        return 0
    else
        print_error "Failed to remove cron jobs"
        rm -f "$temp_cron"
        return 1
    fi
}

show_cron_status() {
    print_section "üìä RFE AUTOMATION SCHEDULING STATUS"
    
    # Check if cron service is running
    if systemctl is-active --quiet crond 2>/dev/null || systemctl is-active --quiet cron 2>/dev/null; then
        print_success "Cron service is running"
    else
        print_error "Cron service is not running"
        print_info "Start with: sudo systemctl start crond (or cron)"
    fi
    
    # Check for RFE automation jobs
    local rfe_jobs=$(crontab -l 2>/dev/null | grep -E "(pai-rfe|pai-weekly|pai-alerts|pai-maintenance)" | wc -l)
    
    if [[ $rfe_jobs -gt 0 ]]; then
        print_success "RFE automation jobs installed: $rfe_jobs jobs"
        
        echo ""
        print_info "Scheduled RFE automation jobs:"
        crontab -l 2>/dev/null | grep -E "(pai-rfe|pai-weekly|pai-alerts|pai-maintenance)" | while read -r line; do
            # Parse cron schedule
            local schedule=$(echo "$line" | cut -d' ' -f1-5)
            local command=$(echo "$line" | cut -d' ' -f6-)
            
            # Convert to human readable time (simplified)
            local hour=$(echo "$schedule" | cut -d' ' -f2)
            local minute=$(echo "$schedule" | cut -d' ' -f1)
            local day_of_week=$(echo "$schedule" | cut -d' ' -f5)
            
            local time_desc=""
            if [[ "$day_of_week" == "*" ]]; then
                time_desc="Daily at ${hour}:$(printf "%02d" $minute) UTC"
            elif [[ "$day_of_week" == "3" ]]; then
                time_desc="Wednesdays at ${hour}:$(printf "%02d" $minute) UTC"
            elif [[ "$day_of_week" == "0" ]]; then
                time_desc="Sundays at ${hour}:$(printf "%02d" $minute) UTC"
            else
                time_desc="Schedule: $schedule"
            fi
            
            echo "  üìÖ $time_desc"
            echo "     Command: $(basename "$(echo "$command" | cut -d' ' -f1)")"
        done
    else
        print_warning "No RFE automation jobs installed"
        print_info "Use --install to set up automated scheduling"
    fi
    
    # Show recent cron logs
    echo ""
    print_info "Recent automation logs:"
    
    local log_files=(
        "/tmp/rfe-automation-cron.log"
        "/tmp/weekly-troubleshooting-cron.log"
        "/tmp/system-health-cron.log"
    )
    
    for log_file in "${log_files[@]}"; do
        if [[ -f "$log_file" ]]; then
            local last_run=$(stat -c %y "$log_file" 2>/dev/null | cut -d' ' -f1-2)
            local size=$(stat -c %s "$log_file" 2>/dev/null)
            echo "  üìÅ $(basename "$log_file"): Last run $last_run ($size bytes)"
        fi
    done
}

test_scheduled_automation() {
    print_section "üß™ TESTING SCHEDULED AUTOMATION"
    
    print_info "Testing RFE automation system readiness..."
    
    # Test system validation
    if /home/jbyrd/hatter-pai/bin/pai-rfe-deploy --validate > /dev/null 2>&1; then
        print_success "System validation: PASSED"
    else
        print_error "System validation: FAILED"
        print_info "Run 'pai-rfe-deploy --validate' for details"
    fi
    
    # Test monitoring system
    if /home/jbyrd/hatter-pai/bin/pai-rfe-monitor --test-system > /dev/null 2>&1; then
        print_success "Monitoring system: OPERATIONAL"
    else
        print_error "Monitoring system: FAILED"
        print_info "Run 'pai-rfe-monitor --test-system' for details"
    fi
    
    # Test individual customer automation (dry run)
    echo ""
    print_info "Testing customer automation (test mode)..."
    
    for customer in wellsfargo tdbank; do
        if /home/jbyrd/hatter-pai/bin/pai-rfe-monitor "$customer" --test > /dev/null 2>&1; then
            print_success "$customer automation: READY"
        else
            print_warning "$customer automation: ISSUES DETECTED"
            print_info "Run 'pai-rfe-monitor $customer --test' for details"
        fi
    done
    
    echo ""
    print_info "Scheduled automation test completed"
    print_info "Check individual components if any issues were detected"
}

show_help() {
    echo "PAI RFE Schedule - Automated Scheduling Management"
    echo ""
    echo "Usage: pai-rfe-schedule [OPTION]"
    echo ""
    echo "Options:"
    echo "  --install     Install RFE automation cron jobs"
    echo "  --remove      Remove RFE automation cron jobs"
    echo "  --status      Show scheduling status and recent logs"
    echo "  --test        Test scheduled automation readiness"
    echo "  --help        Show this help message"
    echo ""
    echo "Scheduled Jobs:"
    echo "  üìÖ Daily RFE Updates:        9:00 AM EST (14:00 UTC)"
    echo "  üìä System Health Check:      8:30 AM EST (13:30 UTC)"
    echo "  üìã Weekly Troubleshooting:   Wed 9:00 AM EST (varies by customer)"
    echo "  üßπ Alert Cleanup:            Sun 2:00 AM EST (7:00 UTC)"
    echo "  üîß Monthly Maintenance:      1st Sun 3:00 AM EST (8:00 UTC)"
    echo ""
    echo "Log Files:"
    echo "  üìÅ RFE Automation:           /tmp/rfe-automation-cron.log"
    echo "  üìÅ System Health:            /tmp/system-health-cron.log"
    echo "  üìÅ Weekly Reports:           /tmp/weekly-troubleshooting-cron.log"
    echo "  üìÅ Alert Cleanup:            /tmp/alert-cleanup-cron.log"
    echo ""
    echo "Examples:"
    echo "  pai-rfe-schedule --install    # Set up automated scheduling"
    echo "  pai-rfe-schedule --status     # Check current status"
    echo "  pai-rfe-schedule --test       # Test system readiness"
}

main() {
    print_header
    
    case "${1:-}" in
        --install)
            install_cron_jobs
            ;;
        --remove)
            remove_cron_jobs
            ;;
        --status)
            show_cron_status
            ;;
        --test)
            test_scheduled_automation
            ;;
        --help|"")
            show_help
            ;;
        *)
            print_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"
