#!/usr/bin/env python3

"""
PAI Contact Intelligence System
Enhanced contact research using Hydra API + multi-source intelligence
"""

import os
import re
import json
import requests
import argparse
from datetime import datetime, timezone
from pathlib import Path
import subprocess

# Configuration
PAI_DIR = Path.home() / '.claude' / 'context'
OUTPUT_DIR = PAI_DIR / 'create' / 'outputs' / 'contacts'
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

class ContactIntelligence:
    def __init__(self):
        self.rhcase_available = self._check_rhcase()
        
    def _check_rhcase(self):
        """Check if rhcase is available for Hydra API calls"""
        try:
            subprocess.run(['which', 'rhcase'], check=True, capture_output=True)
            return True
        except subprocess.CalledProcessError:
            return False
    
    def get_account_contacts(self, account_number):
        """Get all contacts for an account via Hydra API"""
        if not self.rhcase_available:
            print("‚ùå rhcase not available - cannot access Hydra API")
            return []
            
        try:
            # Use rhcase to call Hydra API
            cmd = ['rhcase', 'hydra-api', f'/v1/accounts/{account_number}/contacts']
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            return json.loads(result.stdout)
        except (subprocess.CalledProcessError, json.JSONDecodeError) as e:
            print(f"‚ö†Ô∏è Error getting contacts for account {account_number}: {e}")
            return []
    
    def get_contact_by_sso(self, sso_username):
        """Get contact by SSO username via Hydra API"""
        if not self.rhcase_available:
            return None
            
        try:
            cmd = ['rhcase', 'hydra-api', f'/contacts/sso/{sso_username}']
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            return json.loads(result.stdout)
        except (subprocess.CalledProcessError, json.JSONDecodeError) as e:
            print(f"‚ö†Ô∏è Error getting contact for SSO {sso_username}: {e}")
            return None
    
    def get_email_intelligence(self, email_address):
        """Extract intelligence from email interactions"""
        intelligence = {
            'email': email_address,
            'domain': email_address.split('@')[1] if '@' in email_address else '',
            'interactions': [],
            'signatures': [],
            'meeting_history': []
        }
        
        # Search email history using pai-email-processor
        try:
            cmd = ['pai-email-processor', 'search', email_address]
            result = subprocess.run(cmd, capture_output=True, text=True)
            if result.returncode == 0:
                intelligence['interactions'] = result.stdout.strip().split('\n')
        except:
            pass
            
        # Search calendar history
        try:
            cmd = ['pai-calendar', 'search', email_address]
            result = subprocess.run(cmd, capture_output=True, text=True)
            if result.returncode == 0:
                intelligence['meeting_history'] = result.stdout.strip().split('\n')
        except:
            pass
            
        return intelligence
    
    def research_company_domain(self, domain):
        """Research company information from domain"""
        company_info = {
            'domain': domain,
            'company_name': '',
            'description': '',
            'size': '',
            'industry': '',
            'team_pages': [],
            'public_contacts': []
        }
        
        # Use fabric for company research with web search
        try:
            cmd = ['fabric', '-p', 'research_company', '-m', 'perplexity-sonar-large']
            research_query = f"Research company information for domain {domain}: company name, industry, size, key contacts"
            result = subprocess.run(cmd, input=research_query, capture_output=True, text=True)
            if result.returncode == 0:
                company_info['description'] = result.stdout.strip()
        except:
            pass
            
        return company_info
    
    def create_contact_dossier(self, email_address, name=None):
        """Create comprehensive contact dossier"""
        print(f"üîç Creating comprehensive dossier for {email_address}")
        
        dossier = {
            'email': email_address,
            'name': name,
            'created': datetime.now(timezone.utc).isoformat(),
            'hydra_data': {},
            'email_intelligence': {},
            'company_info': {},
            'recommendations': []
        }
        
        # 1. Get Hydra/Salesforce data if available
        domain = email_address.split('@')[1] if '@' in email_address else ''
        
        # Try to find contact in Hydra by SSO (often email prefix)
        sso_username = email_address.split('@')[0]
        hydra_contact = self.get_contact_by_sso(sso_username)
        if hydra_contact:
            dossier['hydra_data'] = hydra_contact
            print(f"‚úÖ Found Hydra contact data for {sso_username}")
        
        # 2. Get email intelligence
        dossier['email_intelligence'] = self.get_email_intelligence(email_address)
        
        # 3. Research company domain
        if domain:
            dossier['company_info'] = self.research_company_domain(domain)
        
        # 4. Generate recommendations
        recommendations = []
        if hydra_contact:
            if hydra_contact.get('timezone'):
                recommendations.append(f"Contact timezone: {hydra_contact['timezone']}")
            if hydra_contact.get('phone'):
                recommendations.append(f"Direct phone available: {hydra_contact['phone']}")
            if hydra_contact.get('isOrgAdmin'):
                recommendations.append("‚ö†Ô∏è This contact is an Org Admin - key decision maker")
            if hydra_contact.get('canManageCases'):
                recommendations.append("‚úÖ Can manage support cases")
                
        dossier['recommendations'] = recommendations
        
        # 5. Save dossier
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"contact-dossier-{email_address.replace('@', '-at-').replace('.', '-')}-{timestamp}.md"
        output_file = OUTPUT_DIR / filename
        
        markdown_content = self._create_dossier_markdown(dossier)
        with open(output_file, 'w') as f:
            f.write(markdown_content)
        
        print(f"üìÑ Dossier saved: {output_file}")
        
        # Log to audit
        subprocess.run(['pai-audit', 'log', 'CONTACT_RESEARCH', 
                       f'email={email_address} hydra_found={bool(hydra_contact)}'], check=False)
        
        return output_file
    
    def _create_dossier_markdown(self, dossier):
        """Create markdown dossier from contact data"""
        email = dossier['email']
        name = dossier['name'] or 'Unknown'
        
        content = f"""---
title: "Contact Dossier - {email}"
email: "{email}"
name: "{name}"
created: "{dossier['created']}"
type: "contact_dossier"
tags: [contact, dossier, {email.split('@')[1] if '@' in email else 'unknown'}]
---

# Contact Dossier - {email}

**Name**: {name}  
**Email**: {email}  
**Generated**: {dossier['created']}

## Hydra/Salesforce Data
"""
        
        if dossier['hydra_data']:
            hd = dossier['hydra_data']
            content += f"""
**Full Name**: {hd.get('firstName', '')} {hd.get('lastName', '')}  
**Email**: {hd.get('email', 'N/A')}  
**Phone**: {hd.get('phone', 'N/A')}  
**Support Phone**: {hd.get('supportPhoneNumber', 'N/A')}  
**Timezone**: {hd.get('timezone', 'N/A')}  
**SSO Username**: {hd.get('ssoUsername', 'N/A')}  

### Permissions & Access
- **Is Entitled**: {hd.get('isEntitled', False)}
- **Is Org Admin**: {hd.get('isOrgAdmin', False)}
- **Can Manage Cases**: {hd.get('canManageCases', False)}
- **Can Add Attachments**: {hd.get('canAddAttachments', False)}
- **Has Chat**: {hd.get('hasChat', False)}
"""
        else:
            content += "\n*No Hydra/Salesforce data found*\n"
        
        content += f"""
## Email Intelligence
**Domain**: {dossier['email_intelligence'].get('domain', 'N/A')}  
**Interaction Count**: {len(dossier['email_intelligence'].get('interactions', []))}  
**Meeting History**: {len(dossier['email_intelligence'].get('meeting_history', []))}  

## Company Information
{dossier['company_info'].get('description', 'No company research available')}

## Recommendations
"""
        
        for rec in dossier['recommendations']:
            content += f"- {rec}\n"
        
        if not dossier['recommendations']:
            content += "- No specific recommendations at this time\n"
        
        content += f"""
## Related Commands
```bash
# Update this dossier
pai-contact-intelligence contact {email} --update

# Research company domain
pai-contact-intelligence company-research {email.split('@')[1] if '@' in email else ''}

# Find related cases
pai-workspace search {email}
```

---
Generated by pai-contact-intelligence
"""
        
        return content
    
    def research_company(self, domain_or_email):
        """Research company information"""
        if '@' in domain_or_email:
            domain = domain_or_email.split('@')[1]
        else:
            domain = domain_or_email
            
        print(f"üè¢ Researching company: {domain}")
        
        company_info = self.research_company_domain(domain)
        
        # Save company research
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f"company-research-{domain.replace('.', '-')}-{timestamp}.md"
        output_file = OUTPUT_DIR / filename
        
        content = f"""---
title: "Company Research - {domain}"
domain: "{domain}"
created: "{datetime.now(timezone.utc).isoformat()}"
type: "company_research"
tags: [company, research, {domain.replace('.', '-')}]
---

# Company Research - {domain}

**Domain**: {domain}  
**Generated**: {datetime.now(timezone.utc).isoformat()}

## Company Information
{company_info.get('description', 'Research in progress...')}

## Key Findings
- **Industry**: {company_info.get('industry', 'Unknown')}
- **Size**: {company_info.get('size', 'Unknown')}
- **Description**: {company_info.get('description', 'N/A')}

## Related Contacts
(To be populated with account contact searches)

---
Generated by pai-contact-intelligence
"""
        
        with open(output_file, 'w') as f:
            f.write(content)
        
        print(f"üìÑ Company research saved: {output_file}")
        return output_file

def main():
    parser = argparse.ArgumentParser(description='PAI Contact Intelligence System')
    subparsers = parser.add_subparsers(dest='command', help='Available commands')
    
    # Contact dossier command
    contact_parser = subparsers.add_parser('contact', help='Create contact dossier')
    contact_parser.add_argument('email', help='Email address to research')
    contact_parser.add_argument('--name', help='Contact name (optional)')
    contact_parser.add_argument('--update', action='store_true', help='Update existing dossier')
    
    # Company research command
    company_parser = subparsers.add_parser('company-research', help='Research company')
    company_parser.add_argument('domain', help='Domain or email to research')
    
    # Account contacts command
    account_parser = subparsers.add_parser('account-contacts', help='Get all contacts for account')
    account_parser.add_argument('account_number', help='Account number')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    intelligence = ContactIntelligence()
    
    if args.command == 'contact':
        intelligence.create_contact_dossier(args.email, args.name)
    elif args.command == 'company-research':
        intelligence.research_company(args.domain)
    elif args.command == 'account-contacts':
        contacts = intelligence.get_account_contacts(args.account_number)
        print(f"Found {len(contacts)} contacts for account {args.account_number}")
        for contact in contacts:
            name = f"{contact.get('firstName', '')} {contact.get('lastName', '')}"
            email = contact.get('email', 'N/A')
            print(f"  - {name.strip()} <{email}>")

if __name__ == '__main__':
    main()