#!/bin/bash

# TAM RFE Report Scheduler
# Schedule automated reports and case summaries

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCHEDULER_ROOT="$(dirname "$SCRIPT_DIR")"
CONFIG_DIR="$HOME/.config/tam-rfe-scheduler"
SCHEDULES_FILE="$CONFIG_DIR/schedules.yaml"

# Colors (Sys Admin style - minimal)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Ensure config directory exists
mkdir -p "$CONFIG_DIR"

# Initialize schedules file if it doesn't exist
if [[ ! -f "$SCHEDULES_FILE" ]]; then
    cat > "$SCHEDULES_FILE" <<EOF
# TAM RFE Report Schedules
# Format: YAML
schedules:
EOF
fi

show_help() {
    echo "TAM RFE Report Scheduler"
    echo "========================"
    echo "Schedule automated reports and case summaries."
    echo ""
    echo "Aliases: tam-rfe-schedule, tam-rfe-scheduler, active-case-report-scheduler"
    echo ""
    echo "Usage: tam-rfe-schedule <command> [options]"
    echo ""
    echo "Commands:"
    echo "  add          Add new scheduled report"
    echo "  list         Show all schedules"
    echo "  remove <id>  Remove schedule"
    echo "  run <id>     Execute schedule now (testing)"
    echo "  start        Start scheduler daemon (automatic execution)"
    echo "  stop         Stop scheduler daemon"
    echo "  restart      Restart scheduler daemon"
    echo "  status       Show daemon status"
    echo "  logs [id]    View execution history"
    echo "  help         Show this help"
    echo ""
    echo "Basic Example:"
    echo "  tam-rfe-schedule add \"Westpac Weekly\" \\"
    echo "    --command \"tam-rfe-chat 'Westpac summary'\" \\"
    echo "    --frequency \"0 8 * * 1\" \\"
    echo "    --email jbyrd@redhat.com"
    echo ""
    echo "Advanced Examples (Phase 3):"
    echo "  # With template"
    echo "  tam-rfe-schedule add \"Weekly Digest\" \\"
    echo "    --command \"...\" --frequency \"0 8 * * 1\" \\"
    echo "    --email you@redhat.com --template weekly_digest"
    echo ""
    echo "  # With condition"
    echo "  tam-rfe-schedule add \"Sev 1 Alert\" \\"
    echo "    --command \"...\" --frequency \"0 * * * *\" \\"
    echo "    --email you@redhat.com --condition \"sev1_count > 0\" \\"
    echo "    --pre-check \"tam-rfe-chat 'Count Sev 1'\""
    echo ""
    echo "  # With Slack"
    echo "  tam-rfe-schedule add \"Team Update\" \\"
    echo "    --command \"...\" --frequency \"0 9 * * 1\" \\"
    echo "    --slack-webhook \"https://hooks.slack.com/...\""
    echo ""
    echo "Commands:"
    echo "  tam-rfe-schedule start        # Start automatic execution"
    echo "  tam-rfe-schedule list"
    echo "  tam-rfe-schedule run westpac-weekly"
    echo "  tam-rfe-schedule logs westpac-weekly"
    echo ""
}

cmd_add() {
    local name=""
    local command=""
    local frequency=""
    local email=""
    local format="text"
    local template="plain"
    local condition="always"
    local pre_check=""
    local slack_webhook=""
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --command)
                command="$2"
                shift 2
                ;;
            --frequency)
                frequency="$2"
                shift 2
                ;;
            --email)
                email="$2"
                shift 2
                ;;
            --format)
                format="$2"
                shift 2
                ;;
            --template)
                template="$2"
                shift 2
                ;;
            --condition)
                condition="$2"
                shift 2
                ;;
            --pre-check)
                pre_check="$2"
                shift 2
                ;;
            --slack-webhook)
                slack_webhook="$2"
                shift 2
                ;;
            *)
                if [[ -z "$name" ]]; then
                    name="$1"
                fi
                shift
                ;;
        esac
    done
    
    # Validate required fields
    if [[ -z "$name" ]] || [[ -z "$command" ]] || [[ -z "$frequency" ]] || [[ -z "$email" ]]; then
        echo -e "${RED}❌ Missing required fields${NC}"
        echo "Required: name, --command, --frequency, --email"
        return 1
    fi
    
    # Generate schedule ID from name
    local schedule_id=$(echo "$name" | tr '[:upper:]' '[:lower:]' | tr -s ' ' | tr ' ' '-' | sed 's/[^a-z0-9-]//g')
    
    # Check if schedule already exists
    if grep -q "id: $schedule_id" "$SCHEDULES_FILE" 2>/dev/null; then
        echo -e "${RED}❌ Schedule '$schedule_id' already exists${NC}"
        echo "Use: tam-rfe-schedule remove $schedule_id"
        return 1
    fi
    
    # Ensure schedules file has proper structure
    if ! grep -q "^schedules:" "$SCHEDULES_FILE"; then
        echo "schedules:" > "$SCHEDULES_FILE"
    fi
    
    # Add schedule to YAML file (proper indent) with Phase 3 fields
    cat >> "$SCHEDULES_FILE" <<EOF
  - id: $schedule_id
    name: "$name"
    command: "$command"
    frequency: "$frequency"
    email: "$email"
    format: "$format"
    template: "$template"
    condition: "$condition"
EOF
    
    # Add optional fields if provided
    if [[ -n "$pre_check" ]]; then
        echo "    pre_check_command: \"$pre_check\"" >> "$SCHEDULES_FILE"
    fi
    if [[ -n "$slack_webhook" ]]; then
        echo "    slack_webhook: \"$slack_webhook\"" >> "$SCHEDULES_FILE"
    fi
    
    # Add standard fields
    cat >> "$SCHEDULES_FILE" <<EOF
    enabled: true
    created: $(date -Iseconds)
EOF
    
    echo -e "${GREEN}✅ Schedule added${NC}"
    echo "ID: $schedule_id"
    echo "Command: $command"
    echo "Frequency: $frequency (cron format)"
    echo "Email: $email"
    
    # Show Phase 3 features if configured
    if [[ "$template" != "plain" ]]; then
        echo "Template: $template"
    fi
    if [[ "$condition" != "always" ]]; then
        echo "Condition: $condition"
    fi
    if [[ -n "$pre_check" ]]; then
        echo "Pre-check: $pre_check"
    fi
    if [[ -n "$slack_webhook" ]]; then
        echo "Slack: configured"
    fi
    
    echo ""
    echo "Next: tam-rfe-schedule run $schedule_id  # Test it"
}

cmd_list() {
    if [[ ! -f "$SCHEDULES_FILE" ]] || ! grep -q "id:" "$SCHEDULES_FILE" 2>/dev/null; then
        echo "No schedules configured"
        echo ""
        echo "Add one: tam-rfe-schedule add \"Report Name\" --command \"...\" --frequency \"0 8 * * 1\" --email you@redhat.com"
        return 0
    fi
    
    echo "Scheduled Reports"
    echo "================="
    echo ""
    
    # Parse and display schedules
    local in_schedule=false
    local id="" name="" command="" frequency="" email="" enabled=""
    
    while IFS= read -r line; do
        if [[ "$line" =~ ^[[:space:]]*-[[:space:]]*id:[[:space:]]*(.*) ]]; then
            # Print previous schedule if exists
            if [[ -n "$id" ]]; then
                local status_icon="✅"
                [[ "$enabled" != "true" ]] && status_icon="⏸️ "
                echo "$status_icon $id: $name"
                echo "   Command: $command"
                echo "   Schedule: $frequency"
                echo "   Email: $email"
                echo ""
            fi
            # Start new schedule
            id="${BASH_REMATCH[1]}"
            name="" command="" frequency="" email="" enabled="true"
        elif [[ "$line" =~ ^[[:space:]]*name:[[:space:]]*(.*) ]]; then
            name="${BASH_REMATCH[1]}"
            name="${name//\"/}"  # Remove quotes
        elif [[ "$line" =~ ^[[:space:]]*command:[[:space:]]*(.*) ]]; then
            command="${BASH_REMATCH[1]}"
            command="${command//\"/}"
        elif [[ "$line" =~ ^[[:space:]]*frequency:[[:space:]]*(.*) ]]; then
            frequency="${BASH_REMATCH[1]}"
            frequency="${frequency//\"/}"
        elif [[ "$line" =~ ^[[:space:]]*email:[[:space:]]*(.*) ]]; then
            email="${BASH_REMATCH[1]}"
            email="${email//\"/}"
        elif [[ "$line" =~ ^[[:space:]]*enabled:[[:space:]]*(.*) ]]; then
            enabled="${BASH_REMATCH[1]}"
        fi
    done < "$SCHEDULES_FILE"
    
    # Print last schedule
    if [[ -n "$id" ]]; then
        local status_icon="✅"
        [[ "$enabled" != "true" ]] && status_icon="⏸️ "
        echo "$status_icon $id: $name"
        echo "   Command: $command"
        echo "   Schedule: $frequency"
        echo "   Email: $email"
        echo ""
    fi
}

cmd_remove() {
    local schedule_id="$1"
    
    if [[ -z "$schedule_id" ]]; then
        echo -e "${RED}❌ Schedule ID required${NC}"
        echo "Usage: tam-rfe-schedule remove <id>"
        return 1
    fi
    
    if ! grep -q "id: $schedule_id" "$SCHEDULES_FILE" 2>/dev/null; then
        echo -e "${RED}❌ Schedule '$schedule_id' not found${NC}"
        echo "Run: tam-rfe-schedule list"
        return 1
    fi
    
    # Remove schedule (simple approach: filter out the schedule block)
    # This is a basic implementation - could be improved with proper YAML parsing
    local temp_file=$(mktemp)
    awk -v id="$schedule_id" '
        /^  - id:/ { in_block = ($0 ~ id) }
        !in_block { print }
        /^  - id:/ && !($0 ~ id) { in_block = 0 }
    ' "$SCHEDULES_FILE" > "$temp_file"
    
    mv "$temp_file" "$SCHEDULES_FILE"
    
    echo -e "${GREEN}✅ Schedule removed: $schedule_id${NC}"
}

cmd_run() {
    local schedule_id="$1"
    
    if [[ -z "$schedule_id" ]]; then
        echo -e "${RED}❌ Schedule ID required${NC}"
        echo "Usage: tam-rfe-schedule run <id>"
        return 1
    fi
    
    # Extract command from schedule
    local command=$(awk -v id="$schedule_id" '
        /^  - id:/ { current = ($0 ~ id) }
        current && /command:/ { 
            sub(/.*command: *"?/, "")
            sub(/"?$/, "")
            print
            exit
        }
    ' "$SCHEDULES_FILE")
    
    if [[ -z "$command" ]]; then
        echo -e "${RED}❌ Schedule '$schedule_id' not found${NC}"
        return 1
    fi
    
    echo -e "${BLUE}ℹ️  Executing: $command${NC}"
    echo ""
    
    # Execute command and capture output
    local output_file=$(mktemp)
    local start_time=$(date +%s)
    
    if bash -c "cd $HOME && $command" > "$output_file" 2>&1; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        echo -e "${GREEN}✅ Command completed (${duration}s)${NC}"
        echo ""
        echo "Output:"
        cat "$output_file"
        
        # TODO: Send email with output
        echo ""
        echo "Note: Email delivery not yet implemented"
    else
        echo -e "${RED}❌ Command failed${NC}"
        cat "$output_file"
        rm "$output_file"
        return 1
    fi
    
    rm "$output_file"
}

cmd_start() {
    local pid_file="$CONFIG_DIR/daemon.pid"
    
    # Check if already running
    if [[ -f "$pid_file" ]]; then
        local pid=$(cat "$pid_file" 2>/dev/null)
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${YELLOW}⚠️  Daemon already running (PID: $pid)${NC}"
            return 1
        else
            # Stale PID file
            rm -f "$pid_file"
        fi
    fi
    
    # Find daemon script
    local daemon_script="$SCRIPT_DIR/tam-rfe-scheduler-daemon"
    if [[ ! -f "$daemon_script" ]]; then
        daemon_script="$(which tam-rfe-scheduler-daemon 2>/dev/null)"
    fi
    
    if [[ ! -f "$daemon_script" ]]; then
        echo -e "${RED}❌ Daemon script not found${NC}"
        echo "Expected: $SCRIPT_DIR/tam-rfe-scheduler-daemon"
        return 1
    fi
    
    echo -e "${BLUE}ℹ️  Starting scheduler daemon...${NC}"
    
    # Ensure logs directory exists
    mkdir -p "$CONFIG_DIR/logs"
    
    # Start daemon in background
    nohup "$daemon_script" > "$CONFIG_DIR/logs/daemon.out" 2>&1 &
    local daemon_pid=$!
    
    # Wait a moment and verify it's running
    sleep 2
    if kill -0 "$daemon_pid" 2>/dev/null; then
        echo -e "${GREEN}✅ Daemon started (PID: $daemon_pid)${NC}"
        echo "Log: $CONFIG_DIR/logs/daemon.log"
        echo ""
        echo "Commands:"
        echo "  tam-rfe-schedule status   # Check status"
        echo "  tam-rfe-schedule stop     # Stop daemon"
        echo "  tam-rfe-schedule logs     # View execution history"
    else
        echo -e "${RED}❌ Daemon failed to start${NC}"
        echo "Check: $CONFIG_DIR/logs/daemon.out"
        return 1
    fi
}

cmd_stop() {
    local pid_file="$CONFIG_DIR/daemon.pid"
    
    if [[ ! -f "$pid_file" ]]; then
        echo -e "${YELLOW}⚠️  Daemon not running${NC}"
        return 0
    fi
    
    local pid=$(cat "$pid_file" 2>/dev/null)
    
    if ! kill -0 "$pid" 2>/dev/null; then
        echo -e "${YELLOW}⚠️  Daemon not running (stale PID file)${NC}"
        rm -f "$pid_file"
        return 0
    fi
    
    echo -e "${BLUE}ℹ️  Stopping daemon (PID: $pid)...${NC}"
    
    # Send SIGTERM
    kill "$pid"
    
    # Wait for graceful shutdown (max 5 seconds)
    local count=0
    while kill -0 "$pid" 2>/dev/null && [[ $count -lt 10 ]]; do
        sleep 0.5
        ((count++))
    done
    
    # Force kill if still running
    if kill -0 "$pid" 2>/dev/null; then
        echo -e "${YELLOW}⚠️  Daemon not responding, forcing shutdown${NC}"
        kill -9 "$pid" 2>/dev/null || true
    fi
    
    # Clean up PID file
    rm -f "$pid_file"
    
    echo -e "${GREEN}✅ Daemon stopped${NC}"
}

cmd_restart() {
    echo "Restarting daemon..."
    cmd_stop
    sleep 1
    cmd_start
}

cmd_status() {
    echo "TAM RFE Scheduler Status"
    echo "========================"
    echo ""
    
    # Check daemon status
    local pid_file="$CONFIG_DIR/daemon.pid"
    if [[ -f "$pid_file" ]]; then
        local pid=$(cat "$pid_file" 2>/dev/null)
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${GREEN}✅ Daemon: Running (PID: $pid)${NC}"
            echo "Log: $CONFIG_DIR/logs/daemon.log"
        else
            echo -e "${RED}❌ Daemon: Not running (stale PID file)${NC}"
            rm -f "$pid_file"
        fi
    else
        echo -e "${YELLOW}⏸️  Daemon: Not running${NC}"
        echo "Start with: tam-rfe-schedule start"
    fi
    echo ""
    
    # Show schedule count
    local count=$(grep -c "id:" "$SCHEDULES_FILE" 2>/dev/null || echo "0")
    count=$(echo "$count" | tr -d '\n' | xargs)
    echo "Schedules configured: $count"
    
    if [[ $count -gt 0 ]]; then
        echo ""
        echo "Next execution times:"
        # TODO: Calculate next execution times from cron expressions
        grep -A 2 "id:" "$SCHEDULES_FILE" 2>/dev/null | grep -E "(id:|frequency:)" | paste - - | head -5
    fi
}

cmd_logs() {
    local schedule_id="${1:-}"
    local log_file="$CONFIG_DIR/logs/execution_history.jsonl"
    
    if [[ ! -f "$log_file" ]]; then
        echo "No execution history yet"
        echo ""
        echo "Logs will appear here after:"
        echo "  tam-rfe-schedule start  # Start daemon"
        echo "  # Wait for scheduled execution"
        return 0
    fi
    
    echo "Execution History"
    echo "================="
    echo ""
    
    if [[ -n "$schedule_id" ]]; then
        # Show logs for specific schedule
        echo "Schedule: $schedule_id"
        echo ""
        grep "\"schedule_id\":\"$schedule_id\"" "$log_file" | tail -10 | while IFS= read -r line; do
            # Parse JSON and display
            local timestamp=$(echo "$line" | grep -o '"timestamp":"[^"]*"' | cut -d'"' -f4)
            local duration=$(echo "$line" | grep -o '"duration":[0-9.]*' | cut -d':' -f2)
            local success=$(echo "$line" | grep -o '"success":[^,}]*' | cut -d':' -f2)
            
            if [[ "$success" == "true" ]]; then
                echo -e "${GREEN}✅${NC} $timestamp (${duration}s)"
            else
                echo -e "${RED}❌${NC} $timestamp (${duration}s)"
            fi
        done
    else
        # Show recent logs for all schedules
        tail -20 "$log_file" | while IFS= read -r line; do
            local schedule=$(echo "$line" | grep -o '"schedule_id":"[^"]*"' | cut -d'"' -f4)
            local timestamp=$(echo "$line" | grep -o '"timestamp":"[^"]*"' | cut -d'"' -f4 | sed 's/T/ /' | cut -d'.' -f1)
            local duration=$(echo "$line" | grep -o '"duration":[0-9.]*' | cut -d':' -f2 | xargs printf "%.1f")
            local success=$(echo "$line" | grep -o '"success":[^,}]*' | cut -d':' -f2)
            
            if [[ "$success" == "true" ]]; then
                echo -e "${GREEN}✅${NC} $schedule ($timestamp) ${duration}s"
            else
                echo -e "${RED}❌${NC} $schedule ($timestamp) ${duration}s"
            fi
        done
    fi
    
    echo ""
    echo "Full log: $log_file"
    echo "Daemon log: $CONFIG_DIR/logs/daemon.log"
}

# Main command dispatch
case "${1:-help}" in
    add)
        shift
        cmd_add "$@"
        ;;
    list|ls)
        cmd_list
        ;;
    remove|rm|delete)
        shift
        cmd_remove "$@"
        ;;
    run|execute)
        shift
        cmd_run "$@"
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}❌ Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac

