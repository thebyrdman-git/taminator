{% extends "base.html" %}

{% block title %}Subscriptions - Jimmy's YouTube System{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span class="material-icons">subscriptions</span>
        YouTube Subscriptions
    </h1>
    <p class="page-subtitle">Manage your {{ stats.total_channels }} YouTube channel subscriptions</p>
        </div>

<!-- Summary Cards -->
<div class="grid grid-cols-4 mb-24">
    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-blue); margin-bottom: 8px;">{{ stats.total_channels }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Total Channels</div>
        </div>
    </div>

    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-green); margin-bottom: 8px;">{{ categories|length }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Categories</div>
        </div>
    </div>

    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-yellow); margin-bottom: 8px;">{{ stats.get('active_channels', stats.total_channels) }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Active</div>
        </div>
        </div>
    
    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-gray-600); margin-bottom: 8px;">{{ stats.get('last_sync', 'Never') }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Last Sync</div>
        </div>
        </div>
        </div>

<!-- Categories Overview -->
{% if categories %}
<div class="card mb-24">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">category</span>
            Subscriptions by Category
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-2">
            {% for category, channels in categories.items() %}
            <div style="padding: 16px; border: 1px solid var(--google-gray-200); border-radius: 8px; margin-bottom: 12px;">
                <div class="flex items-center justify-between mb-16">
                    <h3 style="font-size: 16px; font-weight: 500; color: var(--google-gray-800);">
                        {% if category == 'Technology' %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">computer</span>
                        {% elif category == 'Entertainment' %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">movie</span>
                        {% elif category == 'Education' %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">school</span>
                        {% elif category == 'Music' %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">music_note</span>
                        {% elif category == 'Gaming' %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">sports_esports</span>
                        {% elif category == 'News' %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">newspaper</span>
                        {% else %}
                            <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">folder</span>
                        {% endif %}
                        {{ category }}
                    </h3>
                    <span class="status-indicator status-ready">{{ channels|length }} channels</span>
    </div>

                <div style="max-height: 160px; overflow-y: auto;">
                    {% for channel in channels %}
                    <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--google-gray-100);">
                        <span class="material-icons" style="font-size: 16px; margin-right: 8px; color: var(--google-gray-500);">play_circle_outline</span>
                        <span style="font-size: 14px; color: var(--google-gray-800); flex: 1;">{{ channel }}</span>
                        <span style="font-size: 12px; color: var(--google-gray-500);">Active</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="card-actions">
        <button onclick="syncSubscriptions()" class="google-btn google-btn-primary">
            <span class="material-icons">sync</span>
            Sync with YouTube
        </button>
        
        <button onclick="exportSubscriptions()" class="google-btn">
            <span class="material-icons">download</span>
            Export List
        </button>
    </div>
</div>
{% endif %}

<!-- All Subscriptions Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">list</span>
            All Subscriptions
        </h2>
    </div>
    <div class="card-content">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <span class="material-icons" style="font-size: 16px;">play_circle_outline</span>
                        </th>
                        <th>Channel Name</th>
                        <th>Category</th>
                        <th>Last Download</th>
                        <th>Status</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if subscriptions %}
                        {% for subscription in subscriptions %}
                        <tr>
                            <td>
                                <span class="material-icons" style="color: var(--google-blue); font-size: 18px;">smart_display</span>
                            </td>
                            <td style="font-weight: 500;">{{ subscription.channel_name or subscription.name }}</td>
                            <td>
                                <span class="status-indicator" style="background: var(--google-gray-100); color: var(--google-gray-700);">
                                    {{ subscription.category or 'Uncategorized' }}
                                </span>
                            </td>
                            <td style="color: var(--google-gray-600);">
                                {{ subscription.last_download or 'Never' }}
                            </td>
                            <td>
                                {% if subscription.status == 'downloaded' %}
                                    <span class="status-indicator status-ready">Ready</span>
                                {% elif subscription.status == 'downloading' %}
                                    <span class="status-indicator status-downloading">Downloading</span>
                                {% elif subscription.status == 'error' %}
                                    <span class="status-indicator status-error">Error</span>
                                {% else %}
                                    <span class="status-indicator" style="background: var(--google-gray-200); color: var(--google-gray-600);">Pending</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-12">
                                    <button onclick="downloadChannel('{{ subscription.channel_name or subscription.name }}')" 
                                            class="google-btn" style="padding: 6px 12px; font-size: 12px;">
                                        <span class="material-icons" style="font-size: 14px;">download</span>
                                    </button>
                                    
                                    <button onclick="viewChannel('{{ subscription.channel_url or subscription.url }}')" 
                                            class="google-btn" style="padding: 6px 12px; font-size: 12px;">
                                        <span class="material-icons" style="font-size: 14px;">open_in_new</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center" style="padding: 48px; color: var(--google-gray-500);">
                                <div>
                                    <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block;">subscriptions</span>
                                    <div style="font-size: 16px; margin-bottom: 8px;">No subscriptions found</div>
                                    <div style="font-size: 14px;">Sync with YouTube to load your subscriptions</div>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function syncSubscriptions() {
        showNotification('Syncing subscriptions with YouTube...', 'info');
        
        fetch('/api/sync_subscriptions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Subscriptions synced successfully!', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification(data.message || 'Sync failed', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error syncing subscriptions', 'error');
        });
    }
    
    function exportSubscriptions() {
        showNotification('Exporting subscription list...', 'info');
        window.open('/api/export_subscriptions', '_blank');
    }
    
    function downloadChannel(channelName) {
        if (confirm(`Download latest video from ${channelName}?`)) {
            showNotification(`Starting download from ${channelName}...`, 'info');
            
            fetch('/api/download_channel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    channel_name: channelName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Download started for ${channelName}!`, 'success');
        } else {
                    showNotification(data.message || 'Download failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error starting download', 'error');
            });
        }
    }
    
    function viewChannel(channelUrl) {
        if (channelUrl) {
            window.open(channelUrl, '_blank');
        }
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element (same as dashboard)
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--elevation-3);
            max-width: 320px;
            font-size: 14px;
        `;
        
        // Set color based on type
        switch(type) {
            case 'success':
                notification.style.background = 'var(--google-green)';
                break;
            case 'error':
                notification.style.background = 'var(--google-red)';
                break;
            case 'warning':
                notification.style.background = 'var(--google-yellow)';
                notification.style.color = 'var(--google-gray-800)';
                break;
            default:
                notification.style.background = 'var(--google-blue)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
</script>
{% endblock %}