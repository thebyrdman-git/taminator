{% extends "base.html" %}

{% block title %}Dashboard - Jimmy's YouTube System{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span class="material-icons">dashboard</span>
        Dashboard
    </h1>
    <p class="page-subtitle">Monitor and manage your YouTube automation system</p>
</div>

<!-- System Status Overview -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">system_security_update_good</span>
            System Status
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-4">
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 500; color: var(--google-blue); margin-bottom: 8px;" id="totalChannels">{{ stats.total_channels }}</div>
                <div style="font-size: 14px; color: var(--google-gray-600);">Total Channels</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 500; color: var(--google-green); margin-bottom: 8px;" id="downloadedVideos">{{ stats.get('actual_files', stats.get('total_downloads', 0)) }}</div>
                <div style="font-size: 14px; color: var(--google-gray-600);">Downloaded Videos</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 500; color: var(--google-yellow); margin-bottom: 8px;" id="lastUpdate">{{ stats.last_update or 'Never' }}</div>
                <div style="font-size: 14px; color: var(--google-gray-600);">Last Update</div>
            </div>
            <div style="text-align: center;">
                <div id="systemStatus" class="status-indicator status-ready">Ready</div>
                <div style="font-size: 14px; color: var(--google-gray-600); margin-top: 8px;">System Status</div>
            </div>
        </div>
    </div>
</div>

<!-- Download Progress -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">download</span>
            Download Progress
        </h2>
    </div>
    <div class="card-content">
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title" id="progressTitle">Ready to download from your {{ stats.total_channels }} YouTube subscriptions!</span>
                <span class="progress-percentage" id="progressPercentage">100%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 100%;"></div>
            </div>
            <div class="progress-text" id="progressText">ðŸ§¹ 90-day retention policy keeps storage optimized</div>
        </div>
    </div>
    <div class="card-actions">
        <button onclick="startDownloads()" class="google-btn google-btn-primary" id="downloadBtn">
            <span class="material-icons">play_arrow</span>
            Start Downloads
        </button>
        
        <button onclick="refreshSystem()" class="google-btn">
            <span class="material-icons">refresh</span>
            Refresh Status
        </button>
        
        <button onclick="runRetentionCleanup()" class="google-btn google-btn-warning">
            <span class="material-icons">cleaning_services</span>
            90-Day Cleanup
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-3">
    <!-- Recent Activity -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="material-icons">history</span>
                Recent Activity
            </h3>
        </div>
        <div class="card-content">
            <div style="color: var(--google-gray-600); font-size: 14px;">
                <div style="margin-bottom: 12px; padding: 12px; background: var(--google-gray-50); border-radius: 8px;">
                    <div style="font-weight: 500; color: var(--google-gray-800);">Latest Downloads</div>
                    <div style="font-size: 12px; margin-top: 4px;">Processing {{ stats.total_channels }} channels</div>
                </div>
                <div style="margin-bottom: 12px; padding: 12px; background: var(--google-gray-50); border-radius: 8px;">
                    <div style="font-weight: 500; color: var(--google-gray-800);">System Health</div>
                    <div style="font-size: 12px; margin-top: 4px;">All services operational</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Info -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="material-icons">storage</span>
                Storage Usage
            </h3>
        </div>
        <div class="card-content">
            <div style="color: var(--google-gray-600); font-size: 14px;">
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 500; color: var(--google-gray-800);">Media Library</div>
                    <div style="font-size: 12px; margin-top: 4px;">{{ stats.get('actual_files', stats.get('total_downloads', 0)) }} videos stored</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 500; color: var(--google-gray-800);">Retention Policy</div>
                    <div style="font-size: 12px; margin-top: 4px;">90-day automatic cleanup</div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Performance -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="material-icons">speed</span>
                Performance
            </h3>
        </div>
        <div class="card-content">
            <div style="color: var(--google-gray-600); font-size: 14px;">
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 500; color: var(--google-gray-800);">Download Speed</div>
                    <div style="font-size: 12px; margin-top: 4px;">Optimized for quality</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 500; color: var(--google-gray-800);">Plex Integration</div>
                    <div style="font-size: 12px; margin-top: 4px;">Auto-refresh enabled</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">bolt</span>
            Quick Actions
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-4">
            <a href="/subscriptions" class="google-btn" style="justify-content: center;">
                <span class="material-icons">subscriptions</span>
                Manage Subscriptions
            </a>
            
            <a href="/downloads" class="google-btn" style="justify-content: center;">
                <span class="material-icons">download</span>
                View Downloads
            </a>
            
            <a href="http://192.168.1.17:32400" target="_blank" class="google-btn" style="justify-content: center;">
                <span class="material-icons">play_circle</span>
                Open Plex
            </a>
            
            <a href="/settings" class="google-btn" style="justify-content: center;">
                <span class="material-icons">settings</span>
                System Settings
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let downloadInProgress = false;
    
    function startDownloads() {
        if (downloadInProgress) {
            showNotification('Downloads already in progress', 'warning');
            return;
        }
        
        const btn = document.getElementById('downloadBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons">hourglass_empty</span>Starting...';
        
        downloadInProgress = true;
        
        fetch('/api/start_downloads', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Downloads started successfully!', 'success');
                updateProgressBar();
            } else {
                showNotification(data.message || 'Failed to start downloads', 'error');
                downloadInProgress = false;
                resetDownloadButton();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error starting downloads', 'error');
            downloadInProgress = false;
            resetDownloadButton();
        });
    }
    
    function refreshSystem() {
        showNotification('Refreshing system status...', 'info');
        location.reload();
    }
    
    function runRetentionCleanup() {
        if (confirm('This will remove videos older than 90 days. Continue?')) {
            showNotification('Starting 90-day cleanup...', 'info');
            
            fetch('/api/retention_cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('90-day cleanup completed!', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotification(data.error || 'Cleanup failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error running cleanup', 'error');
            });
        }
    }
    
    function updateProgressBar() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = document.getElementById('progressPercentage');
                const progressTitle = document.getElementById('progressTitle');
                const progressText = document.getElementById('progressText');
                const systemStatus = document.getElementById('systemStatus');
                
                // Update progress bar
                progressBar.style.width = data.progress + '%';
                progressPercentage.textContent = data.progress + '%';
                
                if (data.active) {
                    progressTitle.textContent = 'Downloading from YouTube channels...';
                    progressText.textContent = `Current: ${data.current_channel} (${data.completed_channels}/${data.total_channels} completed)`;
                    progressText.className = 'progress-text';
                    systemStatus.className = 'status-indicator status-downloading';
                    systemStatus.textContent = 'Downloading';
                    
                    document.getElementById('downloadBtn').disabled = true;
                    document.getElementById('downloadBtn').innerHTML = '<span class="material-icons">downloading</span>Downloading...';
                    
                } else if (data.progress === 100) {
                    progressTitle.textContent = `Ready to download from your {{ stats.total_channels }} YouTube subscriptions!`;
                    progressText.textContent = `âœ… Last completed: ${data.current_channel || 'System ready'}`;
                    progressText.className = 'progress-text';
                    systemStatus.className = 'status-indicator status-ready';
                    systemStatus.textContent = 'Ready';
                    
                    downloadInProgress = false;
                    resetDownloadButton();
                    
                    // Update stats
                    document.getElementById('downloadedVideos').textContent = data.downloaded_videos || data.completed_channels;
                }
                
                // Continue polling if downloading
                if (data.active) {
                    setTimeout(updateProgressBar, 2000);
                }
            })
            .catch(error => {
                console.log('Status update failed:', error);
                if (downloadInProgress) {
                    setTimeout(updateProgressBar, 5000);
                }
            });
    }
    
    function resetDownloadButton() {
        const btn = document.getElementById('downloadBtn');
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">play_arrow</span>Start Downloads';
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--elevation-3);
            max-width: 320px;
            font-size: 14px;
        `;
        
        // Set color based on type
        switch(type) {
            case 'success':
                notification.style.background = 'var(--google-green)';
                break;
            case 'error':
                notification.style.background = 'var(--google-red)';
                break;
            case 'warning':
                notification.style.background = 'var(--google-yellow)';
                notification.style.color = 'var(--google-gray-800)';
                break;
            default:
                notification.style.background = 'var(--google-blue)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // Auto-refresh progress during downloads every 2 seconds
    function initializeProgressMonitoring() {
        updateProgressBar();
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeProgressMonitoring);
</script>
{% endblock %}