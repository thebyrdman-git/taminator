{% extends "base.html" %}

{% block title %}Settings - Jimmy's YouTube System{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span class="material-icons">settings</span>
        System Settings
    </h1>
    <p class="page-subtitle">Configure and manage your YouTube automation system</p>
    </div>

    <!-- System Configuration -->
<div class="card mb-24">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">tune</span>
            Download Configuration
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-2">
            <div style="padding: 16px; border: 1px solid var(--google-gray-200); border-radius: 8px;">
                <h3 style="font-size: 16px; font-weight: 500; color: var(--google-gray-800); margin-bottom: 16px; display: flex; align-items: center;">
                    <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">video_settings</span>
                    Video Quality
                </h3>
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                        <input type="radio" name="quality" value="best" checked style="margin-right: 8px;">
                        Best Available Quality
                    </label>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                        <input type="radio" name="quality" value="1080p" style="margin-right: 8px;">
                        1080p HD
                    </label>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                        <input type="radio" name="quality" value="720p" style="margin-right: 8px;">
                        720p HD
                    </label>
            </div>
            </div>
            
            <div style="padding: 16px; border: 1px solid var(--google-gray-200); border-radius: 8px;">
                <h3 style="font-size: 16px; font-weight: 500; color: var(--google-gray-800); margin-bottom: 16px; display: flex; align-items: center;">
                    <span class="material-icons" style="font-size: 18px; margin-right: 8px; color: var(--google-blue);">schedule</span>
                    Download Schedule
                </h3>
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                        <input type="checkbox" checked style="margin-right: 8px;">
                        Automatic downloads enabled
                    </label>
            </div>
                <div style="margin-bottom: 12px;">
                    <label style="display: block; color: var(--google-gray-700); font-size: 14px; margin-bottom: 4px;">
                        Check for new videos every:
                    </label>
                    <select style="padding: 8px; border: 1px solid var(--google-gray-300); border-radius: 4px; font-size: 14px;">
                        <option value="1">1 hour</option>
                        <option value="6" selected>6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                </select>
                </div>
            </div>
        </div>
    </div>
    <div class="card-actions">
        <button onclick="saveDownloadSettings()" class="google-btn google-btn-primary">
            <span class="material-icons">save</span>
            Save Settings
        </button>
        </div>
    </div>

<!-- Storage Management -->
<div class="card mb-24">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">storage</span>
            Storage Management
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-3">
            <div class="text-center">
                <div style="font-size: 24px; font-weight: 500; color: var(--google-blue); margin-bottom: 8px;">{{ stats.get('storage_used', '0 GB') }}</div>
                <div style="font-size: 14px; color: var(--google-gray-600);">Storage Used</div>
            </div>
            
            <div class="text-center">
                <div style="font-size: 24px; font-weight: 500; color: var(--google-green); margin-bottom: 8px;">{{ stats.get('storage_available', '0 GB') }}</div>
                <div style="font-size: 14px; color: var(--google-gray-600);">Available</div>
            </div>
            
            <div class="text-center">
                <div style="font-size: 24px; font-weight: 500; color: var(--google-yellow); margin-bottom: 8px;">90 days</div>
                <div style="font-size: 14px; color: var(--google-gray-600);">Retention Policy</div>
            </div>
        </div>
        
        <div style="margin-top: 24px; padding: 16px; background: var(--google-gray-50); border-radius: 8px;">
            <h4 style="font-size: 14px; font-weight: 500; color: var(--google-gray-800); margin-bottom: 8px;">
                Retention Policy Settings
            </h4>
            <p style="font-size: 13px; color: var(--google-gray-600); margin-bottom: 16px;">
                Videos older than 90 days are automatically removed to optimize storage usage. 
                Recently watched and favorited videos are protected from cleanup.
            </p>
            
            <div class="flex gap-16">
                <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                    <input type="number" value="90" min="7" max="365" style="width: 80px; padding: 6px; border: 1px solid var(--google-gray-300); border-radius: 4px; margin-right: 8px;">
                    days retention
                </label>
                
                <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                    <input type="checkbox" checked style="margin-right: 8px;">
                    Protect recently watched
                </label>
                
                <label style="display: flex; align-items: center; color: var(--google-gray-700); font-size: 14px;">
                    <input type="checkbox" checked style="margin-right: 8px;">
                    Protect favorites
                </label>
            </div>
        </div>
    </div>
    <div class="card-actions">
        <button onclick="saveStorageSettings()" class="google-btn google-btn-primary">
            <span class="material-icons">save</span>
            Save Storage Settings
        </button>
        
        <button onclick="runCleanupNow()" class="google-btn google-btn-warning">
            <span class="material-icons">cleaning_services</span>
            Run Cleanup Now
            </button>
        
        <button onclick="analyzeStorage()" class="google-btn">
            <span class="material-icons">analytics</span>
            Analyze Storage
            </button>
        </div>
    </div>

    <!-- System Information -->
<div class="grid grid-cols-2">
    <!-- System Status -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="material-icons">info</span>
                System Information
            </h3>
        </div>
        <div class="card-content">
            <div style="color: var(--google-gray-700); font-size: 14px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid var(--google-gray-100);">
                    <span>Download Location:</span>
                    <span style="font-weight: 500;">/media/jimmy/youtube</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid var(--google-gray-100);">
                    <span>Plex Server:</span>
                    <span style="font-weight: 500;">192.168.1.17:32400</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid var(--google-gray-100);">
                    <span>Total Subscriptions:</span>
                    <span style="font-weight: 500;">{{ stats.get('total_channels', 0) }}</span>
            </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid var(--google-gray-100);">
                    <span>System Status:</span>
                    <span class="status-indicator status-ready">Operational</span>
            </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding: 8px 0;">
                    <span>Last System Update:</span>
                    <span style="font-weight: 500;">{{ stats.get('last_update', 'Never') }}</span>
            </div>
            </div>
        </div>
        <div class="card-actions">
            <button onclick="testSystemHealth()" class="google-btn">
                <span class="material-icons">health_and_safety</span>
                Test Health
            </button>
        </div>
    </div>

    <!-- Advanced Settings -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <span class="material-icons">build</span>
                Advanced Options
            </h3>
        </div>
        <div class="card-content">
            <div style="color: var(--google-gray-700); font-size: 14px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; font-size: 14px;">
                        <input type="checkbox" checked style="margin-right: 8px;">
                        Enable debug logging
                    </label>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; font-size: 14px;">
                        <input type="checkbox" checked style="margin-right: 8px;">
                        Auto-refresh Plex libraries
                    </label>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; font-size: 14px;">
                        <input type="checkbox" style="margin-right: 8px;">
                        Download video thumbnails
                    </label>
            </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; font-size: 14px;">
                        <input type="checkbox" style="margin-right: 8px;">
                        Download video descriptions
                    </label>
            </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 4px;">
                        Max concurrent downloads:
                    </label>
                    <select style="width: 100%; padding: 8px; border: 1px solid var(--google-gray-300); border-radius: 4px; font-size: 14px;">
                        <option value="1" selected>1 (Recommended)</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
            </div>
            </div>
        </div>
        <div class="card-actions">
            <button onclick="saveAdvancedSettings()" class="google-btn google-btn-primary">
                <span class="material-icons">save</span>
                Save Advanced
            </button>
            
            <button onclick="resetToDefaults()" class="google-btn google-btn-danger">
                <span class="material-icons">restore</span>
                Reset Defaults
            </button>
        </div>
    </div>
</div>

<!-- System Actions -->
<div class="card mt-24">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">build_circle</span>
            System Actions
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-4">
            <button onclick="exportData()" class="google-btn">
                <span class="material-icons">download</span>
                Export Data
            </button>
            
            <button onclick="importSubscriptions()" class="google-btn">
                <span class="material-icons">upload</span>
                Import Subscriptions
            </button>
            
            <button onclick="clearLogs()" class="google-btn google-btn-warning">
                <span class="material-icons">clear_all</span>
                Clear Logs
            </button>
            
            <button onclick="restartSystem()" class="google-btn google-btn-danger">
                <span class="material-icons">restart_alt</span>
                Restart System
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function saveDownloadSettings() {
        const quality = document.querySelector('input[name="quality"]:checked').value;
        const schedule = document.querySelector('select').value;
        
        showNotification('Saving download settings...', 'info');
        
        fetch('/api/save_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'download',
                quality: quality,
                schedule: schedule
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Download settings saved!', 'success');
            } else {
                showNotification(data.message || 'Failed to save settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error saving settings', 'error');
        });
    }
    
    function saveStorageSettings() {
        showNotification('Saving storage settings...', 'info');
        
        const retentionDays = document.querySelector('input[type="number"]').value;
        const protectWatched = document.querySelector('input[type="checkbox"]:nth-of-type(1)').checked;
        const protectFavorites = document.querySelector('input[type="checkbox"]:nth-of-type(2)').checked;
        
        fetch('/api/save_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'storage',
                retention_days: retentionDays,
                protect_watched: protectWatched,
                protect_favorites: protectFavorites
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Storage settings saved!', 'success');
            } else {
                showNotification(data.message || 'Failed to save settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error saving settings', 'error');
        });
    }
    
    function saveAdvancedSettings() {
        showNotification('Saving advanced settings...', 'info');
        
        // Get all advanced settings checkboxes
        const checkboxes = document.querySelectorAll('.card:last-of-type input[type="checkbox"]');
        const settings = {
            debug_logging: checkboxes[0].checked,
            auto_refresh_plex: checkboxes[1].checked,
            download_thumbnails: checkboxes[2].checked,
            download_descriptions: checkboxes[3].checked,
            max_concurrent: document.querySelector('.card:last-of-type select').value
        };
        
        fetch('/api/save_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: 'advanced',
                ...settings
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Advanced settings saved!', 'success');
                    } else {
                showNotification(data.message || 'Failed to save settings', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error saving settings', 'error');
        });
    }
    
    function runCleanupNow() {
        if (confirm('Run storage cleanup now? This will remove videos older than the retention period.')) {
            showNotification('Running storage cleanup...', 'info');
            
            fetch('/api/retention_cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Storage cleanup completed!', 'success');
                } else {
                    showNotification(data.error || 'Cleanup failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error running cleanup', 'error');
            });
        }
    }

    function analyzeStorage() {
        showNotification('Analyzing storage usage...', 'info');
        
        fetch('/api/retention_analyze')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Storage Analysis:\n\n' + data.output);
            } else {
                showNotification(data.error || 'Analysis failed', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error analyzing storage', 'error');
        });
    }
    
    function testSystemHealth() {
        showNotification('Testing system health...', 'info');
        
        fetch('/api/health_check')
        .then(response => response.json())
        .then(data => {
            if (data.healthy) {
                showNotification('System health check passed!', 'success');
            } else {
                showNotification('System health issues detected', 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error testing system health', 'error');
        });
    }

    function resetToDefaults() {
        if (confirm('Reset all settings to defaults? This cannot be undone.')) {
            showNotification('Resetting to default settings...', 'warning');
            
            fetch('/api/reset_settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Settings reset to defaults!', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotification(data.message || 'Reset failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error resetting settings', 'error');
            });
        }
    }
    
    function exportData() {
        showNotification('Exporting system data...', 'info');
        window.open('/api/export_data', '_blank');
    }
    
    function importSubscriptions() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv,.json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                
                showNotification('Importing subscriptions...', 'info');
                
                fetch('/api/import_subscriptions', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Subscriptions imported successfully!', 'success');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showNotification(data.message || 'Import failed', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error importing subscriptions', 'error');
                });
            }
        };
        input.click();
    }
    
    function clearLogs() {
        if (confirm('Clear all system logs? This cannot be undone.')) {
            showNotification('Clearing system logs...', 'warning');
            
            fetch('/api/clear_logs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('System logs cleared!', 'success');
                } else {
                    showNotification(data.message || 'Failed to clear logs', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error clearing logs', 'error');
            });
        }
    }
    
    function restartSystem() {
        if (confirm('Restart the YouTube automation system? This will stop all active downloads.')) {
            showNotification('Restarting system...', 'warning');
            
            fetch('/api/restart_system', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('System restart initiated!', 'success');
                    setTimeout(() => location.reload(), 3000);
                } else {
                    showNotification(data.message || 'Restart failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error restarting system', 'error');
            });
        }
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element (same as other pages)
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--elevation-3);
            max-width: 320px;
            font-size: 14px;
        `;
        
        // Set color based on type
        switch(type) {
            case 'success':
                notification.style.background = 'var(--google-green)';
                break;
            case 'error':
                notification.style.background = 'var(--google-red)';
                break;
            case 'warning':
                notification.style.background = 'var(--google-yellow)';
                notification.style.color = 'var(--google-gray-800)';
                break;
            default:
                notification.style.background = 'var(--google-blue)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
</script>
{% endblock %}