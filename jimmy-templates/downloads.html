{% extends "base.html" %}

{% block title %}Downloads - Jimmy's YouTube System{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <span class="material-icons">download</span>
        Download History
    </h1>
    <p class="page-subtitle">View and manage your downloaded videos</p>
</div>

<!-- Download Statistics -->
<div class="grid grid-cols-4 mb-24">
    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-blue); margin-bottom: 8px;" id="totalDownloads">{{ downloads|length if downloads else 0 }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Total Downloads</div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-green); margin-bottom: 8px;" id="todayDownloads">{{ stats.get('today_downloads', 0) }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Today</div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-yellow); margin-bottom: 8px;" id="weekDownloads">{{ stats.get('week_downloads', 0) }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">This Week</div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-content text-center">
            <div style="font-size: 24px; font-weight: 500; color: var(--google-gray-600); margin-bottom: 8px;" id="avgDaily">{{ stats.get('avg_daily', '0') }}</div>
            <div style="font-size: 14px; color: var(--google-gray-600);">Daily Average</div>
        </div>
    </div>
</div>

<!-- Download Actions -->
<div class="card mb-24">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">bolt</span>
            Quick Actions
        </h2>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-3">
            <button onclick="downloadAll()" class="google-btn google-btn-primary">
                <span class="material-icons">download</span>
                Download All Channels
            </button>
            
            <button onclick="refreshDownloads()" class="google-btn">
                <span class="material-icons">refresh</span>
                Refresh List
            </button>
            
            <button onclick="cleanupOldDownloads()" class="google-btn google-btn-warning">
                <span class="material-icons">cleaning_services</span>
                Cleanup Old Videos
            </button>
        </div>
    </div>
</div>

<!-- Recent Downloads Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">history</span>
            Recent Downloads
        </h2>
    </div>
    <div class="card-content">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <span class="material-icons" style="font-size: 16px;">smart_display</span>
                        </th>
                        <th>Video Title</th>
                        <th>Channel</th>
                        <th>Category</th>
                        <th>Download Date</th>
                        <th>File Size</th>
                        <th>Status</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if downloads %}
                        {% for download in downloads[:50] %}
                        <tr>
                            <td>
                                <span class="material-icons" style="color: var(--google-blue); font-size: 18px;">movie</span>
                            </td>
                            <td style="font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ download.video_title or 'Latest Video' }}
                            </td>
                            <td style="color: var(--google-gray-700);">
                                {{ download.channel_name }}
                            </td>
                            <td>
                                <span class="status-indicator" style="background: var(--google-gray-100); color: var(--google-gray-700);">
                                    {{ download.category or 'General' }}
                                </span>
                            </td>
                            <td style="color: var(--google-gray-600); font-size: 13px;">
                                {{ download.download_date or 'Unknown' }}
                            </td>
                            <td style="color: var(--google-gray-600); font-size: 13px;">
                                {{ download.file_size or '--' }}
                            </td>
                            <td>
                                <span class="status-indicator status-ready">Complete</span>
                            </td>
                            <td>
                                <div class="flex gap-12">
                                    {% if download.file_path %}
                                    <button onclick="playVideo('{{ download.file_path }}')" 
                                            class="google-btn" style="padding: 6px 12px; font-size: 12px;" 
                                            title="Play in Plex">
                                        <span class="material-icons" style="font-size: 14px;">play_arrow</span>
                                    </button>
                                    {% endif %}
                                    
                                    <button onclick="redownload('{{ download.channel_name }}')" 
                                            class="google-btn" style="padding: 6px 12px; font-size: 12px;"
                                            title="Re-download">
                                        <span class="material-icons" style="font-size: 14px;">refresh</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% if downloads|length > 50 %}
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 24px; color: var(--google-gray-500);">
                                <div style="font-size: 14px;">
                                    Showing latest 50 downloads â€¢ {{ downloads|length }} total downloads
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 48px; color: var(--google-gray-500);">
                                <div>
                                    <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block;">download</span>
                                    <div style="font-size: 16px; margin-bottom: 8px;">No downloads yet</div>
                                    <div style="font-size: 14px;">Start downloading videos from your subscriptions</div>
                                    <div style="margin-top: 16px;">
                                        <button onclick="downloadAll()" class="google-btn google-btn-primary">
                                            <span class="material-icons">download</span>
                                            Start Downloading
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Download Progress (if active) -->
<div id="progressCard" class="card" style="display: none;">
    <div class="card-header">
        <h2 class="card-title">
            <span class="material-icons">downloading</span>
            Download Progress
        </h2>
    </div>
    <div class="card-content">
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-title" id="downloadProgressTitle">Processing downloads...</span>
                <span class="progress-percentage" id="downloadProgressPercentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="downloadProgressBar" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="downloadProgressText">Preparing to download...</div>
        </div>
    </div>
    <div class="card-actions">
        <button onclick="cancelDownloads()" class="google-btn google-btn-danger" id="cancelBtn">
            <span class="material-icons">cancel</span>
            Cancel Downloads
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let downloadActive = false;
    
    function downloadAll() {
        if (downloadActive) {
            showNotification('Downloads already in progress', 'warning');
            return;
        }
        
        showNotification('Starting downloads from all channels...', 'info');
        downloadActive = true;
        document.getElementById('progressCard').style.display = 'block';
        
        fetch('/api/start_downloads', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Downloads started successfully!', 'success');
                monitorDownloadProgress();
            } else {
                showNotification(data.message || 'Failed to start downloads', 'error');
                downloadActive = false;
                document.getElementById('progressCard').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error starting downloads', 'error');
            downloadActive = false;
            document.getElementById('progressCard').style.display = 'none';
        });
    }
    
    function refreshDownloads() {
        showNotification('Refreshing download history...', 'info');
        location.reload();
    }
    
    function cleanupOldDownloads() {
        if (confirm('This will remove videos older than 90 days. Continue?')) {
            showNotification('Starting cleanup of old downloads...', 'info');
            
            fetch('/api/retention_cleanup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Cleanup completed successfully!', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotification(data.error || 'Cleanup failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error running cleanup', 'error');
            });
        }
    }
    
    function playVideo(filePath) {
        // Open Plex to play the video
        window.open('http://192.168.1.17:32400', '_blank');
        showNotification('Opening Plex Media Server...', 'info');
    }
    
    function redownload(channelName) {
        if (confirm(`Re-download latest video from ${channelName}?`)) {
            showNotification(`Re-downloading from ${channelName}...`, 'info');
            
            fetch('/api/download_channel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    channel_name: channelName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Re-download started for ${channelName}!`, 'success');
                } else {
                    showNotification(data.message || 'Re-download failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error starting re-download', 'error');
            });
        }
    }
    
    function cancelDownloads() {
        if (confirm('Cancel all active downloads?')) {
            showNotification('Cancelling downloads...', 'warning');
            
            fetch('/api/cancel_downloads', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                showNotification('Downloads cancelled', 'info');
                downloadActive = false;
                document.getElementById('progressCard').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error cancelling downloads', 'error');
            });
        }
    }
    
    function monitorDownloadProgress() {
        if (!downloadActive) return;
        
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const progressBar = document.getElementById('downloadProgressBar');
                const progressPercentage = document.getElementById('downloadProgressPercentage');
                const progressTitle = document.getElementById('downloadProgressTitle');
                const progressText = document.getElementById('downloadProgressText');
                
                if (data.active) {
                    progressBar.style.width = data.progress + '%';
                    progressPercentage.textContent = data.progress + '%';
                    progressTitle.textContent = `Downloading videos... (${data.completed_channels}/${data.total_channels})`;
                    progressText.textContent = `Current: ${data.current_channel}`;
                    
                    // Continue monitoring
                    setTimeout(monitorDownloadProgress, 2000);
                } else {
                    // Downloads completed
                    progressBar.style.width = '100%';
                    progressPercentage.textContent = '100%';
                    progressTitle.textContent = 'Downloads completed!';
                    progressText.textContent = `Completed ${data.completed_channels} downloads`;
                    
                    downloadActive = false;
                    
                    // Hide progress card after a delay
                    setTimeout(() => {
                        document.getElementById('progressCard').style.display = 'none';
                        location.reload(); // Refresh to show new downloads
                    }, 3000);
                }
            })
            .catch(error => {
                console.log('Progress monitoring failed:', error);
                if (downloadActive) {
                    setTimeout(monitorDownloadProgress, 5000);
                }
            });
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element (same as other pages)
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--elevation-3);
            max-width: 320px;
            font-size: 14px;
        `;
        
        // Set color based on type
        switch(type) {
            case 'success':
                notification.style.background = 'var(--google-green)';
                break;
            case 'error':
                notification.style.background = 'var(--google-red)';
                break;
            case 'warning':
                notification.style.background = 'var(--google-yellow)';
                notification.style.color = 'var(--google-gray-800)';
                break;
            default:
                notification.style.background = 'var(--google-blue)';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 4 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    // Check for active downloads on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.active) {
                    downloadActive = true;
                    document.getElementById('progressCard').style.display = 'block';
                    monitorDownloadProgress();
                }
            })
            .catch(error => {
                console.log('Initial status check failed:', error);
            });
    });
</script>
{% endblock %}