name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS DMG
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd taminator/gui
          npm ci
      
      - name: Build macOS DMG (both architectures)
        run: |
          cd taminator/gui
          npm run build -- --mac
      
      - name: List built files
        run: |
          cd taminator/gui
          echo "Contents of dist/:"
          ls -lh dist/ || echo "No dist directory"
          echo "DMG files:"
          find dist/ -name "*.dmg" -exec ls -lh {} \; || echo "No DMG files found"
      
      - name: Upload macOS DMG files
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: taminator/gui/dist/*.dmg
          if-no-files-found: error
  
  build-linux:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd taminator/gui
          npm ci
      
      - name: Build Linux AppImage
        run: |
          cd taminator/gui
          npm run build -- --linux AppImage
      
      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: taminator/gui/dist/*.AppImage
          if-no-files-found: error
  
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd taminator/gui
          npm ci
      
      - name: Build Windows Installer
        run: |
          cd taminator/gui
          npm run build -- --win --x64
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: taminator/gui/dist/*.exe
          if-no-files-found: error
  
  release:
    name: Create GitHub Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Display structure of downloaded files
        run: ls -R
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            macos-dmg/*.dmg
            linux-appimage/*.AppImage
            windows-installer/*.exe
          draft: false
          prerelease: false
          body: |
            # ğŸ’€ Taminator ${{ github.ref_name }}
            
            > *"I'll be back... with your report."* - Taminator T-800
            
            **The Skynet TAMs Actually Wantâ„¢**
            
            ## ğŸ“¥ Downloads
            
            | Platform | Architecture | File | Size |
            |----------|--------------|------|------|
            | ğŸ§ **Linux** | x64 (Intel/AMD) | `Taminator-*.AppImage` | ~122 MB |
            | ğŸ **macOS** | x64 (Intel) | `Taminator-*-x64.dmg` | ~200 MB |
            | ğŸ **macOS** | arm64 (Apple Silicon M1/M2/M3) | `Taminator-*-arm64.dmg` | ~190 MB |
            | ğŸªŸ **Windows** | x64 | `Taminator-Setup-*.exe` | ~150 MB |
            
            ## ğŸš€ Quick Install
            
            ### ğŸ§ Linux
            ```bash
            chmod +x Taminator-*.AppImage
            ./Taminator-*.AppImage
            ```
            
            ### ğŸ macOS
            ```bash
            open Taminator-*.dmg
            # Drag to Applications folder
            ```
            
            ### ğŸªŸ Windows
            Double-click `Taminator-Setup-*.exe` and follow the installer.
            
            ---
            
            **Time Savings:** 383 hours per TAM per year (9.5 work weeks!)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

