---
# GitHub Actions CI/CD for RFE Automation Tool
name: RFE Automation CI/CD

on:
  push:
    branches: [ main, develop, 'rfe-*' ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.9'
  ANSIBLE_VERSION: '8.0.0'
  MOLECULE_VERSION: '5.0.0'

jobs:
  # Lint and validate code quality
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible-lint yamllint molecule[docker] docker
          
      - name: Run yamllint
        run: |
          yamllint .
          
      - name: Run ansible-lint
        run: |
          ansible-lint --version
          ansible-lint .
          
      - name: Validate Ansible syntax
        run: |
          ansible-playbook --syntax-check generate_reports_smart.yml
          ansible-playbook --syntax-check generate_reports_with_vars.yml
          
      - name: Check custom modules syntax
        run: |
          python -m py_compile ansible_collections/redhat/rfe_automation/plugins/modules/rfe_case_collector.py
          python -m py_compile ansible_collections/redhat/rfe_automation/plugins/modules/rfe_data_processor.py
          python -m py_compile ansible_collections/redhat/rfe_automation/plugins/modules/rfe_report_generator.py

  # Test with Molecule
  molecule:
    name: Molecule Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible molecule[docker] docker
          
      - name: Start Docker daemon
        run: |
          sudo systemctl start docker
          sudo docker --version
          
      - name: Run Molecule tests
        run: |
          cd tests/molecule/default
          molecule test
          
      - name: Upload Molecule logs
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: molecule-logs
          path: tests/molecule/default/.molecule/

  # Integration tests
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, molecule]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          
      - name: Create test environment
        run: |
          mkdir -p test_output
          mkdir -p test_logs
          
      - name: Run integration tests (dry-run)
        run: |
          # Test with mock data
          ansible-playbook generate_reports_smart.yml \
            -e "customer=jpmc" \
            -e "report_types=['rfe_bug_tracker']" \
            --check --diff
            
      - name: Validate output structure
        run: |
          # Check that output directories would be created
          test -d test_output || echo "Output directory structure validated"
          
      - name: Test vars file validation
        run: |
          # Validate accounts.yml structure
          python -c "
          import yaml
          with open('vars/accounts.yml', 'r') as f:
              data = yaml.safe_load(f)
          assert 'accounts' in data
          assert 'jpmc' in data['accounts']
          assert 'customer_name' in data['accounts']['jpmc']
          print('Vars file validation passed')
          "

  # Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Bandit security scan
        uses: securecodewarrior/github-action-bandit@v1
        with:
          path: "ansible_collections/redhat/rfe_automation/plugins/modules/"
          
      - name: Check for secrets
        run: |
          # Check for potential secrets in code
          if grep -r -i "password\|secret\|key\|token" --include="*.yml" --include="*.yaml" --include="*.py" . | grep -v "test\|mock\|example"; then
            echo "Potential secrets found in code"
            exit 1
          fi
          echo "No secrets detected"

  # Documentation check
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check README exists
        run: |
          test -f README.md || (echo "README.md missing" && exit 1)
          
      - name: Check documentation completeness
        run: |
          # Check that all modules have documentation
          for module in ansible_collections/redhat/rfe_automation/plugins/modules/*.py; do
            if ! grep -q "DOCUMENTATION" "$module"; then
              echo "Module $module missing documentation"
              exit 1
            fi
          done
          echo "All modules have documentation"
          
      - name: Validate Markdown
        run: |
          # Check README and other markdown files
          if command -v markdownlint >/dev/null 2>&1; then
            markdownlint README.md
          else
            echo "Markdown linting skipped (markdownlint not available)"
          fi

  # Build and package
  build:
    name: Build and Package
    runs-on: ubuntu-latest
    needs: [lint, molecule, integration, security, docs]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core
          
      - name: Build Ansible collection
        run: |
          ansible-galaxy collection build ansible_collections/redhat/rfe_automation/
          
      - name: Upload collection artifact
        uses: actions/upload-artifact@v3
        with:
          name: rfe-automation-collection
          path: redhat-rfe_automation-*.tar.gz
          
      - name: Create release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: redhat-rfe_automation-*.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify on completion
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, molecule, integration, security, docs, build]
    if: always()
    steps:
      - name: Notify success
        if: ${{ needs.lint.result == 'success' && needs.molecule.result == 'success' && needs.integration.result == 'success' && needs.security.result == 'success' && needs.docs.result == 'success' }}
        run: |
          echo "‚úÖ All CI/CD checks passed successfully!"
          echo "üöÄ RFE Automation Tool is ready for deployment"
          
      - name: Notify failure
        if: ${{ needs.lint.result == 'failure' || needs.molecule.result == 'failure' || needs.integration.result == 'failure' || needs.security.result == 'failure' || needs.docs.result == 'failure' }}
        run: |
          echo "‚ùå CI/CD checks failed"
          echo "Please check the logs and fix the issues"
          exit 1
