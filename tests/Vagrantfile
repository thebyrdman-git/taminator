# Vagrantfile for RFE Automation Testing
# Creates vanilla RHEL/Fedora environments for installation testing

Vagrant.configure("2") do |config|
  # Common configuration
  config.vm.synced_folder "../", "/rfe-automation"
  config.vm.provider "libvirt" do |v|
    v.memory = 2048
    v.cpus = 2
  end

  # RHEL 9.5 Test Environment
  config.vm.define "rhel9" do |rhel9|
    rhel9.vm.box = "generic/rhel9"
    rhel9.vm.hostname = "rfe-test-rhel9"
    
    rhel9.vm.provision "shell", inline: <<-SHELL
      echo "üî¥ RHEL 9.5 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Simulate fresh CSB laptop - minimal packages only
      # NO developer tools pre-installed
      
      # Register system (if needed)
      # subscription-manager register --auto-attach
      
      # Update system
      dnf update -y
      
      # Only install absolute minimum
      dnf install -y git curl
      
      echo "‚úÖ Base system ready for testing"
      echo "Run: vagrant ssh rhel9"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # RHEL 8.10 Test Environment (Legacy)
  config.vm.define "rhel8" do |rhel8|
    rhel8.vm.box = "generic/rhel8"
    rhel8.vm.hostname = "rfe-test-rhel8"
    
    rhel8.vm.provision "shell", inline: <<-SHELL
      echo "üî¥ RHEL 8.10 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Only install absolute minimum
      dnf install -y git curl
      
      echo "‚úÖ Base system ready for testing"
      echo "‚ö†Ô∏è  Note: Python 3.6 may need upgrade"
      echo "Run: vagrant ssh rhel8"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Fedora 41 Test Environment
  config.vm.define "fedora41" do |fedora41|
    fedora41.vm.box = "fedora/41-cloud-base"
    fedora41.vm.hostname = "rfe-test-fedora41"
    
    fedora41.vm.provision "shell", inline: <<-SHELL
      echo "üîµ Fedora 41 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Install minimal packages
      dnf install -y git curl
      
      echo "‚úÖ Base system ready for testing"
      echo "Run: vagrant ssh fedora41"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Fedora 40 Test Environment
  config.vm.define "fedora40" do |fedora40|
    fedora40.vm.box = "fedora/40-cloud-base"
    fedora40.vm.hostname = "rfe-test-fedora40"
    
    fedora40.vm.provision "shell", inline: <<-SHELL
      echo "üîµ Fedora 40 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Install minimal packages
      dnf install -y git curl
      
      echo "‚úÖ Base system ready for testing"
      echo "Run: vagrant ssh fedora40"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Alma Linux 9 Test Environment with VPN
  config.vm.define "alma9" do |alma9|
    alma9.vm.box = "almalinux/9"
    alma9.vm.hostname = "rfe-test-alma9"
    
    alma9.vm.provision "shell", inline: <<-SHELL
      echo "üü¶ Alma Linux 9 Test Environment (VPN-Ready)"
      echo "Testing RFE Automation Installation with GitLab Access"
      
      # Update system
      dnf update -y
      
      # Dynamic VPN package installation (detects OS version)
      cat > /tmp/setup-vpn.sh << 'VPNSCRIPT'
#!/bin/bash
set -e
if [ -f /etc/os-release ]; then . /etc/os-release; fi
echo "üì¶ Detected: $NAME $VERSION_ID"

# Determine COPR release name
case "$ID" in
  rhel|almalinux|rocky) COPR_RELEASE="epel-${VERSION_ID%%.*}" ;;
  fedora) COPR_RELEASE="fedora-${VERSION_ID}" ;;
  *) echo "‚ö†Ô∏è  Unsupported OS"; COPR_RELEASE="unsupported" ;;
esac
echo "   COPR release: $COPR_RELEASE"

# Install COPR and enable repo
dnf install -y 'dnf-command(copr)' 2>/dev/null || true
dnf copr enable -y copr.devel.redhat.com/@endpoint-systems-sysadmins/unsupported-fedora-packages || {
  echo "‚ö†Ô∏è  COPR repo not available for $COPR_RELEASE"
  echo "   Attempting standard package installation..."
}

# Install VPN packages (try COPR, fallback to standard repos)
dnf install -y NetworkManager-openvpn openvpn || {
  echo "‚ùå VPN packages not available"
  exit 1
}
echo "‚úÖ VPN packages installed"
VPNSCRIPT
      chmod +x /tmp/setup-vpn.sh
      /tmp/setup-vpn.sh
      
      # Install remaining packages
      dnf install -y \
        git curl jq unzip \
        NetworkManager-openvpn-gnome \
        krb5-workstation \
        ca-certificates
      
      # Trust Red Hat internal certificates
      update-ca-trust
      
      echo "‚úÖ Base system ready with VPN support"
      echo ""
      echo "üìã Next Steps:"
      echo "1. vagrant ssh alma9"
      echo "2. Copy your Red Hat VPN config: scp jbyrd@workstation:/path/to/redhat.ovpn /tmp/"
      echo "3. Import VPN: sudo nmcli connection import type openvpn file /tmp/redhat.ovpn"
      echo "4. Connect VPN: sudo nmcli connection up redhat-vpn"
      echo "5. Test: kinit jbyrd@REDHAT.COM"
      echo "6. Clone: git clone https://gitlab.cee.redhat.com/jbyrd/rfe-and-bug-tracker-automation.git"
      echo "7. Run: cd rfe-and-bug-tracker-automation && ./install.sh"
      echo ""
      echo "‚ö†Ô∏è  VPN connection required for GitLab CEE access"
    SHELL
  end
end


