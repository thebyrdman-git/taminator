# Vagrantfile for RFE Automation Testing
# Creates vanilla RHEL/Fedora environments for installation testing

Vagrant.configure("2") do |config|
  # Common configuration
  config.vm.synced_folder "../", "/rfe-automation"
  config.vm.provider "libvirt" do |v|
    v.memory = 2048
    v.cpus = 2
  end

  # RHEL 9.5 Test Environment
  config.vm.define "rhel9" do |rhel9|
    rhel9.vm.box = "generic/rhel9"
    rhel9.vm.hostname = "rfe-test-rhel9"
    
    rhel9.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”´ RHEL 9.5 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Simulate fresh CSB laptop - minimal packages only
      # NO developer tools pre-installed
      
      # Register system (if needed)
      # subscription-manager register --auto-attach
      
      # Update system
      dnf update -y
      
      # Only install absolute minimum
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "Run: vagrant ssh rhel9"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # RHEL 8.10 Test Environment (Legacy)
  config.vm.define "rhel8" do |rhel8|
    rhel8.vm.box = "generic/rhel8"
    rhel8.vm.hostname = "rfe-test-rhel8"
    
    rhel8.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”´ RHEL 8.10 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Only install absolute minimum
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "âš ï¸  Note: Python 3.6 may need upgrade"
      echo "Run: vagrant ssh rhel8"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Fedora 41 Test Environment
  config.vm.define "fedora41" do |fedora41|
    fedora41.vm.box = "fedora/41-cloud-base"
    fedora41.vm.hostname = "rfe-test-fedora41"
    
    fedora41.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”µ Fedora 41 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Install minimal packages
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "Run: vagrant ssh fedora41"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Fedora 40 Test Environment
  config.vm.define "fedora40" do |fedora40|
    fedora40.vm.box = "fedora/40-cloud-base"
    fedora40.vm.hostname = "rfe-test-fedora40"
    
    fedora40.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”µ Fedora 40 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Install minimal packages
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "Run: vagrant ssh fedora40"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Alma Linux 9 Test Environment with VPN
  config.vm.define "alma9" do |alma9|
    alma9.vm.box = "almalinux/9"
    alma9.vm.hostname = "rfe-test-alma9"
    
    alma9.vm.provision "shell", inline: <<-SHELL
      echo "ðŸŸ¦ Alma Linux 9 Test Environment (VPN-Ready)"
      echo "Testing RFE Automation Installation with GitLab Access"
      
      # Update system
      dnf update -y
      
      # Install COPR plugin and enable VPN packages repo
      dnf install -y 'dnf-command(copr)'
      dnf copr enable -y copr.devel.redhat.com/@endpoint-systems-sysadmins/unsupported-fedora-packages
      
      # Install VPN and development packages
      dnf install -y \
        git curl jq unzip \
        NetworkManager-openvpn \
        NetworkManager-openvpn-gnome \
        openvpn \
        krb5-workstation \
        ca-certificates
      
      # Trust Red Hat internal certificates
      update-ca-trust
      
      echo "âœ… Base system ready with VPN support"
      echo ""
      echo "ðŸ“‹ Next Steps:"
      echo "1. vagrant ssh alma9"
      echo "2. Copy your Red Hat VPN config: scp jbyrd@workstation:/path/to/redhat.ovpn /tmp/"
      echo "3. Import VPN: sudo nmcli connection import type openvpn file /tmp/redhat.ovpn"
      echo "4. Connect VPN: sudo nmcli connection up redhat-vpn"
      echo "5. Test: kinit jbyrd@REDHAT.COM"
      echo "6. Clone: git clone https://gitlab.cee.redhat.com/jbyrd/rfe-and-bug-tracker-automation.git"
      echo "7. Run: cd rfe-and-bug-tracker-automation && ./install.sh"
      echo ""
      echo "âš ï¸  VPN connection required for GitLab CEE access"
    SHELL
  end
end


