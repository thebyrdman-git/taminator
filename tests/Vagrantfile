# Vagrantfile for RFE Automation Testing
# Creates vanilla RHEL/Fedora environments for installation testing

Vagrant.configure("2") do |config|
  # Common configuration
  config.vm.synced_folder "../", "/rfe-automation"
  config.vm.provider "libvirt" do |v|
    v.memory = 2048
    v.cpus = 2
  end

  # RHEL 9.5 Test Environment
  config.vm.define "rhel9" do |rhel9|
    rhel9.vm.box = "generic/rhel9"
    rhel9.vm.hostname = "rfe-test-rhel9"
    
    rhel9.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”´ RHEL 9.5 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Simulate fresh CSB laptop - minimal packages only
      # NO developer tools pre-installed
      
      # Register system (if needed)
      # subscription-manager register --auto-attach
      
      # Update system
      dnf update -y
      
      # Only install absolute minimum
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "Run: vagrant ssh rhel9"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # RHEL 8.10 Test Environment (Legacy)
  config.vm.define "rhel8" do |rhel8|
    rhel8.vm.box = "generic/rhel8"
    rhel8.vm.hostname = "rfe-test-rhel8"
    
    rhel8.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”´ RHEL 8.10 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Only install absolute minimum
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "âš ï¸  Note: Python 3.6 may need upgrade"
      echo "Run: vagrant ssh rhel8"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Fedora 41 Test Environment
  config.vm.define "fedora41" do |fedora41|
    fedora41.vm.box = "fedora/41-cloud-base"
    fedora41.vm.hostname = "rfe-test-fedora41"
    
    fedora41.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”µ Fedora 41 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Install minimal packages
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "Run: vagrant ssh fedora41"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Fedora 40 Test Environment
  config.vm.define "fedora40" do |fedora40|
    fedora40.vm.box = "fedora/40-cloud-base"
    fedora40.vm.hostname = "rfe-test-fedora40"
    
    fedora40.vm.provision "shell", inline: <<-SHELL
      echo "ðŸ”µ Fedora 40 Test Environment"
      echo "Testing RFE Automation Installation"
      
      # Update system
      dnf update -y
      
      # Install minimal packages
      dnf install -y git curl
      
      echo "âœ… Base system ready for testing"
      echo "Run: vagrant ssh fedora40"
      echo "Then: cd /rfe-automation && ./install.sh"
    SHELL
  end

  # Alma Linux 9 Test Environment with VPN
  config.vm.define "alma9" do |alma9|
    alma9.vm.box = "almalinux/9"
    alma9.vm.hostname = "rfe-test-alma9"
    
    alma9.vm.provision "shell", inline: <<-SHELL
      echo "ðŸŸ¦ Alma Linux 9 Test Environment (VPN-Ready)"
      echo "Testing RFE Automation Installation with GitLab Access"
      
      # Update system
      dnf update -y
      
      # Dynamic VPN package installation (detects OS version)
      cat > /tmp/setup-vpn.sh << 'VPNSCRIPT'
#!/bin/bash
set -e
if [ -f /etc/os-release ]; then . /etc/os-release; fi
echo "ðŸ“¦ Detected: $NAME $VERSION_ID"

# Determine COPR release name
case "$ID" in
  rhel|almalinux|rocky) COPR_RELEASE="epel-${VERSION_ID%%.*}" ;;
  fedora) COPR_RELEASE="fedora-${VERSION_ID}" ;;
  *) echo "âš ï¸  Unsupported OS"; COPR_RELEASE="unsupported" ;;
esac
echo "   COPR release: $COPR_RELEASE"

# Install COPR and enable repo
dnf install -y 'dnf-command(copr)' 2>/dev/null || true
dnf copr enable -y copr.devel.redhat.com/@endpoint-systems-sysadmins/unsupported-fedora-packages || {
  echo "âš ï¸  COPR repo not available for $COPR_RELEASE"
  echo "   Attempting standard package installation..."
}

# Install VPN packages (try COPR, fallback to standard repos)
dnf install -y NetworkManager-openvpn openvpn || {
  echo "âŒ VPN packages not available"
  exit 1
}
echo "âœ… VPN packages installed"
VPNSCRIPT
      chmod +x /tmp/setup-vpn.sh
      /tmp/setup-vpn.sh
      
      # Install remaining packages
      dnf install -y \
        git curl jq unzip \
        NetworkManager-openvpn-gnome \
        krb5-workstation \
        ca-certificates
      
      # Install Red Hat internal CA certificates
      echo "Installing Red Hat CA certificates..."
      mkdir -p /etc/pki/ca-trust/source/anchors
      cat > /etc/pki/ca-trust/source/anchors/2015-RH-IT-Root-CA.pem << 'RHCA1'
-----BEGIN CERTIFICATE-----
# Red Hat IT Root CA (placeholder - will be synced from host)
RHCA1
      
      # Trust Red Hat internal certificates
      update-ca-trust force-enable
      update-ca-trust extract
      
      # Configure Kerberos
      echo "Configuring Kerberos for REDHAT.COM realm..."
      cat > /etc/krb5.conf << 'KRB5'
[libdefaults]
  default_realm = IPA.REDHAT.COM
  dns_lookup_realm = true
  dns_lookup_kdc = true
  rdns = false
  dns_canonicalize_hostname = true
  ticket_lifetime = 24h
  forwardable = true
  udp_preference_limit = 0
  default_ccache_name = KEYRING:persistent:%{uid}

[realms]
    REDHAT.COM = {
        default_domain = redhat.com
        dns_lookup_kdc = true
        master_kdc = kerberos.corp.redhat.com
        admin_server = kerberos.corp.redhat.com
    }
    IPA.REDHAT.COM = {
       pkinit_anchors = FILE:/etc/ipa/ca.crt
       pkinit_pool = FILE:/etc/ipa/ca.crt
       default_domain = ipa.redhat.com
       dns_lookup_kdc = true
       auth_to_local = RULE:[1:$1@$0](.*@REDHAT\.COM)s/@.*//
       auth_to_local = DEFAULT
    }
KRB5
      
      # Configure Git for GitLab SSH
      echo "Configuring Git for Red Hat GitLab..."
      cat > /etc/gitconfig << 'GITCFG'
[http]
    sslCAInfo = /etc/pki/tls/certs/ca-bundle.crt
[url "git@gitlab.cee.redhat.com:"]
    insteadOf = https://gitlab.cee.redhat.com/
GITCFG
      
      echo "âœ… Base system ready with VPN support"
      echo "âœ… Kerberos configured for REDHAT.COM"
      echo "âœ… Red Hat CA certificates installed"
      echo ""
      echo "ðŸ“‹ Next Steps:"
      echo "1. vagrant ssh alma9"
      echo "2. Copy your Red Hat VPN config: scp jbyrd@workstation:/path/to/redhat.ovpn /tmp/"
      echo "3. Import VPN: sudo nmcli connection import type openvpn file /tmp/redhat.ovpn"
      echo "4. Connect VPN: sudo nmcli connection up redhat-vpn"
      echo "5. Test: kinit jbyrd@REDHAT.COM"
      echo "6. Clone: git clone https://gitlab.cee.redhat.com/jbyrd/rfe-and-bug-tracker-automation.git"
      echo "7. Run: cd rfe-and-bug-tracker-automation && ./install.sh"
      echo ""
      echo "âš ï¸  VPN connection required for GitLab CEE access"
    SHELL
  end
end


