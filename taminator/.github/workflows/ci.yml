name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8 pylint
          
      - name: Lint with flake8
        run: |
          # Stop on critical errors
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Warn on everything else
          flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

  test-gui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json
          
      - name: Install dependencies
        working-directory: gui
        run: npm ci
        
      - name: Validate package.json
        working-directory: gui
        run: |
          node -e "const pkg = require('./package.json'); console.log('Version:', pkg.version); console.log('Name:', pkg.name);"

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run security scan
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -r "rh_jwt.*=" --include="*.py" --include="*.js" src/ gui/ 2>/dev/null | grep -v "# Example" | grep -v "placeholder" | grep -v "cookie"; then
            echo "❌ Found hardcoded tokens!"
            exit 1
          fi
          echo "✅ No hardcoded secrets found"
          
      - name: Check for sensitive patterns
        run: |
          echo "Checking for sensitive data patterns..."
          # Check for actual credentials, not references in examples
          if grep -r "password.*=" --include="*.py" --include="*.js" src/ gui/ 2>/dev/null | grep -v "Example" | grep -v "password_field" | grep -v "password_label"; then
            echo "⚠️  Warning: Potential hardcoded credentials found"
          else
            echo "✅ No hardcoded credentials found"
          fi

