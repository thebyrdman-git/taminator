#!/bin/bash

# TAM RFE Monitor - Simple Version
# Professional RFE Automation with Monitoring

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
ULTIMATE_SYSTEM="$PROJECT_ROOT/src/ultimate_rfe_portal_system.py"

# Logging
LOG_FILE="/tmp/tam-rfe-monitor-$(date +%Y%m%d-%H%M%S).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2> >(tee -a "$LOG_FILE" >&2)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Functions
print_header() {
    echo -e "${CYAN}"
    echo "ðŸ›¡ï¸  TAM RFE MONITOR - Professional RFE Automation"
    echo "================================================="
    echo -e "${NC}"
    echo "ðŸ“… Started: $(date)"
    echo "ðŸ“ Log File: $LOG_FILE"
    echo "ðŸ“§ Admin Email: jbyrd@redhat.com"
    echo ""
}

print_section() {
    echo -e "${BLUE}$1${NC}"
    echo "$(echo "$1" | sed 's/./=/g')"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo -e "${PURPLE}ðŸ’¡ $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Customer validation
validate_customer() {
    local customer="$1"
    case "$customer" in
        wellsfargo|tdbank|jpmc|fanniemae)
            print_success "Customer validated: $customer"
            return 0
            ;;
        *)
            print_error "Invalid customer: $customer"
            echo "Valid customers: wellsfargo, tdbank, jpmc, fanniemae"
            return 1
            ;;
    esac
}

# Show help
show_help() {
    print_header
    echo "TAM RFE Monitor - Professional RFE Automation with Monitoring"
    echo ""
    echo "Usage: tam-rfe-monitor [CUSTOMER] [OPTIONS]"
    echo ""
    echo "Customers:"
    echo "  wellsfargo    Run Wells Fargo RFE automation with monitoring"
    echo "  tdbank        Run TD Bank RFE automation with monitoring"
    echo "  jpmc          Run JPMC RFE automation with monitoring"
    echo "  fanniemae     Run Fannie Mae RFE automation with monitoring"
    echo ""
    echo "Options:"
    echo "  --test        Test mode (content generation only, no portal posting)"
    echo "  --daily       Daily mode (full automation with portal posting)"
    echo "  --all-daily   Run daily automation for all ready customers"
    echo "  --help        Show this help message"
    echo ""
    echo "Examples:"
    echo "  tam-rfe-monitor wellsfargo --daily     # Full Wells Fargo automation"
    echo "  tam-rfe-monitor tdbank --test          # Test TD Bank (no posting)"
    echo "  tam-rfe-monitor --all-daily            # All customers daily"
    echo ""
    echo "Features:"
    echo "  ðŸ“§ Email alerts to jbyrd@redhat.com on failures"
    echo "  â±ï¸  Execution time monitoring and timeout detection"
    echo "  ðŸ“Š Daily summary reports"
    echo "  ðŸ›¡ï¸  Comprehensive error handling and logging"
}

# Main execution
main() {
    print_header
    
    # Parse arguments
    if [[ $# -eq 0 ]]; then
        show_help
        exit 1
    fi
    
    local customer=""
    local mode=""
    local test_flag=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help
                exit 0
                ;;
            --test)
                mode="test"
                test_flag="--test"
                shift
                ;;
            --daily)
                mode="daily"
                test_flag=""
                shift
                ;;
            --all-daily)
                mode="all-daily"
                test_flag=""
                shift
                ;;
            --all)
                mode="all"
                test_flag=""
                shift
                ;;
            wellsfargo|tdbank|jpmc|fanniemae)
                customer="$1"
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    # Handle all-daily mode
    if [[ "$mode" == "all-daily" || "$mode" == "all" ]]; then
        print_section "ðŸ”„ RUNNING ALL CUSTOMERS DAILY AUTOMATION"
        local customers=("wellsfargo" "tdbank" "jpmc" "fanniemae")
        local success_count=0
        local total_count=${#customers[@]}
        
        for cust in "${customers[@]}"; do
            print_section "ðŸ” MONITORING RFE EXECUTION: $cust"
            if validate_customer "$cust"; then
                print_info "Running daily automation for $cust..."
                if python3 "$ULTIMATE_SYSTEM" "$cust"; then
                    print_success "$cust automation completed successfully"
                    ((success_count++))
                else
                    print_error "$cust automation failed"
                fi
            fi
            echo ""
        done
        
        print_section "ðŸ“Š DAILY AUTOMATION SUMMARY"
        print_success "Completed: $success_count/$total_count customers"
        if [[ $success_count -eq $total_count ]]; then
            print_success "All customers processed successfully!"
        else
            print_warning "Some customers failed - check logs for details"
        fi
        exit 0
    fi
    
    # Validate customer
    if [[ -z "$customer" ]]; then
        print_error "Customer not specified"
        show_help
        exit 1
    fi
    
    if ! validate_customer "$customer"; then
        exit 1
    fi
    
    # Set default mode
    if [[ -z "$mode" ]]; then
        mode="test"
        test_flag="--test"
        print_info "No mode specified, defaulting to test mode"
    fi
    
    # Execute monitoring
    print_section "ðŸ” MONITORING RFE EXECUTION: $customer"
    
    if [[ "$mode" == "test" ]]; then
        print_info "Running in TEST mode (no portal posting)"
    else
        print_info "Running in DAILY mode (full automation with portal posting)"
    fi
    
    print_info "Executing: python3 $ULTIMATE_SYSTEM $customer $test_flag"
    
    # Execute with timeout and error handling
    local start_time=$(date +%s)
    local timeout_seconds=300  # 5 minutes
    
    if timeout "$timeout_seconds" python3 "$ULTIMATE_SYSTEM" "$customer" $test_flag; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        print_success "$customer automation completed successfully in ${duration}s"
        
        # Check for results
        local results_dir="/tmp/rfe-automation-results"
        if [[ -d "$results_dir" ]]; then
            local result_file="$results_dir/rfe-$customer-$(date +%Y%m%d)*.json"
            if ls $result_file 1> /dev/null 2>&1; then
                print_success "Results saved to: $result_file"
            fi
        fi
    else
        local exit_code=$?
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        
        if [[ $exit_code -eq 124 ]]; then
            print_error "$customer automation timed out after ${duration}s"
        else
            print_error "$customer automation failed after ${duration}s (exit code: $exit_code)"
        fi
        
        print_info "Check log file for details: $LOG_FILE"
        exit 1
    fi
}

# Run main function
main "$@"
