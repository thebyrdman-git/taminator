{% extends "base.html" %}

{% block title %}üì∫ Subscriptions - Charles's YouTube System{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold mb-2">üì∫ YouTube Subscriptions</h1>
            <p class="text-xl opacity-90">Managing 249 channels for Charles</p>
        </div>
        <div class="space-x-3">
            <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg font-medium transition-colors">
                üîÑ Refresh
            </button>
            <button onclick="exportData()" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-medium transition-colors">
                üìã Export CSV
            </button>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="glass rounded-xl p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">üîç Search Channels</label>
                <input type="text" id="searchInput" placeholder="Search by name..." 
                    class="w-full px-3 py-2 bg-black/30 border border-white/20 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">üìä Status Filter</label>
                <select id="statusFilter" class="w-full px-3 py-2 bg-black/30 border border-white/20 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="completed">‚úÖ Completed</option>
                    <option value="downloading">‚¨áÔ∏è Downloading</option>
                    <option value="pending">‚è≥ Pending</option>
                    <option value="error">‚ùå Error</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">üìà Sort By</label>
                <select id="sortSelect" class="w-full px-3 py-2 bg-black/30 border border-white/20 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="name">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="videos">Video Count</option>
                    <option value="size">Total Size</option>
                    <option value="date">Last Download</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">üìÑ Per Page</label>
                <select id="perPageSelect" class="w-full px-3 py-2 bg-black/30 border border-white/20 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="249">All</option>
                </select>
            </div>
            
            <div class="flex items-end">
                <button onclick="resetFilters()" class="w-full bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                    üîÑ Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="glass rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-300" id="completedCount">-</div>
            <div class="text-sm opacity-80">‚úÖ Completed</div>
        </div>
        <div class="glass rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-300" id="downloadingCount">-</div>
            <div class="text-sm opacity-80">‚¨áÔ∏è Downloading</div>
        </div>
        <div class="glass rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-yellow-300" id="pendingCount">-</div>
            <div class="text-sm opacity-80">‚è≥ Pending</div>
        </div>
        <div class="glass rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-red-300" id="errorCount">-</div>
            <div class="text-sm opacity-80">‚ùå Errors</div>
        </div>
        <div class="glass rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-purple-300" id="totalVideos">-</div>
            <div class="text-sm opacity-80">üì∫ Total Videos</div>
        </div>
    </div>

    <!-- Channels Table -->
    <div class="glass rounded-xl overflow-hidden">
        <div class="p-6 border-b border-white/20">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">üìã Channels List</h2>
                <div class="text-sm opacity-80" id="resultsInfo">
                    Showing - of - channels
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-black/20">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer hover:text-white" onclick="sortBy('name')">
                            Channel Name ‚ÜïÔ∏è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer hover:text-white" onclick="sortBy('videos')">
                            Videos ‚ÜïÔ∏è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer hover:text-white" onclick="sortBy('size')">
                            Size ‚ÜïÔ∏è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider cursor-pointer hover:text-white" onclick="sortBy('date')">
                            Last Download ‚ÜïÔ∏è
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="channelsTableBody" class="divide-y divide-white/10">
                    <!-- Table rows will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="p-8 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-4"></div>
            <div class="text-gray-400">Loading channels...</div>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="p-8 text-center hidden">
            <div class="text-6xl mb-4">üì∫</div>
            <div class="text-xl font-semibold mb-2">No channels found</div>
            <div class="text-gray-400">Try adjusting your search or filter criteria</div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center">
        <nav class="glass rounded-lg px-6 py-3">
            <div class="flex items-center space-x-4">
                <button id="prevButton" onclick="previousPage()" disabled
                    class="px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-white/10 transition-colors">
                    ‚Üê Previous
                </button>
                
                <div id="pageInfo" class="text-sm font-medium">
                    Page 1 of 1
                </div>
                
                <button id="nextButton" onclick="nextPage()" disabled
                    class="px-3 py-2 rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-white/10 transition-colors">
                    Next ‚Üí
                </button>
            </div>
        </nav>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allChannels = [];
    let filteredChannels = [];
    let currentPage = 1;
    let channelsPerPage = 50;
    let currentSort = { field: 'name', direction: 'asc' };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        refreshData();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', debounce(filterChannels, 300));
        document.getElementById('statusFilter').addEventListener('change', filterChannels);
        document.getElementById('sortSelect').addEventListener('change', handleSortSelect);
        document.getElementById('perPageSelect').addEventListener('change', handlePerPageChange);
    }

    async function refreshData() {
        try {
            showLoadingState();
            const response = await apiCall('/api/channels');
            if (response) {
                allChannels = response;
                filterChannels();
            }
        } catch (error) {
            console.error('Failed to refresh data:', error);
            showEmptyState('Failed to load channels');
        }
    }

    function filterChannels() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        
        filteredChannels = allChannels.filter(channel => {
            const matchesSearch = !searchTerm || channel.name.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || channel.status === statusFilter;
            return matchesSearch && matchesStatus;
        });

        // Apply sorting
        applySorting();
        
        // Reset to first page
        currentPage = 1;
        
        // Update display
        updateStatsDisplay();
        updateTableDisplay();
        updatePagination();
    }

    function applySorting() {
        const { field, direction } = currentSort;
        
        filteredChannels.sort((a, b) => {
            let aValue, bValue;
            
            switch (field) {
                case 'name':
                    aValue = a.name.toLowerCase();
                    bValue = b.name.toLowerCase();
                    break;
                case 'videos':
                    aValue = a.video_count || 0;
                    bValue = b.video_count || 0;
                    break;
                case 'size':
                    aValue = a.total_size || 0;
                    bValue = b.total_size || 0;
                    break;
                case 'date':
                    aValue = new Date(a.last_download || 0);
                    bValue = new Date(b.last_download || 0);
                    break;
                default:
                    return 0;
            }
            
            if (aValue < bValue) return direction === 'asc' ? -1 : 1;
            if (aValue > bValue) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateStatsDisplay() {
        const stats = {
            completed: 0,
            downloading: 0,
            pending: 0,
            error: 0,
            totalVideos: 0
        };

        filteredChannels.forEach(channel => {
            stats[channel.status] = (stats[channel.status] || 0) + 1;
            stats.totalVideos += channel.video_count || 0;
        });

        document.getElementById('completedCount').textContent = stats.completed;
        document.getElementById('downloadingCount').textContent = stats.downloading;
        document.getElementById('pendingCount').textContent = stats.pending;
        document.getElementById('errorCount').textContent = stats.error;
        document.getElementById('totalVideos').textContent = stats.totalVideos;
    }

    function updateTableDisplay() {
        const tableBody = document.getElementById('channelsTableBody');
        const startIndex = (currentPage - 1) * channelsPerPage;
        const endIndex = startIndex + channelsPerPage;
        const pageChannels = filteredChannels.slice(startIndex, endIndex);

        if (pageChannels.length === 0) {
            showEmptyState();
            return;
        }

        hideLoadingState();
        hideEmptyState();

        tableBody.innerHTML = pageChannels.map(channel => {
            const statusInfo = getStatusInfo(channel.status);
            const lastDownload = channel.last_download ? formatDate(channel.last_download) : 'Never';
            
            return `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusInfo.class}">
                            ${statusInfo.icon} ${statusInfo.text}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium">${channel.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${channel.video_count || 0} videos
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${formatBytes(channel.total_size || 0)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        ${lastDownload}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                        <button onclick="downloadChannel('${channel.name}')" 
                            class="text-blue-300 hover:text-blue-100 ${channel.status === 'downloading' ? 'opacity-50 cursor-not-allowed' : ''}">
                            ‚¨áÔ∏è Download
                        </button>
                        <button onclick="viewChannel('${channel.name}')" class="text-green-300 hover:text-green-100">
                            üëÅÔ∏è View
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // Update results info
        document.getElementById('resultsInfo').textContent = 
            `Showing ${startIndex + 1}-${Math.min(endIndex, filteredChannels.length)} of ${filteredChannels.length} channels`;
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredChannels.length / channelsPerPage);
        
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevButton').disabled = currentPage <= 1;
        document.getElementById('nextButton').disabled = currentPage >= totalPages;
    }

    function getStatusInfo(status) {
        const statusMap = {
            'completed': { icon: '‚úÖ', text: 'Completed', class: 'bg-green-900 text-green-300' },
            'downloading': { icon: '‚¨áÔ∏è', text: 'Downloading', class: 'bg-blue-900 text-blue-300' },
            'pending': { icon: '‚è≥', text: 'Pending', class: 'bg-yellow-900 text-yellow-300' },
            'error': { icon: '‚ùå', text: 'Error', class: 'bg-red-900 text-red-300' }
        };
        return statusMap[status] || { icon: '‚ùì', text: 'Unknown', class: 'bg-gray-900 text-gray-300' };
    }

    // Event Handlers
    function sortBy(field) {
        if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.field = field;
            currentSort.direction = 'asc';
        }
        filterChannels();
    }

    function handleSortSelect() {
        const value = document.getElementById('sortSelect').value;
        const [field, direction] = value.includes('_desc') ? [value.replace('_desc', ''), 'desc'] : [value, 'asc'];
        currentSort = { field, direction };
        filterChannels();
    }

    function handlePerPageChange() {
        channelsPerPage = parseInt(document.getElementById('perPageSelect').value);
        currentPage = 1;
        updateTableDisplay();
        updatePagination();
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('sortSelect').value = 'name';
        document.getElementById('perPageSelect').value = '50';
        currentSort = { field: 'name', direction: 'asc' };
        channelsPerPage = 50;
        filterChannels();
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTableDisplay();
            updatePagination();
        }
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredChannels.length / channelsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTableDisplay();
            updatePagination();
        }
    }

    function downloadChannel(channelName) {
        showToast(`Starting download for ${channelName}...`, 'info');
        // TODO: Implement individual channel download API
    }

    function viewChannel(channelName) {
        showToast(`Viewing details for ${channelName}...`, 'info');
        // TODO: Implement channel details modal or page
    }

    function exportData() {
        const csv = generateCSV(filteredChannels);
        downloadCSV(csv, 'youtube-channels.csv');
        showToast('CSV exported successfully!', 'success');
    }

    function generateCSV(data) {
        const headers = ['Channel Name', 'Status', 'Video Count', 'Total Size', 'Last Download'];
        const rows = data.map(channel => [
            channel.name,
            channel.status,
            channel.video_count || 0,
            channel.total_size || 0,
            channel.last_download || ''
        ]);
        
        return [headers, ...rows]
            .map(row => row.map(cell => `"${cell}"`).join(','))
            .join('\n');
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', filename);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Utility Functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function showLoadingState() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
    }

    function hideLoadingState() {
        document.getElementById('loadingState').classList.add('hidden');
    }

    function showEmptyState(message = 'No channels found') {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('emptyState').querySelector('.text-xl').textContent = message;
    }

    function hideEmptyState() {
        document.getElementById('emptyState').classList.add('hidden');
    }
</script>
{% endblock %}
